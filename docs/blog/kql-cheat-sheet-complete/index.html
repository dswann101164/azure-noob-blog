<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  

  <!-- Primary SEO -->
  <title>KQL Cheat Sheet: 51 Azure Resource Graph Queries ¬∑ Azure Noob</title>
  <meta name="description" content="Complete KQL reference for Azure admins: 51 production-tested queries for VM inventory, cost analysis, security audits, and compliance reporting. Includes...">
  
  <link rel="canonical" href="https://azure-noob.com/blog/kql-cheat-sheet-complete" />

  <!-- Favicons -->
  <link rel="icon" href="/static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="KQL Cheat Sheet: 51 Azure Resource Graph Queries">
  <meta property="og:description" content="Complete KQL reference for Azure admins: 51 production-tested queries for VM inventory, cost analysis, security audits, and compliance reporting. Includes...">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://azure-noob.com/blog/kql-cheat-sheet-complete">
  <meta property="og:image" content="https://azure-noob.com/static/images/hero/kql-cheat-sheet.png">

  
    <meta property="article:published_time" content="2025-01-15T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-12T00:00:00+00:00">
    <meta property="article:author" content="David Swann">
    
      
        <meta property="article:tag" content="Azure">
      
        <meta property="article:tag" content="Cheat Sheet">
      
        <meta property="article:tag" content="KQL">
      
        <meta property="article:tag" content="Log Analytics">
      
        <meta property="article:tag" content="Query Language">
      
        <meta property="article:tag" content="Resource Graph">
      
        <meta property="article:tag" content="Sentinel">
      
    
  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="KQL Cheat Sheet: 51 Azure Resource Graph Queries">
  <meta name="twitter:description" content="Complete KQL reference for Azure admins: 51 production-tested queries for VM inventory, cost analysis, security audits, and compliance reporting. Includes...">
  <meta name="twitter:image" content="https://azure-noob.com/static/images/hero/kql-cheat-sheet.png">

  <!-- Styles -->
  <link rel="stylesheet" href="/static/styles.css">

  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="Azure Noob RSS Feed" href="https://azure-noob.com/rss.xml">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="/" class="brand-link">
          <img src="/static/images/logo.png" alt="Azure Noob logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong>Azure Noob</strong>
        </span>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/blog/">Blog</a>
        <a href="/hubs/" style="font-weight: 700;">Content Hubs</a>
        <a href="/start-here">Start Here</a>
        <a href="/blog/starter-kit/">Starter Kit</a>
        <a href="/about">About</a>
        <a href="/tags/">Tags</a>
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
        <a href="/search">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KQL Cheat Sheet: 51 Azure Resource Graph Queries",
  "description": "Complete KQL reference for Azure admins: 51 production-tested queries for VM inventory, cost analysis, security audits, and compliance reporting. Includes...",
  "image": {
    "@type": "ImageObject",
    "url": "https://azure-noob.com/static/images/hero/kql-cheat-sheet.png",
    "width": 1200,
    "height": 630
  },
  "author": {
    "@type": "Person",
    "name": "David Swann",
    "url": "https://azure-noob.com/about/",
    "description": "Azure Architect specializing in enterprise cloud infrastructure",
    "jobTitle": "Azure Architect",
    "worksFor": {
      "@type": "Organization",
      "name": "Synovus"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Azure Noob",
    "url": "https://azure-noob.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://azure-noob.com/static/images/logo.png"
    }
  },
  "datePublished": "2025-01-15T00:00:00+00:00",
  "dateModified": "2025-12-12T00:00:00+00:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://azure-noob.com/blog/kql-cheat-sheet-complete"
  },
  "keywords": "Azure, Cheat Sheet, KQL, Log Analytics, Query Language, Resource Graph, Sentinel",
  "articleSection": "Azure",
  "wordCount": "7739",
  "timeRequired": "PT39M",
  "inLanguage": "en-US",
  "isAccessibleForFree": "True",
  "about": {
    "@type": "Thing",
    "name": "Azure"
  }
}
</script>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://azure-noob.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://azure-noob.com/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "KQL Cheat Sheet: 51 Azure Resource Graph Queries",
      "item": "https://azure-noob.com/blog/kql-cheat-sheet-complete"
    }
  ]
}
</script>




<article class="post">

  
  
    
    <div class="hero">
      <img src="/static/images/hero/kql-cheat-sheet.png" alt="KQL Cheat Sheet: 51 Azure Resource Graph Queries" loading="eager">
    </div>
  

  <header class="post-header">
    <h1>KQL Cheat Sheet: 51 Azure Resource Graph Queries</h1>
    <p class="muted">
      2025-01-15 ¬∑ ~39 min read
      
        ¬∑ Updated 2025-12-12
      
    </p>
    
    
    <ul class="tags-list">
      
      <li><a href="/tags/Azure" class="tag-badge">Azure</a></li>
      
      <li><a href="/tags/Cheat%20Sheet" class="tag-badge">Cheat Sheet</a></li>
      
      <li><a href="/tags/KQL" class="tag-badge">KQL</a></li>
      
      <li><a href="/tags/Log%20Analytics" class="tag-badge">Log Analytics</a></li>
      
      <li><a href="/tags/Query%20Language" class="tag-badge">Query Language</a></li>
      
      <li><a href="/tags/Resource%20Graph" class="tag-badge">Resource Graph</a></li>
      
      <li><a href="/tags/Sentinel" class="tag-badge">Sentinel</a></li>
      
    </ul>
    
    
    
      <p class="summary">Complete KQL reference for Azure admins: 51 production-tested queries for VM inventory, cost analysis, security audits, and compliance reporting. Includes joins, operators, performance tips, and Resource Graph examples. Free PDF download with syntax highlighting.</p>
    
  </header>

  
  <p class="post-actions" style="margin:.5rem 0 0; text-align: center;">
    <button class="btn"
            onclick="window.print(); return false;"
            title="Print this page"
            aria-label="Print this page"
            style="cursor: pointer; background: none; border: 2px solid var(--azure-blue);">
      üñ®Ô∏è Print this page
    </button>
  </p>

  
  <div class="post-body">
    <h1>KQL Cheat Sheet for Azure Admins: Azure Resource Graph (VMs, NICs, Disks)</h1>
<p>This guide is part of our <a href="/hub/governance/">Azure Governance hub</a> covering policy enforcement, compliance frameworks, and enterprise controls.</p>
<blockquote>
<p><strong>Note:</strong> No Azure certification teaches KQL for operational queries. The AZ-104 exam shows you two sample queries. That's it. No Resource Graph training. No joins. No performance optimization. Nothing about the queries you'll actually write daily.</p>
<p>I wrote about this gap: <a href="/blog/azure-reporting-role-microsoft-should-create/">The Azure Role Microsoft Forgot to Certify</a>. Until Microsoft fixes this, here's the KQL guide you need.</p>
</blockquote>
<hr />
<p>This Kusto Query Language (KQL) cheat sheet is designed for Azure administrators new to KQL, focusing on querying Azure resources like virtual machines (VMs), network interface cards (NICs), managed disks, and subscriptions using Azure Resource Graph in the Azure Portal (Resource Graph Explorer). </p>
<p>Use this to inventory resources, check configurations, or troubleshoot VM-related issues. For more details, see the <a href="https://docs.microsoft.com/en-us/azure/data-explorer/kql-quick-reference">KQL quick reference</a> and <a href="https://docs.microsoft.com/en-us/azure/governance/resource-graph/">Resource Graph query docs</a>.</p>
<h2>Getting Started</h2>
<p><strong>Where to Run:</strong> Azure Portal &gt; Resource Graph Explorer (search "resource-graph" in the portal).</p>
<p><strong>Key Tables:</strong><br />
- <code>Resources</code>: Contains all Azure resources (VMs, NICs, disks, etc.)<br />
- <code>ResourceContainers</code>: Contains subscriptions and resource groups</p>
<p><strong>Basic Query Structure:</strong> Start with <code>Resources</code> or <code>ResourceContainers</code>, pipe (<code>|</code>) to operators like <code>where</code>, <code>join</code>, or <code>project</code>.</p>
<p><strong>Case Sensitivity:</strong> Operators are case-insensitive; string comparisons (e.g., <code>has</code>) are case-sensitive unless using <code>_cs</code> (e.g., <code>has_cs</code>).</p>
<p><strong>Resource Graph Notes:</strong> Queries resource metadata (not logs or metrics). No <code>TimeGenerated</code> field, unlike Log Analytics.</p>
<h2>Quick Start: Your First 3 Queries</h2>
<p><strong>1. List all your VMs:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<p><strong>2. Find VMs in a specific resource group:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span><span class="w">  </span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">resourceGroup</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;MyResourceGroup&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">location</span>
</code></pre></div>

<p><strong>3. Show VM count by location:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span><span class="w"> </span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">location</span>
</code></pre></div>

<h2>Core KQL Concepts</h2>
<p><strong>Tables = Your Data Sources</strong><br />
- Think of tables like Excel sheets - each contains different types of data<br />
- <code>Resources</code> = all your Azure resources<br />
- <code>ResourceContainers</code> = subscriptions and resource groups</p>
<p><strong>Where = Your Filter</strong><br />
- Like Excel filters - narrows down your data<br />
- Always filter early for better performance</p>
<p><strong>Project = Your Columns</strong><br />
- Selects which columns to display<br />
- Keeps output clean and focused</p>
<h2>Querying Resources</h2>
<p>Use <code>Resources</code> to list VMs, NICs, disks, or other resources.</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>List VMs</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines"</code></td>
<td>All VMs across subscriptions</td>
</tr>
<tr>
<td>List NICs</td>
<td><code>Resources \| where type == "microsoft.network/networkinterfaces"</code></td>
<td>All network interfaces</td>
</tr>
<tr>
<td>List Disks</td>
<td><code>Resources \| where type == "microsoft.compute/disks"</code></td>
<td>All managed disks</td>
</tr>
<tr>
<td>Filter by Resource Group</td>
<td><code>Resources \| where resourceGroup == "MyResourceGroup"</code></td>
<td>Resources in a specific group</td>
</tr>
<tr>
<td>Filter by Tag</td>
<td><code>Resources \| where tags["Environment"] == "Production"</code></td>
<td>Resources with specific tag value</td>
</tr>
</tbody>
</table>
<p><strong>Example: List VMs in a specific resource group:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">resourceGroup</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;MyResourceGroup&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Joining Resources</h2>
<p>Use <code>join</code> to correlate VMs with NICs, disks, or subscriptions. The <code>properties</code> column is JSON, so use <code>tostring</code> or <code>parse_json</code> to extract fields.</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VMs to NICs</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend NICId = tostring(properties.networkProfile.networkInterfaces[0].id) \| join kind=leftouter (Resources \| where type == "microsoft.network/networkinterfaces") on $left.NICId == $right.id</code></td>
<td>Links VMs to their NICs</td>
</tr>
<tr>
<td>VMs to Disks</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id) \| join kind=leftouter (Resources \| where type == "microsoft.compute/disks") on $left.DiskId == $right.id</code></td>
<td>Links VMs to OS disks</td>
</tr>
<tr>
<td>VMs to Subscriptions</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| join kind=leftouter (ResourceContainers \| where type == "microsoft.resources/subscriptions") on subscriptionId</code></td>
<td>Adds subscription names</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with NIC and subscription details:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">ResourceContainers</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.resources/subscriptions&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">subscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionName</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Extracting JSON Properties</h2>
<p>Parse JSON fields from the <code>properties</code> column to get detailed resource information:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VM Computer Name</td>
<td><code>extend VM_ComputerName = tostring(properties.osProfile.computerName)</code></td>
<td>VM's internal name</td>
</tr>
<tr>
<td>NIC Private IP</td>
<td><code>extend PrivateIP = tostring(properties.ipConfigurations[0].properties.privateIPAddress)</code></td>
<td>NIC's private IP address</td>
</tr>
<tr>
<td>VNet/Subnet Name</td>
<td><code>extend VNetName = split(tostring(properties.ipConfigurations[0].properties.subnet.id), "/")[8]</code></td>
<td>Extract VNet from subnet ID</td>
</tr>
<tr>
<td>Disk Size</td>
<td><code>extend DiskSizeGB = toint(properties.diskSizeGB)</code></td>
<td>Disk size in GB</td>
</tr>
<tr>
<td>OS Type</td>
<td><code>extend OSType = tostring(properties.storageProfile.osDisk.osType)</code></td>
<td>OS (Windows/Linux)</td>
</tr>
</tbody>
</table>
<p><strong>Example: Get VM OS and disk details:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">),</span>
<span class="w">         </span><span class="n">DiskSizeGB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">toint</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">diskSizeGB</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">OSType</span><span class="p">,</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Custom Fields and Conditional Logic</h2>
<p>Use <code>case()</code> to create custom fields and business logic:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Custom OS Name</td>
<td><code>extend DetailedOS = case(properties.storageProfile.osDisk.osType == "Windows", "windows-server", properties.storageProfile.osDisk.osType == "Linux", "Linux", "Unknown")</code></td>
<td>Categorize OS type</td>
</tr>
<tr>
<td>Tag Extraction</td>
<td><code>extend Owner = tostring(tags["Owner"])</code></td>
<td>Extract tag value</td>
</tr>
<tr>
<td>Update Strategy</td>
<td><code>extend UpdateMethod = case(properties.storageProfile.osDisk.osType == "Windows", "azure-update-manager", "Linux Package Manager")</code></td>
<td>Define patching method</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with OS details and tags:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">),</span>
<span class="w">         </span><span class="n">DetailedOS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">case</span><span class="p">(</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Linux&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">publisher</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Canonical&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ubuntu Linux&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Windows&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">offer</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WindowsServer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;windows-server&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s">&quot;Unknown&quot;</span>
<span class="w">         </span><span class="p">),</span>
<span class="w">         </span><span class="n">Environment</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Environment&quot;</span><span class="p">])</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">DetailedOS</span><span class="p">,</span><span class="w"> </span><span class="n">Environment</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Disk Queries</h2>
<p>Query disks directly or join with VMs to check configurations:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>List Disks</td>
<td><code>Resources \| where type == "microsoft.compute/disks"</code></td>
<td>All managed disks</td>
</tr>
<tr>
<td>Disks by VM</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id) \| join kind=leftouter (Resources \| where type == "microsoft.compute/disks") on $left.DiskId == $right.id</code></td>
<td>Links VMs to OS disks</td>
</tr>
<tr>
<td>Disk Size Filter</td>
<td><code>Resources \| where type == "microsoft.compute/disks" \| extend DiskSizeGB = toint(properties.diskSizeGB) \| where DiskSizeGB &gt; 100</code></td>
<td>Disks larger than 100 GB</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with OS disk sizes:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">DiskId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">managedDisk</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/disks&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">DiskId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">toint</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">diskSizeGB</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">DiskId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Copy-Paste Ready Queries for Common Tasks</h2>
<h3>1. Complete VM Inventory</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">),</span>
<span class="w">         </span><span class="n">DiskId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">managedDisk</span><span class="err">.</span><span class="n">id</span><span class="p">),</span>
<span class="w">         </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">),</span>
<span class="w">         </span><span class="n">Environment</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Environment&quot;</span><span class="p">])</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/disks&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">DiskId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">toint</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">diskSizeGB</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">DiskId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="p">,</span><span class="w"> </span><span class="n">OSType</span><span class="p">,</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="p">,</span><span class="w"> </span><span class="n">Environment</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h3>2. Cost Analysis: Resources by Type and Location</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">ResourceCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">location</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ResourceCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Note:</strong> This query helps with <a href="/blog/azure-finops-complete-guide/">Azure cost management</a> by identifying resource distribution patterns. For comprehensive FinOps strategies including tag-based cost allocation and chargeback reporting, see our <a href="/blog/azure-finops-complete-guide/">complete FinOps guide</a>.</p>
<h3>3. Security Audit: Find Untagged Resources</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;microsoft.storage/storageaccounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;microsoft.network/networksecuritygroups&quot;</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">isnull</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">array_length</span><span class="p">(</span><span class="n">bag_keys</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="mi">0</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">location</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>
</code></pre></div>

<h3>4. VMs by Subscription and VNet</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">VNetName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">subnet</span><span class="err">.</span><span class="n">id</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">VNetName</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">ResourceContainers</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.resources/subscriptions&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">subscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">VNetName</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionName</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h3>5. Find Production VMs with Specific Tags</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">Environment</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Environment&quot;</span><span class="p">]),</span>
<span class="w">         </span><span class="n">Owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Owner&quot;</span><span class="p">])</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Production&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Environment</span><span class="p">,</span><span class="w"> </span><span class="n">Owner</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h3>6. OS Distribution and Update Strategy</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">),</span>
<span class="w">         </span><span class="n">OSProduct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">offer</span><span class="p">),</span>
<span class="w">         </span><span class="n">OSVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">sku</span><span class="p">),</span>
<span class="w">         </span><span class="n">DetailedOS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">case</span><span class="p">(</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Linux&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">publisher</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Canonical&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ubuntu Linux&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Linux&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">publisher</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;RedHat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Red Hat Linux&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Windows&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">OSProduct</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WindowsServer&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">OSVersion</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;2022&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Windows Server 2022&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Windows&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">OSProduct</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WindowsServer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Windows Server - Other&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s">&quot;Unknown&quot;</span>
<span class="w">         </span><span class="p">),</span>
<span class="w">         </span><span class="n">UpdateMethod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">case</span><span class="p">(</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Windows&quot;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">OSProduct</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WindowsServer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;azure-update-manager&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Linux&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Linux Package Manager&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s">&quot;Manual&quot;</span>
<span class="w">         </span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">DetailedOS</span><span class="p">,</span><span class="w"> </span><span class="n">UpdateMethod</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<h2>Visualizing in Resource Graph</h2>
<p>Resource Graph Explorer supports visualizations like tables or pie charts. Use <code>summarize</code> to prepare data:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VMs by OS</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| summarize count() by OSType = tostring(properties.storageProfile.osDisk.osType)</code></td>
<td>Count VMs by Windows/Linux</td>
</tr>
<tr>
<td>Disks by Size</td>
<td><code>Resources \| where type == "microsoft.compute/disks" \| summarize count() by DiskSizeGB = toint(properties.diskSizeGB)</code></td>
<td>Count disks by size</td>
</tr>
</tbody>
</table>
<p><strong>Example: Chart VMs by OS type:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">)</span>
</code></pre></div>

<p>In Resource Graph Explorer, select "Pie chart" in the portal to visualize.</p>
<h2>KQL Performance Optimization: Query Speed Matters at Scale</h2>
<p><strong>When you're querying 31,000+ resources across 44 subscriptions, query performance matters.</strong></p>
<p>Here's what I learned managing enterprise-scale Azure environments.</p>
<h3>Why Query Performance Matters</h3>
<p><strong>Slow query symptoms:</strong><br />
- Query timeout errors in Resource Graph Explorer<br />
- 30+ second wait times for results<br />
- Portal becomes unresponsive<br />
- Can't run queries during business hours (too slow)</p>
<p><strong>The cost of slow queries:</strong><br />
- Wasted time (30 seconds √ó 50 queries/day = 25 minutes daily)<br />
- Delayed incident response<br />
- Frustrated stakeholders waiting for reports<br />
- Can't use queries in automation (timeout kills scripts)</p>
<h3>Performance Rule #1: Filter Early, Filter Often</h3>
<p><strong>Bad query (slow):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">tags</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">resourceGroup</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Production-RG&quot;</span>
</code></pre></div>

<p><strong>Why it's slow:</strong> Projects ALL columns from ALL resources BEFORE filtering</p>
<p><strong>Good query (fast):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">resourceGroup</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Production-RG&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">tags</span>
</code></pre></div>

<p><strong>Why it's fast:</strong> Filters FIRST to reduce data, projects ONLY needed columns</p>
<p><strong>Performance improvement: 10-20x faster</strong></p>
<h3>Performance Rule #2: Project Only What You Need</h3>
<p><strong>Bad query:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">AllProperties</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parse_json</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="c">// Pulls entire properties JSON for every VM</span>
</code></pre></div>

<p><strong>Good query:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">)</span>
<span class="c">// Extracts only the specific field needed</span>
</code></pre></div>

<p><strong>Why:</strong> Parsing entire JSON objects is expensive. Extract only the fields you actually use.</p>
<h3>Performance Rule #3: Use <code>in</code> Instead of Multiple <code>or</code> Conditions</h3>
<p><strong>Bad query:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span><span class="w"> </span>
<span class="w">   </span><span class="k">or</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.storage/storageaccounts&quot;</span>
<span class="w">   </span><span class="k">or</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networksecuritygroups&quot;</span>
<span class="w">   </span><span class="k">or</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.sql/servers&quot;</span>
</code></pre></div>

<p><strong>Good query:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="s">&quot;microsoft.storage/storageaccounts&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;microsoft.network/networksecuritygroups&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;microsoft.sql/servers&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Performance improvement: 3-5x faster</strong> for multiple conditions</p>
<h3>Performance Rule #4: Limit Results During Testing</h3>
<p><strong>Testing queries:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">take</span><span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="c">// Test with 10 VMs first</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">osType</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">OSType</span>
</code></pre></div>

<p><strong>Once query works, remove <code>take</code> for full results.</strong></p>
<p><strong>Why:</strong> Testing on 10 rows is instant. Testing on 10,000 rows wastes time if query has errors.</p>
<h3>Performance Rule #5: Join Efficiently</h3>
<p><strong>Bad join (slow):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span><span class="n">Resources</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="err">$</span><span class="n">left</span><span class="err">.</span><span class="n">subscriptionId</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="err">$</span><span class="n">right</span><span class="err">.</span><span class="n">subscriptionId</span>
<span class="c">// Joins to entire Resources table (millions of rows)</span>
</code></pre></div>

<p><strong>Good join (fast):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span><span class="w">  </span><span class="c">// Filter BEFORE join</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="err">$</span><span class="n">left</span><span class="err">.</span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="err">$</span><span class="n">right</span><span class="err">.</span><span class="n">NetworkInterfaceId</span>
</code></pre></div>

<p><strong>Why:</strong> Filter both sides of join to smallest dataset possible BEFORE joining.</p>
<h3>Real-World Performance Example</h3>
<p><strong>Scenario:</strong> Get all VMs with their private IPs across 44 subscriptions</p>
<p><strong>Bad query (45 seconds):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span><span class="n">Resources</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="err">$</span><span class="n">left</span><span class="err">.</span><span class="n">id</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="err">$</span><span class="n">right</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">virtualMachine</span><span class="err">.</span><span class="n">id</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
</code></pre></div>

<p><strong>Good query (3 seconds):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span>
</code></pre></div>

<p><strong>Performance improvement: 15x faster</strong></p>
<p><strong>Why the difference:</strong><br />
1. Filter VMs first (reduces dataset)<br />
2. Filter NICs before join (reduces join size)<br />
3. Project only needed columns (reduces memory)<br />
4. Use efficient join key (NetworkInterfaceId)</p>
<hr />
<h2>KQL vs SQL: Translation Guide for SQL Developers</h2>
<p><strong>Coming from SQL? Here's how KQL compares.</strong></p>
<p>Many Azure admins know SQL but not KQL. This translation guide helps you leverage existing knowledge.</p>
<h3>Basic Syntax Comparison</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>SQL</th>
<th>KQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Select all</td>
<td><code>SELECT * FROM VMs</code></td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines"</code></td>
</tr>
<tr>
<td>Filter rows</td>
<td><code>WHERE location = 'eastus'</code></td>
<td><code>\| where location == "eastus"</code></td>
</tr>
<tr>
<td>Select columns</td>
<td><code>SELECT name, location</code></td>
<td><code>\| project name, location</code></td>
</tr>
<tr>
<td>Count rows</td>
<td><code>SELECT COUNT(*) FROM VMs</code></td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| count</code></td>
</tr>
<tr>
<td>Group by</td>
<td><code>GROUP BY location</code></td>
<td><code>\| summarize count() by location</code></td>
</tr>
<tr>
<td>Order results</td>
<td><code>ORDER BY name</code></td>
<td><code>\| order by name</code></td>
</tr>
<tr>
<td>Limit results</td>
<td><code>LIMIT 10</code></td>
<td><code>\| take 10</code></td>
</tr>
</tbody>
</table>
<h3>Key Conceptual Differences</h3>
<p><strong>SQL thinks in tables. KQL thinks in pipelines.</strong></p>
<p><strong>SQL:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="k">location</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">privateIP</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">VMs</span><span class="w"> </span><span class="n">v</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">NICs</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="k">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eastus&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">name</span>
</code></pre></div>

<p><strong>KQL equivalent:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;eastus&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span>
</code></pre></div>

<p><strong>Differences:</strong><br />
- KQL uses pipes (<code>|</code>) to chain operations sequentially<br />
- SQL uses JOIN at clause level, KQL uses <code>join</code> as an operator<br />
- KQL requires <code>extend</code> to create new columns before using them<br />
- SQL's <code>SELECT</code> combines column selection and calculation; KQL separates (<code>project</code> vs <code>extend</code>)</p>
<h3>Aggregation Translation</h3>
<p><strong>SQL:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">location</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">VMCount</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">VMs</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">location</span>
<span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="k">DESC</span>
</code></pre></div>

<p><strong>KQL:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">location</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">10</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Key difference:</strong> KQL's <code>summarize</code> combines <code>GROUP BY</code> and aggregation. <code>HAVING</code> becomes a <code>where</code> after <code>summarize</code>.</p>
<h3>Subquery Translation</h3>
<p><strong>SQL:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">VMs</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">location</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">location</span><span class="w"> </span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">VMs</span><span class="w"> </span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">location</span><span class="w"> </span>
<span class="w">    </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>KQL:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">let</span><span class="w"> </span><span class="n">LocationsWithManyVMs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">location</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">location</span><span class="p">;</span>
<span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">LocationsWithManyVMs</span><span class="p">)</span>
</code></pre></div>

<p><strong>Key difference:</strong> KQL uses <code>let</code> to define reusable subqueries. Think of it like SQL CTEs (Common Table Expressions).</p>
<h3>String Operations</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>SQL</th>
<th>KQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Contains</td>
<td><code>WHERE name LIKE '%prod%'</code></td>
<td><code>\| where name contains "prod"</code></td>
</tr>
<tr>
<td>Starts with</td>
<td><code>WHERE name LIKE 'vm-%'</code></td>
<td><code>\| where name startswith "vm-"</code></td>
</tr>
<tr>
<td>Ends with</td>
<td><code>WHERE name LIKE '%-prod'</code></td>
<td><code>\| where name endswith "-prod"</code></td>
</tr>
<tr>
<td>Case insensitive</td>
<td><code>WHERE LOWER(name) = 'vmname'</code></td>
<td><code>\| where name =~ "vmname"</code></td>
</tr>
<tr>
<td>Concat</td>
<td><code>CONCAT(name, '-', location)</code></td>
<td><code>strcat(name, "-", location)</code> or <code>name + "-" + location</code></td>
</tr>
<tr>
<td>Substring</td>
<td><code>SUBSTRING(name, 1, 5)</code></td>
<td><code>substring(name, 0, 5)</code></td>
</tr>
</tbody>
</table>
<h3>Date/Time Operations (Log Analytics)</h3>
<p><strong>Note:</strong> Resource Graph doesn't have time-based data. These examples are for Log Analytics queries.</p>
<table>
<thead>
<tr>
<th>Task</th>
<th>SQL</th>
<th>KQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Last 24 hours</td>
<td><code>WHERE timestamp &gt; NOW() - INTERVAL 1 DAY</code></td>
<td><code>\| where TimeGenerated &gt; ago(24h)</code></td>
</tr>
<tr>
<td>Between dates</td>
<td><code>WHERE timestamp BETWEEN '2024-01-01' AND '2024-01-31'</code></td>
<td><code>\| where TimeGenerated between (datetime(2024-01-01) .. datetime(2024-01-31))</code></td>
</tr>
<tr>
<td>Date part</td>
<td><code>EXTRACT(HOUR FROM timestamp)</code></td>
<td><code>format_datetime(TimeGenerated, 'HH')</code> or <code>bin(TimeGenerated, 1h)</code></td>
</tr>
</tbody>
</table>
<h3>Common KQL Functions SQL Developers Should Know</h3>
<p><strong>Case statements:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: CASE WHEN ... THEN ... ELSE ... END</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">OSCategory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">case</span><span class="p">(</span>
<span class="w">    </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Windows&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Microsoft&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">OSType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Linux&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Open Source&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Unknown&quot;</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Coalesce (NULL handling):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: COALESCE(column1, column2, &#39;default&#39;)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">Owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Owner&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;CreatedBy&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;Unassigned&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>String splitting:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: SPLIT_PART or STRING_SPLIT</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">VNetName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">SubnetId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span><span class="w">  </span><span class="c">// Get 8th element from path</span>
</code></pre></div>

<p><strong>Array operations:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// Get first element</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">FirstNIC</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span>

<span class="c">// Array length</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NICCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">array_length</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">)</span>
</code></pre></div>

<h3>Common SQL Patterns ‚Üí KQL</h3>
<p><strong>Get top N:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: SELECT TOP 10 * FROM VMs ORDER BY DiskSizeGB DESC</span>
<span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">toint</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">diskSizeGB</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">DiskSizeGB</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Distinct values:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: SELECT DISTINCT location FROM VMs</span>
<span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">location</span>
</code></pre></div>

<p><strong>Count distinct:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// SQL: SELECT COUNT(DISTINCT location) FROM VMs</span>
<span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">UniqueLocations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcount</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2>Advanced KQL Techniques for Azure Resource Graph</h2>
<p><strong>Beyond basics: techniques for complex queries.</strong></p>
<h3>Dynamic Columns and Arrays</h3>
<p><strong>Problem:</strong> You need to work with arrays in JSON properties.</p>
<p><strong>Extract all NICs from a VM (not just first):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">mv-expand</span><span class="w"> </span><span class="n">NIC</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">NIC</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateIP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">privateIPAddress</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">NICs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_list</span><span class="p">(</span><span class="n">PrivateIP</span><span class="p">)</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="p">,</span><span class="w"> </span><span class="n">AllPrivateIPs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NICs</span>
</code></pre></div>

<p><strong>What <code>mv-expand</code> does:</strong> Expands arrays into separate rows (like SQL's UNNEST or CROSS APPLY).</p>
<h3>Working with Tags at Scale</h3>
<p><strong>Find resources missing critical tags:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;microsoft.storage/storageaccounts&quot;</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">HasEnvironmentTag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">isnotnull</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Environment&quot;</span><span class="p">]),</span>
<span class="w">         </span><span class="n">HasOwnerTag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">isnotnull</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;Owner&quot;</span><span class="p">]),</span>
<span class="w">         </span><span class="n">HasCostCenterTag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">isnotnull</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&quot;CostCenter&quot;</span><span class="p">])</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">HasEnvironmentTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">HasOwnerTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">HasCostCenterTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">MissingTags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">strcat</span><span class="p">(</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">HasEnvironmentTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Environment &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">HasOwnerTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Owner &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">HasCostCenterTag</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CostCenter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">MissingTags</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>
</code></pre></div>

<p><strong>Result:</strong> Clear report showing exactly which tags are missing per resource.</p>
<h3>Complex JSON Parsing</h3>
<p><strong>Extract nested properties:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">ImagePublisher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">publisher</span><span class="p">),</span>
<span class="w">         </span><span class="n">ImageOffer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">offer</span><span class="p">),</span>
<span class="w">         </span><span class="n">ImageSku</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">sku</span><span class="p">),</span>
<span class="w">         </span><span class="n">ImageVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">imageReference</span><span class="err">.</span><span class="n">version</span><span class="p">),</span>
<span class="w">         </span><span class="n">FullImageString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">strcat</span><span class="p">(</span><span class="n">ImagePublisher</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ImageOffer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ImageSku</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ImageVersion</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">FullImageString</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Use case:</strong> Understand image distribution across your environment.</p>
<h3>Cross-Subscription Resource Relationships</h3>
<p><strong>Find VMs connected to VNets in different subscriptions:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">networkProfile</span><span class="err">.</span><span class="n">networkInterfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">Resources</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.network/networkinterfaces&quot;</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">SubnetId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">ipConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">properties</span><span class="err">.</span><span class="n">subnet</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">VNetSubscription</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">SubnetId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">NetworkInterfaceId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">VNetSubscription</span><span class="p">,</span><span class="w"> </span><span class="n">NICSubscription</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">subscriptionId</span>
<span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">NetworkInterfaceId</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">VNetSubscription</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="n">NICSubscription</span><span class="w">  </span><span class="c">// Cross-subscription connection</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">VMSubscription</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span><span class="n">VNetSubscription</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</code></pre></div>

<p><strong>Why this matters:</strong> Cross-subscription networking creates security and cost allocation complexity.</p>
<h3>Bulk Compliance Checking</h3>
<p><strong>Check for specific security configurations across all VMs:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">BootDiagEnabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tobool</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">diagnosticsProfile</span><span class="err">.</span><span class="n">bootDiagnostics</span><span class="err">.</span><span class="n">enabled</span><span class="p">),</span>
<span class="w">         </span><span class="n">ManagedDisk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">isnotnull</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">storageProfile</span><span class="err">.</span><span class="n">osDisk</span><span class="err">.</span><span class="n">managedDisk</span><span class="p">),</span>
<span class="w">         </span><span class="n">VMAgent</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">properties</span><span class="err">.</span><span class="n">osProfile</span><span class="err">.</span><span class="n">windowsConfiguration</span><span class="err">.</span><span class="n">provisionVMAgent</span><span class="p">,</span>
<span class="w">         </span><span class="n">SecurityType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">securityProfile</span><span class="err">.</span><span class="n">securityType</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">ComplianceScore</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">BootDiagEnabled</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">+</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">ManagedDisk</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">+</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">VMAgent</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">true</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">+</span>
<span class="w">    </span><span class="n">iff</span><span class="p">(</span><span class="n">SecurityType</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;TrustedLaunch&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">ComplianceStatus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">case</span><span class="p">(</span>
<span class="w">    </span><span class="n">ComplianceScore</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Compliant&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">ComplianceScore</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Partial&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Non-Compliant&quot;</span>
<span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ComplianceScore</span><span class="p">,</span><span class="w"> </span><span class="n">ComplianceStatus</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ComplianceScore</span><span class="w"> </span><span class="n">asc</span>
</code></pre></div>

<p><strong>Result:</strong> Quantitative compliance scoring for prioritizing remediation.</p>
<hr />
<h2>Microsoft Sentinel KQL Examples</h2>
<p><strong>KQL for security operations in Sentinel.</strong></p>
<p>Microsoft Sentinel uses KQL for security queries. Here are common patterns for Azure admins working with Sentinel.</p>
<h3>Failed Sign-In Attempts</h3>
<p><strong>Find repeated failed sign-ins from same user:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">SigninLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResultType</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w">  </span><span class="c">// 0 = success</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span><span class="w"> </span>
<span class="w">            </span><span class="n">IPAddresses</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_set</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">),</span>
<span class="w">            </span><span class="n">Locations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_set</span><span class="p">(</span><span class="n">Location</span><span class="p">)</span>
<span class="w">            </span><span class="k">by</span><span class="w"> </span><span class="n">UserPrincipalName</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Use case:</strong> Detect brute force attacks or compromised credentials.</p>
<h3>Azure Activity Log Security Events</h3>
<p><strong>Track who deleted Azure resources:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">7</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="n">endswith</span><span class="w"> </span><span class="s">&quot;/delete&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceGroup</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Use case:</strong> Security audit trail for resource deletions.</p>
<h3>VM Creation and Modification Tracking</h3>
<p><strong>Monitor VM deployments:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResourceProviderValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Microsoft.Compute&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">has</span><span class="w"> </span><span class="s">&quot;virtualMachines/write&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">VMName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">Properties</span><span class="p">)</span><span class="err">.</span><span class="n">resource</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="n">VMName</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Use case:</strong> Track who's creating VMs (cost control + security).</p>
<h3>Detecting Unusual Azure Portal Access</h3>
<p><strong>Find logins from new countries:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">let</span><span class="w"> </span><span class="n">UserLocations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SigninLogs</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">KnownCountries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_set</span><span class="p">(</span><span class="n">LocationDetails</span><span class="err">.</span><span class="n">countryOrRegion</span><span class="p">)</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">UserPrincipalName</span><span class="p">;</span>
<span class="n">SigninLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">Country</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">LocationDetails</span><span class="err">.</span><span class="n">countryOrRegion</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">kind</span><span class="p">=</span><span class="n">leftouter</span><span class="w"> </span><span class="p">(</span><span class="n">UserLocations</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">UserPrincipalName</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Country</span><span class="w"> </span><span class="err">!</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">KnownCountries</span><span class="p">)</span><span class="w">  </span><span class="c">// New country</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">UserPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="n">Country</span><span class="p">,</span><span class="w"> </span><span class="n">IPAddress</span><span class="p">,</span><span class="w"> </span><span class="n">ResultType</span>
</code></pre></div>

<p><strong>Use case:</strong> Detect compromised accounts accessed from unusual locations.</p>
<h3>High-Privilege Azure Role Assignments</h3>
<p><strong>Track who's assigning Owner/Contributor roles:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Microsoft.Authorization/roleAssignments/write&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">RoleDefinition</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">Properties</span><span class="p">)</span><span class="err">.</span><span class="n">roleDefinitionId</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">RoleDefinition</span><span class="w"> </span><span class="k">has</span><span class="w"> </span><span class="s">&quot;Owner&quot;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">RoleDefinition</span><span class="w"> </span><span class="k">has</span><span class="w"> </span><span class="s">&quot;Contributor&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Use case:</strong> Security monitoring of privilege escalation.</p>
<h3>Sentinel Watchlist Integration</h3>
<p><strong>Check if IPs are in threat watchlist:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">let</span><span class="w"> </span><span class="n">ThreatIPs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_GetWatchlist</span><span class="p">(</span><span class="s">&quot;KnownBadIPs&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">IPAddress</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SearchKey</span><span class="p">;</span>
<span class="n">SigninLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">IPAddress</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">ThreatIPs</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">UserPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="n">IPAddress</span><span class="p">,</span><span class="w"> </span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">ResultType</span>
</code></pre></div>

<p><strong>Use case:</strong> Correlate Azure activity with threat intelligence.</p>
<hr />
<h2>Troubleshooting Common Errors</h2>
<p><strong>Query timeout:</strong> Add <code>| take 100</code> to limit results while testing</p>
<p><strong>JSON parsing errors:</strong> Use <code>tostring()</code> consistently when extracting from <code>properties</code></p>
<p><strong>Join failures:</strong> Verify the join keys match exactly (case-sensitive)</p>
<p><strong>Empty results:</strong> Check resource type spelling: <code>"microsoft.compute/virtualmachines"</code> (all lowercase)</p>
<p><strong>"The request had some invalid properties" error:</strong><br />
- Usually caused by trying to access properties that don't exist<br />
- Use <code>isnotnull()</code> or <code>coalesce()</code> to handle missing properties<br />
- Example: <code>| extend OSType = coalesce(tostring(properties.storageProfile.osDisk.osType), "Unknown")</code></p>
<p><strong>"Query execution exceeded the maximum allowed time" error:</strong><br />
- Query is too complex or dataset too large<br />
- Apply filters earlier in the query<br />
- Reduce the number of joins<br />
- Break complex queries into smaller steps with <code>let</code> statements</p>
<p><strong>"Mv-expand operator: argument 'ColumnName' is not an array" error:</strong><br />
- Trying to expand a non-array field<br />
- Verify the property is actually an array using <code>array_length()</code><br />
- Example check: <code>| where array_length(properties.networkProfile.networkInterfaces) &gt; 0</code></p>
<p><strong>"Column 'propertyName' not found" error:</strong><br />
- Property doesn't exist on all resources being queried<br />
- Filter to specific resource types first<br />
- Use <code>has</code> instead of exact property paths for safer queries</p>
<h2>Tips for Beginners</h2>
<ul>
<li><strong>Run Queries:</strong> Use Azure Portal &gt; Resource Graph Explorer for quick access</li>
<li><strong>Parse JSON:</strong> Use <code>tostring</code> or <code>parse_json</code> for properties and tags</li>
<li><strong>Test Small:</strong> Add <code>take 10</code> to preview results</li>
<li><strong>Schema:</strong> Check table/column details in Resource Graph Explorer's left pane</li>
<li><strong>Performance:</strong> Filter early with <code>where type == ...</code> to reduce data</li>
<li><strong>Limitations:</strong> Resource Graph is for metadata only. For metrics (e.g., CPU, disk IOPS), use Log Analytics (<code>AzureMetrics</code>)</li>
<li><strong>Save queries:</strong> Use Resource Graph Explorer's "Save" button to build a personal query library</li>
<li><strong>Shared queries:</strong> Create shared queries in Azure for team collaboration</li>
<li><strong>Export results:</strong> Use "Download as CSV" for Excel analysis or reporting</li>
</ul>
<hr />
<h2>Download PDF Version</h2>
<p>Want this cheat sheet as a PDF for easy reference? Get 45+ production-ready KQL queries including advanced joins, performance optimization, and automation templates.</p>
<hr />
<p><strong>Questions about KQL or need help with a specific query?</strong> Find more Azure insights at <a href="https://azure-noob.com">azure-noob.com</a>.</p>
<p><em>KQL Cheat Sheet v2.0 - Updated with performance optimization, SQL translation guide, and Sentinel examples</em></p>
  </div>

  
  <section class="starter-kit-callout" style="
    max-width: 800px;
    margin: 3rem auto 2rem;
    padding: 2rem;
    border-radius: 12px;
    background: var(--bg-light);
    border: 1px solid var(--border);
    text-align: left;
  ">
    <h3 style="margin-top: 0;">Azure Admin Starter Kit (Free Download)</h3>
    <p style="margin-bottom: 1rem;">
      Get my KQL cheat sheet, 50 Windows + 50 Linux commands, and an Azure RACI template in one free bundle.
    </p>
    <a href="/blog/starter-kit/" class="btn">Get the Starter Kit ‚Üí</a>
  </section>

  
  <aside class="email-capture" style="max-width: 800px; margin: 4rem auto; padding: 3rem; background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%); border-radius: 12px; text-align: center; color: white;">
    <h3 style="margin-top: 0; color: white; font-size: 1.75rem;">Get Azure operational guides in your inbox</h3>
    <p style="margin: 1rem 0 2rem; font-size: 1.1rem; color: white;">Weekly tips from managing 44 Azure subscriptions. No marketing BS.</p>
    <div id="kit-form-container"></div>
    <script async data-uid="e2173d9e4e" src="https://azure-noob-2.kit.com/e2173d9e4e/index.js"></script>
  </aside>
  
  <style>
    /* NUCLEAR CSS OVERRIDE FOR KIT FORM */
    .email-capture * {
      color: #333 !important;
    }
    .email-capture h3,
    .email-capture p {
      color: white !important;
    }
    .email-capture input,
    .email-capture input[type="email"],
    .email-capture .formkit-input,
    .email-capture [data-element="email-input"] {
      background: white !important;
      background-color: white !important;
      color: #333 !important;
      border: 2px solid white !important;
    }
    .email-capture button,
    .email-capture button[type="submit"],
    .email-capture .formkit-submit {
      background: white !important;
      background-color: white !important;
      color: #0078d4 !important;
      font-weight: 600 !important;
    }
  </style>

  
  
  <aside class="related-posts" style="max-width: 800px; margin: 3rem auto; padding: 2rem; background: var(--bg-light); border-radius: 12px;">
    <h3 style="margin-top: 0;">Related Posts</h3>
    <ul style="list-style: none; padding: 0;">
      
      <li style="margin: 1rem 0;">
        <a href="/blog/kql-multiple-systems" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">KQL Across 5 Azure Systems: The Query Compatibility Guide</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-24</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="/blog/pull-meta-from-arm" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">I&#39;ll Pull The Meta From ARM - What 6 Months of KQL Actually Looks Like</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-11-10</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="/blog/kql-query-library-git" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Stop Losing Your KQL Queries: The Git-Based Query Library Nobody Told You About</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-28</span>
        </a>
      </li>
      
    </ul>
  </aside>
  

  
  
  
    <!-- CTA: KQL Query Library -->
<div class="cta-block" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 2rem; border-radius: 8px; margin: 3rem 0; text-align: center; color: white;">
  <h3 style="margin: 0 0 1rem; font-size: 1.75rem; color: white;">üìä Stop Rewriting the Same KQL Queries</h3>
  <p style="margin: 0 0 1.5rem; font-size: 1.1rem; line-height: 1.6;">
    Get <strong>45+ production-ready KQL queries</strong> for Azure Resource Graph, Log Analytics, and Activity Logs.
    Copy-paste ready with comments and business context.
  </p>
  <a href="/static/downloads/KQL-Query-Library-Complete.pdf" 
     download
     style="display: inline-block; padding: 0.75rem 2rem; background: white; color: #f5576c; text-decoration: none; border-radius: 6px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;"
     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)'"
     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
    Download Complete Query Library
  </a>
  <p style="margin: 1rem 0 0; font-size: 0.9rem; opacity: 0.9;">
    PDF format ‚Ä¢ No email required ‚Ä¢ Instant download
  </p>
</div>
  

  
  <nav class="post-nav">
    
      <a href="/blog/azure-cost-management-is-confusing-but-you-can-tame-it">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">‚Üê Previous</span>
        <strong>Azure Cost Management Is Confusing‚ÄîBut You Can Tame It</strong>
      </a>
    
    
      <a href="/blog/azure-vm-inventory-kql" style="text-align: right;">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Next ‚Üí</span>
        <strong>From Raw Data to Actionable Insights: Mastering Azure VM Inventory with KQL</strong>
      </a>
    
  </nav>

</article>

    </div>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025 Azure Noob ‚Äî Don&#39;t be a Noob</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem;">
        <a href="/rss.xml" title="Subscribe via RSS">RSS Feed</a> ¬∑ 
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
      </p>
      <p style="margin-top: 1.5rem; font-size: 0.85rem; opacity: 0.7; font-style: italic;">
        "Trust in the Lord with all your heart, and lean not on your own understanding;<br>
        in all your ways acknowledge Him, and He will make your paths straight" ‚Äî Proverbs 3:5-6
      </p>
    </div>
  </footer>

  <!-- Copy code functionality -->
  <script src="/static/copy-code.js"></script>
</body>
</html>