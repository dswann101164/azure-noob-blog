 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Primary SEO -->
  <title></title>
  <meta name="description" content="">
  <link rel="canonical" href="" />

  <!-- Favicons -->
  <link rel="icon" href="../../static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  

  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  

  <!-- Styles -->
  <link rel="stylesheet" href="../../static/styles.css">

  <!-- Google Analytics -->
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="../../index.html" class="brand-link">
          <img src="../../static/images/logo.png" alt=" logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong></strong>
        </span>
      </div>
      <nav class="nav">
        <a href="../../index.html">Home</a>
        <a href="../index.html">Blog</a>
        <a href="../../about/index.html">About</a>
        <a href="../../tags/index.html">Tags</a>
        <a href="../../search/index.html">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      
<article class="post">

  
  
    <div class="hero">
      <img src="/static/images/hero/kql-cheat-sheet.png" alt="KQL Cheat Sheet for Azure Admins: Complete Resource Graph Guide">
    </div>
  

  <header class="post-header">
    <h1>KQL Cheat Sheet for Azure Admins: Complete Resource Graph Guide</h1>
    <p class="muted">
      2025-01-15 · ~9 min read
       · Azure, KQL, Resource Graph, PowerShell
    </p>
    
      <p class="summary">Master Azure Resource Graph with this comprehensive KQL cheat sheet. Query VMs, NICs, disks, and more with practical examples and copy-paste queries.</p>
    
  </header>

  
  <div class="post-body">
    <h1>KQL Cheat Sheet for Azure Admins: Azure Resource Graph (VMs, NICs, Disks)</h1>
<p>This Kusto Query Language (KQL) cheat sheet is designed for Azure administrators new to KQL, focusing on querying Azure resources like virtual machines (VMs), network interface cards (NICs), managed disks, and subscriptions using Azure Resource Graph in the Azure Portal (Resource Graph Explorer). </p>
<p>Use this to inventory resources, check configurations, or troubleshoot VM-related issues. For more details, see the <a href="https://docs.microsoft.com/en-us/azure/data-explorer/kql-quick-reference">KQL quick reference</a> and <a href="https://docs.microsoft.com/en-us/azure/governance/resource-graph/">Resource Graph query docs</a>.</p>
<h2>Getting Started</h2>
<p><strong>Where to Run:</strong> Azure Portal &gt; Resource Graph Explorer (search "Resource Graph" in the portal).</p>
<p><strong>Key Tables:</strong><br />
- <code>Resources</code>: Contains all Azure resources (VMs, NICs, disks, etc.)<br />
- <code>ResourceContainers</code>: Contains subscriptions and resource groups</p>
<p><strong>Basic Query Structure:</strong> Start with <code>Resources</code> or <code>ResourceContainers</code>, pipe (<code>|</code>) to operators like <code>where</code>, <code>join</code>, or <code>project</code>.</p>
<p><strong>Case Sensitivity:</strong> Operators are case-insensitive; string comparisons (e.g., <code>has</code>) are case-sensitive unless using <code>_cs</code> (e.g., <code>has_cs</code>).</p>
<p><strong>Resource Graph Notes:</strong> Queries resource metadata (not logs or metrics). No <code>TimeGenerated</code> field, unlike Log Analytics.</p>
<h2>Quick Start: Your First 3 Queries</h2>
<p><strong>1. List all your VMs:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| project name, location, resourceGroup
</code></pre>

<p><strong>2. Find VMs in a specific resource group:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources  
| where type == &quot;microsoft.compute/virtualmachines&quot;
| where resourceGroup == &quot;MyResourceGroup&quot;
| project name, location
</code></pre>

<p><strong>3. Show VM count by location:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot; 
| summarize count() by location
</code></pre>

<h2>Core KQL Concepts</h2>
<p><strong>Tables = Your Data Sources</strong><br />
- Think of tables like Excel sheets - each contains different types of data<br />
- <code>Resources</code> = all your Azure resources<br />
- <code>ResourceContainers</code> = subscriptions and resource groups</p>
<p><strong>Where = Your Filter</strong><br />
- Like Excel filters - narrows down your data<br />
- Always filter early for better performance</p>
<p><strong>Project = Your Columns</strong><br />
- Selects which columns to display<br />
- Keeps output clean and focused</p>
<h2>Querying Resources</h2>
<p>Use <code>Resources</code> to list VMs, NICs, disks, or other resources.</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>List VMs</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines"</code></td>
<td>All VMs across subscriptions</td>
</tr>
<tr>
<td>List NICs</td>
<td><code>Resources \| where type == "microsoft.network/networkinterfaces"</code></td>
<td>All network interfaces</td>
</tr>
<tr>
<td>List Disks</td>
<td><code>Resources \| where type == "microsoft.compute/disks"</code></td>
<td>All managed disks</td>
</tr>
<tr>
<td>Filter by Resource Group</td>
<td><code>Resources \| where resourceGroup == "MyResourceGroup"</code></td>
<td>Resources in a specific group</td>
</tr>
<tr>
<td>Filter by Tag</td>
<td><code>Resources \| where tags["Environment"] == "Production"</code></td>
<td>Resources with specific tag value</td>
</tr>
</tbody>
</table>
<p><strong>Example: List VMs in a specific resource group:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| where resourceGroup == &quot;MyResourceGroup&quot;
| project name, location, resourceGroup
</code></pre>

<h2>Joining Resources</h2>
<p>Use <code>join</code> to correlate VMs with NICs, disks, or subscriptions. The <code>properties</code> column is JSON, so use <code>tostring</code> or <code>parse_json</code> to extract fields.</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VMs to NICs</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend NICId = tostring(properties.networkProfile.networkInterfaces[0].id) \| join kind=leftouter (Resources \| where type == "microsoft.network/networkinterfaces") on $left.NICId == $right.id</code></td>
<td>Links VMs to their NICs</td>
</tr>
<tr>
<td>VMs to Disks</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id) \| join kind=leftouter (Resources \| where type == "microsoft.compute/disks") on $left.DiskId == $right.id</code></td>
<td>Links VMs to OS disks</td>
</tr>
<tr>
<td>VMs to Subscriptions</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| join kind=leftouter (ResourceContainers \| where type == "microsoft.resources/subscriptions") on subscriptionId</code></td>
<td>Adds subscription names</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with NIC and subscription details:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend NetworkInterfaceId = tostring(properties.networkProfile.networkInterfaces[0].id)
| join kind=leftouter (
    Resources
    | where type == &quot;microsoft.network/networkinterfaces&quot;
    | project NetworkInterfaceId = id, PrivateIP = tostring(properties.ipConfigurations[0].properties.privateIPAddress)
) on NetworkInterfaceId
| join kind=leftouter (
    ResourceContainers
    | where type == &quot;microsoft.resources/subscriptions&quot;
    | project subscriptionId, SubscriptionName = name
) on subscriptionId
| project VMName = name, PrivateIP, SubscriptionName, resourceGroup
</code></pre>

<h2>Extracting JSON Properties</h2>
<p>Parse JSON fields from the <code>properties</code> column to get detailed resource information:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VM Computer Name</td>
<td><code>extend VM_ComputerName = tostring(properties.osProfile.computerName)</code></td>
<td>VM's internal name</td>
</tr>
<tr>
<td>NIC Private IP</td>
<td><code>extend PrivateIP = tostring(properties.ipConfigurations[0].properties.privateIPAddress)</code></td>
<td>NIC's private IP address</td>
</tr>
<tr>
<td>VNet/Subnet Name</td>
<td><code>extend VNetName = split(tostring(properties.ipConfigurations[0].properties.subnet.id), "/")[8]</code></td>
<td>Extract VNet from subnet ID</td>
</tr>
<tr>
<td>Disk Size</td>
<td><code>extend DiskSizeGB = toint(properties.diskSizeGB)</code></td>
<td>Disk size in GB</td>
</tr>
<tr>
<td>OS Type</td>
<td><code>extend OSType = tostring(properties.storageProfile.osDisk.osType)</code></td>
<td>OS (Windows/Linux)</td>
</tr>
</tbody>
</table>
<p><strong>Example: Get VM OS and disk details:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend OSType = tostring(properties.storageProfile.osDisk.osType),
         DiskSizeGB = toint(properties.storageProfile.osDisk.diskSizeGB)
| project VMName = name, OSType, DiskSizeGB, resourceGroup
</code></pre>

<h2>Custom Fields and Conditional Logic</h2>
<p>Use <code>case()</code> to create custom fields and business logic:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Custom OS Name</td>
<td><code>extend DetailedOS = case(properties.storageProfile.osDisk.osType == "Windows", "Windows Server", properties.storageProfile.osDisk.osType == "Linux", "Linux", "Unknown")</code></td>
<td>Categorize OS type</td>
</tr>
<tr>
<td>Tag Extraction</td>
<td><code>extend Owner = tostring(tags["Owner"])</code></td>
<td>Extract tag value</td>
</tr>
<tr>
<td>Update Strategy</td>
<td><code>extend UpdateMethod = case(properties.storageProfile.osDisk.osType == "Windows", "Azure Update Manager", "Linux Package Manager")</code></td>
<td>Define patching method</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with OS details and tags:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend OSType = tostring(properties.storageProfile.osDisk.osType),
         DetailedOS = case(
             OSType == &quot;Linux&quot; and properties.storageProfile.imageReference.publisher == &quot;Canonical&quot;, &quot;Ubuntu Linux&quot;,
             OSType == &quot;Windows&quot; and properties.storageProfile.imageReference.offer contains &quot;WindowsServer&quot;, &quot;Windows Server&quot;,
             &quot;Unknown&quot;
         ),
         Environment = tostring(tags[&quot;Environment&quot;])
| project VMName = name, DetailedOS, Environment, resourceGroup
</code></pre>

<h2>Disk Queries</h2>
<p>Query disks directly or join with VMs to check configurations:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>List Disks</td>
<td><code>Resources \| where type == "microsoft.compute/disks"</code></td>
<td>All managed disks</td>
</tr>
<tr>
<td>Disks by VM</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| extend DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id) \| join kind=leftouter (Resources \| where type == "microsoft.compute/disks") on $left.DiskId == $right.id</code></td>
<td>Links VMs to OS disks</td>
</tr>
<tr>
<td>Disk Size Filter</td>
<td><code>Resources \| where type == "microsoft.compute/disks" \| extend DiskSizeGB = toint(properties.diskSizeGB) \| where DiskSizeGB &gt; 100</code></td>
<td>Disks larger than 100 GB</td>
</tr>
</tbody>
</table>
<p><strong>Example: VMs with OS disk sizes:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id)
| join kind=leftouter (
    Resources
    | where type == &quot;microsoft.compute/disks&quot;
    | project DiskId = id, DiskSizeGB = toint(properties.diskSizeGB)
) on DiskId
| project VMName = name, DiskSizeGB, resourceGroup
</code></pre>

<h2>Copy-Paste Ready Queries for Common Tasks</h2>
<h3>1. Complete VM Inventory</h3>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend NetworkInterfaceId = tostring(properties.networkProfile.networkInterfaces[0].id),
         DiskId = tostring(properties.storageProfile.osDisk.managedDisk.id),
         OSType = tostring(properties.storageProfile.osDisk.osType),
         Environment = tostring(tags[&quot;Environment&quot;])
| join kind=leftouter (
    Resources
    | where type == &quot;microsoft.network/networkinterfaces&quot;
    | project NetworkInterfaceId = id, PrivateIP = tostring(properties.ipConfigurations[0].properties.privateIPAddress)
) on NetworkInterfaceId
| join kind=leftouter (
    Resources
    | where type == &quot;microsoft.compute/disks&quot;
    | project DiskId = id, DiskSizeGB = toint(properties.diskSizeGB)
) on DiskId
| project VMName = name, PrivateIP, OSType, DiskSizeGB, Environment, resourceGroup
</code></pre>

<h3>2. Cost Analysis: Resources by Type and Location</h3>
<pre class="codehilite"><code class="language-kql">Resources
| summarize ResourceCount = count() by type, location
| order by ResourceCount desc
</code></pre>

<h3>3. Security Audit: Find Untagged Resources</h3>
<pre class="codehilite"><code class="language-kql">Resources
| where type in (&quot;microsoft.compute/virtualmachines&quot;, &quot;microsoft.storage/storageaccounts&quot;, &quot;microsoft.network/networksecuritygroups&quot;)
| where isnull(tags) or array_length(bag_keys(tags)) == 0
| project name, type, resourceGroup, location
| order by type, name
</code></pre>

<h3>4. VMs by Subscription and VNet</h3>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend NetworkInterfaceId = tostring(properties.networkProfile.networkInterfaces[0].id)
| join kind=leftouter (
    Resources
    | where type == &quot;microsoft.network/networkinterfaces&quot;
    | extend VNetName = split(tostring(properties.ipConfigurations[0].properties.subnet.id), &quot;/&quot;)[8]
    | project NetworkInterfaceId = id, VNetName
) on NetworkInterfaceId
| join kind=leftouter (
    ResourceContainers
    | where type == &quot;microsoft.resources/subscriptions&quot;
    | project subscriptionId, SubscriptionName = name
) on subscriptionId
| project VMName = name, VNetName, SubscriptionName, resourceGroup
</code></pre>

<h3>5. Find Production VMs with Specific Tags</h3>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend Environment = tostring(tags[&quot;Environment&quot;]),
         Owner = tostring(tags[&quot;Owner&quot;])
| where Environment == &quot;Production&quot;
| project VMName = name, Environment, Owner, resourceGroup
</code></pre>

<h3>6. OS Distribution and Update Strategy</h3>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| extend OSType = tostring(properties.storageProfile.osDisk.osType),
         OSProduct = tostring(properties.storageProfile.imageReference.offer),
         OSVersion = tostring(properties.storageProfile.imageReference.sku),
         DetailedOS = case(
             OSType == &quot;Linux&quot; and properties.storageProfile.imageReference.publisher == &quot;Canonical&quot;, &quot;Ubuntu Linux&quot;,
             OSType == &quot;Linux&quot; and properties.storageProfile.imageReference.publisher == &quot;RedHat&quot;, &quot;Red Hat Linux&quot;,
             OSType == &quot;Windows&quot; and OSProduct contains &quot;WindowsServer&quot; and OSVersion contains &quot;2022&quot;, &quot;Windows Server 2022&quot;,
             OSType == &quot;Windows&quot; and OSProduct contains &quot;WindowsServer&quot;, &quot;Windows Server - Other&quot;,
             &quot;Unknown&quot;
         ),
         UpdateMethod = case(
             OSType == &quot;Windows&quot; and OSProduct contains &quot;WindowsServer&quot;, &quot;Azure Update Manager&quot;,
             OSType == &quot;Linux&quot;, &quot;Linux Package Manager&quot;,
             &quot;Manual&quot;
         )
| project VMName = name, DetailedOS, UpdateMethod, resourceGroup
</code></pre>

<h2>Visualizing in Resource Graph</h2>
<p>Resource Graph Explorer supports visualizations like tables or pie charts. Use <code>summarize</code> to prepare data:</p>
<table>
<thead>
<tr>
<th>What You Want</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VMs by OS</td>
<td><code>Resources \| where type == "microsoft.compute/virtualmachines" \| summarize count() by OSType = tostring(properties.storageProfile.osDisk.osType)</code></td>
<td>Count VMs by Windows/Linux</td>
</tr>
<tr>
<td>Disks by Size</td>
<td><code>Resources \| where type == "microsoft.compute/disks" \| summarize count() by DiskSizeGB = toint(properties.diskSizeGB)</code></td>
<td>Count disks by size</td>
</tr>
</tbody>
</table>
<p><strong>Example: Chart VMs by OS type:</strong></p>
<pre class="codehilite"><code class="language-kql">Resources
| where type == &quot;microsoft.compute/virtualmachines&quot;
| summarize count() by OSType = tostring(properties.storageProfile.osDisk.osType)
</code></pre>

<p>In Resource Graph Explorer, select "Pie chart" in the portal to visualize.</p>
<h2>Troubleshooting Common Errors</h2>
<p><strong>Query timeout:</strong> Add <code>| take 100</code> to limit results while testing<br />
<strong>JSON parsing errors:</strong> Use <code>tostring()</code> consistently when extracting from <code>properties</code><br />
<strong>Join failures:</strong> Verify the join keys match exactly (case-sensitive)<br />
<strong>Empty results:</strong> Check resource type spelling: <code>"microsoft.compute/virtualmachines"</code> (all lowercase)</p>
<h2>Tips for Beginners</h2>
<ul>
<li><strong>Run Queries:</strong> Use Azure Portal &gt; Resource Graph Explorer for quick access</li>
<li><strong>Parse JSON:</strong> Use <code>tostring</code> or <code>parse_json</code> for properties and tags</li>
<li><strong>Test Small:</strong> Add <code>take 10</code> to preview results</li>
<li><strong>Schema:</strong> Check table/column details in Resource Graph Explorer's left pane</li>
<li><strong>Performance:</strong> Filter early with <code>where type == ...</code> to reduce data</li>
<li><strong>Limitations:</strong> Resource Graph is for metadata only. For metrics (e.g., CPU, disk IOPS), use Log Analytics (<code>AzureMetrics</code>)</li>
</ul>
<hr />
<h2>Download PDF Version</h2>
<p>Want this cheat sheet as a PDF for easy reference? Enter your email below and I'll send you the complete guide plus bonus queries for security auditing and cost optimization.</p>
<form name="kql-cheat-sheet" method="POST" netlify data-netlify="true" action="/thank-you/">

  <div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email Address:</label>
    <input type="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
  </div>

  <div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name (optional):</label>
    <input type="text" name="name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
  </div>

  <div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold;">What's your biggest Azure challenge?</label>
    <select name="challenge" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <option value="">Select one...</option>
      <option value="cost-management">Cost management and optimization</option>
      <option value="resource-inventory">Resource inventory and governance</option>
      <option value="security-compliance">Security and compliance</option>
      <option value="automation">Automation and scripting</option>
      <option value="other">Other</option>
    </select>
  </div>

  <button type="submit" style="background: #0066cc; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
    📧 Send Me the PDF + Bonus Queries
  </button>
</form>

<hr />
<p><strong>Questions about KQL or need help with a specific query?</strong> Email me at [your-email] or find more Azure insights at <a href="https://azure-noob.com">azure-noob.com</a>.</p>
<p><em>KQL Cheat Sheet v1.0 - More Azure tutorials and guides available at azure-noob.com</em></p>
  </div>

  
  <nav class="post-nav">
    
      <a href="../azure-cost-management-is-confusing-but-you-can-tame-it/index.html">← Azure Cost Management is Confusing (But You Can Tame It)</a>
    
    
      <a href="../azure-vm-inventory-kql/index.html">From Raw Data to Actionable Insights: Mastering Azure VM Inventory with KQL →</a>
    
  </nav>

</article>

    </div>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025  — </p>
    </div>
  </footer>
</body>
</html>