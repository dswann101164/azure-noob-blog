<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  

  <!-- Primary SEO -->
  <title>The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit ¬∑ Azure Noob</title>
  <meta name="description" content="The hidden audit gap between what Azure logs, what auditors expect, and what your governance model actually covers‚Äîplus concrete steps to close it.">
  
  <link rel="canonical" href="https://azure-noob.com/blog/azure-audit-gap-nobody-talks-about" />

  <!-- Favicons -->
  <link rel="icon" href="/static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit">
  <meta property="og:description" content="The hidden audit gap between what Azure logs, what auditors expect, and what your governance model actually covers‚Äîplus concrete steps to close it.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://azure-noob.com/blog/azure-audit-gap-nobody-talks-about">
  <meta property="og:image" content="https://azure-noob.com/static/images/hero/azure-audit-gap.png">

  
    <meta property="article:published_time" content="2025-10-26T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-10-26T00:00:00+00:00">
    <meta property="article:author" content="David Swann">
    
      
        <meta property="article:tag" content="Audit">
      
        <meta property="article:tag" content="Auditing">
      
        <meta property="article:tag" content="Azure">
      
        <meta property="article:tag" content="Compliance">
      
        <meta property="article:tag" content="Governance">
      
        <meta property="article:tag" content="KQL">
      
        <meta property="article:tag" content="Logging">
      
        <meta property="article:tag" content="Security">
      
    
  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit">
  <meta name="twitter:description" content="The hidden audit gap between what Azure logs, what auditors expect, and what your governance model actually covers‚Äîplus concrete steps to close it.">
  <meta name="twitter:image" content="https://azure-noob.com/static/images/hero/azure-audit-gap.png">

  <!-- Styles -->
  <link rel="stylesheet" href="/static/styles.css">

  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="Azure Noob RSS Feed" href="https://azure-noob.com/rss.xml">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="/" class="brand-link">
          <img src="/static/images/logo.png" alt="Azure Noob logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong>Azure Noob</strong>
        </span>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/blog/">Blog</a>
        <a href="/hubs/" style="font-weight: 700;">Content Hubs</a>
        <a href="/products" style="font-weight: 700; color: #ff6b6b;">Products</a>
        <a href="/start-here">Start Here</a>
        <a href="/blog/starter-kit/">Starter Kit</a>
        <a href="/about">About</a>
        <a href="/tags/">Tags</a>
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
        <a href="/search">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit",
  "description": "The hidden audit gap between what Azure logs, what auditors expect, and what your governance model actually covers‚Äîplus concrete steps to close it.",
  "image": {
    "@type": "ImageObject",
    "url": "https://azure-noob.com/static/images/hero/azure-audit-gap.png",
    "width": 1200,
    "height": 630
  },
  "author": {
    "@type": "Person",
    "name": "David Swann",
    "url": "https://azure-noob.com/about/",
    "description": "Azure Architect specializing in enterprise cloud infrastructure",
    "jobTitle": "Azure Architect",
    "worksFor": {
      "@type": "Organization",
      "name": "Synovus"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Azure Noob",
    "url": "https://azure-noob.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://azure-noob.com/static/images/logo.png"
    }
  },
  "datePublished": "2025-10-26T00:00:00+00:00",
  "dateModified": "2025-10-26T00:00:00+00:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://azure-noob.com/blog/azure-audit-gap-nobody-talks-about"
  },
  "keywords": "Audit, Auditing, Azure, Compliance, Governance, KQL, Logging, Security",
  "articleSection": "Audit",
  "wordCount": "8946",
  "timeRequired": "PT45M",
  "inLanguage": "en-US",
  "isAccessibleForFree": "True",
  "about": {
    "@type": "Thing",
    "name": "Audit"
  }
}
</script>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://azure-noob.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://azure-noob.com/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit",
      "item": "https://azure-noob.com/blog/azure-audit-gap-nobody-talks-about"
    }
  ]
}
</script>







<article class="post">

  
  
    
    <div class="hero">
      <img src="/static/images/hero/azure-audit-gap.png" alt="The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit" loading="eager">
    </div>
  

  <header class="post-header">
    <h1>The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit</h1>
    <p class="muted">
      2025-10-26 ¬∑ ~45 min read
      
    </p>
    
    
    <ul class="tags-list">
      
      <li><a href="/tags/Audit" class="tag-badge">Audit</a></li>
      
      <li><a href="/tags/Auditing" class="tag-badge">Auditing</a></li>
      
      <li><a href="/tags/Azure" class="tag-badge">Azure</a></li>
      
      <li><a href="/tags/Compliance" class="tag-badge">Compliance</a></li>
      
      <li><a href="/tags/Governance" class="tag-badge">Governance</a></li>
      
      <li><a href="/tags/KQL" class="tag-badge">KQL</a></li>
      
      <li><a href="/tags/Logging" class="tag-badge">Logging</a></li>
      
      <li><a href="/tags/Security" class="tag-badge">Security</a></li>
      
    </ul>
    
    
    
      <p class="summary">The hidden audit gap between what Azure logs, what auditors expect, and what your governance model actually covers‚Äîplus concrete steps to close it.</p>
    
  </header>

  
  <p class="post-actions" style="margin:.5rem 0 0; text-align: center;">
    <button class="btn"
            onclick="window.print(); return false;"
            title="Print this page"
            aria-label="Print this page"
            style="cursor: pointer; background: none; border: 2px solid var(--azure-blue);">
      üñ®Ô∏è Print this page
    </button>
  </p>

  
  <div class="post-body">
    <p>This guide is part of our <a href="/hub/governance/">Azure Governance hub</a> covering policy enforcement, compliance frameworks, and enterprise controls.</p>
<blockquote>
<p><strong>Update (October 27, 2025):</strong> Ready to fix your Activity Log retention? I've published a complete step-by-step implementation guide: <strong><a href="/blog/2025-10-27-soc2-activity-log-step-by-step/">SOC 2 Audit Prep: Activity Log Retention Setup (Step-by-Step)</a></strong>. Every click, every command, every verification - the grill assembly manual version.</p>
</blockquote>
<h2>The Question That Starts the Panic</h2>
<p>"Who created this storage account three months ago?"</p>
<p>You're sitting in a meeting. Security is investigating potential data exposure. Leadership wants answers. You confidently open Azure Portal, navigate to Activity Logs, and...</p>
<p><strong>The data is gone.</strong></p>
<p>Azure Activity Logs keep 90 days by default. Your regulatory requirements demand 5-7 years. And this moment - when you realize you can't answer basic audit questions - is how most organizations discover they're silently non-compliant.</p>
<h2>The Three-Part Audit Problem</h2>
<p>Let me break down what's actually happening in most Azure environments:</p>
<h3>Part 1: Do You HAVE the Logs?</h3>
<p>This is about retention configuration. Out of the box, Azure gives you:</p>
<ul>
<li><strong>Activity Logs (ARM resources):</strong> 90 days in the portal</li>
<li><strong>Azure AD Audit Logs:</strong> 30 days in the portal</li>
<li><strong>That's it.</strong></li>
</ul>
<p>Meanwhile, regulatory frameworks demand:<br />
- <strong>SOX:</strong> 7 years<br />
- <strong>HIPAA:</strong> 6 years<br />
- <strong>GDPR:</strong> Varies by data category<br />
- <strong>PCI-DSS:</strong> 1 year online, 3 years archive<br />
- <strong>State regulations:</strong> Often 5-7 years</p>
<p><strong>The gap:</strong> You're configured for 90 days, but legally required to keep 5-7 years. Most organizations don't discover this until they're asked to produce logs they don't have.</p>
<h2>Azure Compliance Framework Requirements: The Reality Check</h2>
<p><strong>Different regulations have different retention requirements. Here's what actually matters:</strong></p>
<h3>Compliance Framework Retention Requirements</h3>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Minimum Retention</th>
<th>What Must Be Logged</th>
<th>Azure Default</th>
<th>Gap</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SOX (Sarbanes-Oxley)</strong></td>
<td>7 years</td>
<td>All financial system access, changes, admin actions</td>
<td>90 days Activity Logs</td>
<td>6+ years missing</td>
</tr>
<tr>
<td><strong>HIPAA</strong></td>
<td>6 years</td>
<td>PHI access, modifications, disclosures, audit trails</td>
<td>90 days Activity Logs, 30 days Azure AD</td>
<td>5+ years missing</td>
</tr>
<tr>
<td><strong>PCI-DSS</strong></td>
<td>1 year online, 3 years archive</td>
<td>Cardholder data access, network activity, admin changes</td>
<td>90 days Activity Logs</td>
<td>11 months+ missing</td>
</tr>
<tr>
<td><strong>GDPR</strong></td>
<td>Varies (typically 3-7 years)</td>
<td>Data processing activities, consent, access requests, deletions</td>
<td>90 days Activity Logs</td>
<td>2+ years missing</td>
</tr>
<tr>
<td><strong>FISMA</strong></td>
<td>3 years</td>
<td>System access, configuration changes, security events</td>
<td>90 days Activity Logs</td>
<td>2+ years missing</td>
</tr>
<tr>
<td><strong>ISO 27001</strong></td>
<td>1-3 years (risk-based)</td>
<td>Security events, access control, changes</td>
<td>90 days Activity Logs</td>
<td>Varies</td>
</tr>
<tr>
<td><strong>SOC 2</strong></td>
<td>1 year minimum</td>
<td>System changes, access, security controls</td>
<td>90 days Activity Logs</td>
<td>9+ months missing</td>
</tr>
<tr>
<td><strong>FERPA</strong></td>
<td>5 years</td>
<td>Student data access, modifications</td>
<td>90 days Activity Logs</td>
<td>4+ years missing</td>
</tr>
</tbody>
</table>
<h3>What Each Framework Actually Cares About</h3>
<p><strong>SOX Auditors Ask For:</strong><br />
- Who has privileged access to financial systems?<br />
- All changes to production financial databases in the last 7 years<br />
- Segregation of duties evidence<br />
- Change approval trails</p>
<p><strong>Azure gaps for SOX:</strong><br />
- ‚ùå Activity Logs expire after 90 days (need 7 years)<br />
- ‚ùå No built-in change approval workflow tracking<br />
- ‚ùå Segregation of duties requires custom RBAC analysis</p>
<p><strong>HIPAA Auditors Ask For:</strong><br />
- Who accessed patient data systems?<br />
- All administrative actions in PHI environments<br />
- Evidence of access termination when employees leave<br />
- Encryption key access logs</p>
<p><strong>Azure gaps for HIPAA:</strong><br />
- ‚ùå Activity Logs expire after 90 days (need 6 years)<br />
- ‚ùå Azure AD logs expire after 30 days (need 6 years)<br />
- ‚ùå Storage account data plane logs not enabled by default<br />
- ‚ùå Key Vault access logs require diagnostic settings</p>
<p><strong>PCI-DSS Auditors Ask For:</strong><br />
- Network segmentation evidence<br />
- Cardholder data environment access logs<br />
- Admin action trails for CDE resources<br />
- Quarterly vulnerability scan results</p>
<p><strong>Azure gaps for PCI-DSS:</strong><br />
- ‚ùå Network flow logs not enabled by default<br />
- ‚ùå Storage account access logs require configuration<br />
- ‚ùå No built-in quarterly reporting<br />
- ‚ùå CDE tagging strategy required but not enforced</p>
<h3>The Real Cost of Non-Compliance</h3>
<p><strong>Failed audit findings aren't just embarrassing - they're expensive:</strong></p>
<table>
<thead>
<tr>
<th>Compliance Failure</th>
<th>Typical Cost</th>
<th>Timeline to Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SOX finding</strong></td>
<td>$50K-500K in remediation + potential CFO/CIO replacement</td>
<td>6-12 months</td>
</tr>
<tr>
<td><strong>HIPAA violation</strong></td>
<td>$100-50,000 per violation (up to $1.5M annual)</td>
<td>3-6 months</td>
</tr>
<tr>
<td><strong>PCI-DSS non-compliance</strong></td>
<td>Loss of payment processing ($100K+/month revenue)</td>
<td>1-3 months</td>
</tr>
<tr>
<td><strong>GDPR fine</strong></td>
<td>‚Ç¨20M or 4% of global revenue (whichever is higher)</td>
<td>6-18 months</td>
</tr>
<tr>
<td><strong>SOC 2 failure</strong></td>
<td>Loss of enterprise customers ($500K-5M/year)</td>
<td>6-12 months</td>
</tr>
</tbody>
</table>
<p><strong>vs. Cost to Fix Properly:</strong><br />
- Log retention setup: $1K-50K/year (one-time + ongoing)<br />
- Quarterly audit drills: 8 hours/quarter<br />
- Documentation: 16-40 hours one-time</p>
<p><strong>ROI: 10-100x preventing a single compliance failure.</strong></p>
<h3>Part 2: Do You KNOW WHERE the Logs Are?</h3>
<p>Even if you've configured log retention properly, there's a documentation problem. Your logs might be scattered across:</p>
<ul>
<li>Activity Logs in the portal (90 days)</li>
<li>Log Analytics Workspace (configured retention, maybe 30-730 days)</li>
<li>Storage Account archive (hopefully years)</li>
<li>Azure Monitor diagnostic settings (per-resource configuration)</li>
<li>Azure AD Audit Logs (separate system entirely)</li>
</ul>
<p>When the auditor asks "show me who accessed this storage account in Q2 2023," can you immediately answer:<br />
1. WHERE that data lives?<br />
2. HOW to query it?<br />
3. WHO has access to retrieve it?</p>
<p>Most teams spend 4 hours scrambling to find WHERE the data is before they can even start answering the actual question.</p>
<h3>Part 3: Can You QUERY the Logs?</h3>
<p>You've exported logs to a Log Analytics Workspace. Great! Now what?</p>
<p>You need to:<br />
- Know KQL (Kusto Query Language)<br />
- Understand the schema differences between Activity Logs and Azure AD logs<br />
- Build custom queries for common audit scenarios<br />
- Document those queries so you're not rebuilding them every audit cycle</p>
<p><strong>The reality:</strong> Most organizations have configured retention (Part 1), but lack the query skills (Part 3) to actually extract answers when needed.</p>
<h2>The Two Separate Audit Systems</h2>
<p>Here's what trips up most Azure admins: <strong>You're not dealing with one audit system. You're dealing with two.</strong></p>
<h3>System 1: Azure Activity Logs (ARM Resources)</h3>
<p>This covers your ARM resources:<br />
- Virtual machines<br />
- Storage accounts<br />
- Virtual networks<br />
- Key vaults<br />
- Managed disks<br />
- Resource groups</p>
<p><strong>Where it lives:</strong> Azure Resource Manager (ARM) / Azure Monitor<br />
<strong>Query tool:</strong> Resource Graph (for resources) + Log Analytics (for activity)<br />
<strong>Retention default:</strong> 90 days in portal</p>
<h3>System 2: Azure AD Audit Logs (Identity Resources)</h3>
<p>This covers your identity layer:<br />
- App registrations<br />
- Service principals<br />
- Enterprise applications<br />
- User sign-ins<br />
- Admin consent grants<br />
- Role assignments</p>
<p><strong>Where it lives:</strong> Azure Active Directory / Microsoft Entra ID<br />
<strong>Query tool:</strong> Microsoft Graph API or Log Analytics (if exported)<br />
<strong>Retention default:</strong> 30 days in portal</p>
<p><strong>The problem:</strong> Most people only monitor ONE of these systems and completely miss the other.</p>
<h2>Azure Audit Capabilities vs. Other Cloud Providers</h2>
<p><strong>Considering multi-cloud? Here's how Azure compares for audit and compliance.</strong></p>
<h3>Cloud Provider Audit Comparison</h3>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Azure</th>
<th>AWS</th>
<th>GCP</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Default Activity Log Retention</strong></td>
<td>90 days</td>
<td>90 days</td>
<td>400 days (Admin Activity)</td>
</tr>
<tr>
<td><strong>Identity Audit Logs</strong></td>
<td>Azure AD (30 days default)</td>
<td>CloudTrail (90 days)</td>
<td>Cloud Audit Logs (400 days)</td>
</tr>
<tr>
<td><strong>Native Query Language</strong></td>
<td>KQL (powerful)</td>
<td>CloudWatch Insights (limited)</td>
<td>Log Analytics SQL (moderate)</td>
</tr>
<tr>
<td><strong>Cost for 7-Year Retention</strong></td>
<td>$50-1K/month</td>
<td>$100-2K/month</td>
<td>$80-1.5K/month</td>
</tr>
<tr>
<td><strong>Immutable Storage (WORM)</strong></td>
<td>‚úÖ Yes (Blob immutability)</td>
<td>‚úÖ Yes (S3 Object Lock)</td>
<td>‚úÖ Yes (Bucket Lock)</td>
</tr>
<tr>
<td><strong>Real-Time Alerting</strong></td>
<td>‚úÖ Azure Monitor</td>
<td>‚úÖ CloudWatch Alarms</td>
<td>‚úÖ Cloud Monitoring</td>
</tr>
<tr>
<td><strong>Third-Party SIEM Integration</strong></td>
<td>‚úÖ Excellent (Sentinel, Splunk)</td>
<td>‚úÖ Excellent (multiple)</td>
<td>‚úÖ Good (Chronicle)</td>
</tr>
<tr>
<td><strong>Compliance Certifications</strong></td>
<td>90+</td>
<td>143+</td>
<td>70+</td>
</tr>
<tr>
<td><strong>Built-in Compliance Dashboard</strong></td>
<td>‚úÖ Regulatory Compliance (Defender)</td>
<td>‚úÖ Security Hub</td>
<td>‚úÖ Security Command Center</td>
</tr>
</tbody>
</table>
<h3>Key Differences That Matter</h3>
<p><strong>Azure Strengths:</strong><br />
- ‚úÖ KQL is more powerful than AWS CloudWatch Insights<br />
- ‚úÖ Azure AD integration is native (AWS IAM logs separate)<br />
- ‚úÖ Microsoft Sentinel provides built-in SIEM<br />
- ‚úÖ Better integration with Microsoft compliance tools (Purview)</p>
<p><strong>Azure Weaknesses:</strong><br />
- ‚ùå Default retention shorter than GCP (90 days vs 400 days)<br />
- ‚ùå Azure AD Premium required for advanced logging<br />
- ‚ùå Fewer compliance certifications than AWS<br />
- ‚ùå App registrations can't be tagged (AWS IAM roles can)</p>
<p><strong>AWS Strengths:</strong><br />
- ‚úÖ More compliance certifications (143 vs Azure's 90)<br />
- ‚úÖ CloudTrail captures everything by default<br />
- ‚úÖ IAM access analyzer built-in<br />
- ‚úÖ Longer track record with regulators</p>
<p><strong>AWS Weaknesses:</strong><br />
- ‚ùå CloudWatch query language is limited<br />
- ‚ùå More expensive at scale ($100-2K/month for 7 years)<br />
- ‚ùå Complex pricing model (multiple log types)</p>
<p><strong>GCP Strengths:</strong><br />
- ‚úÖ Longest default retention (400 days for admin activity)<br />
- ‚úÖ Flat pricing model (easier to predict)<br />
- ‚úÖ Excellent BigQuery integration for log analysis</p>
<p><strong>GCP Weaknesses:</strong><br />
- ‚ùå Fewer compliance certifications (70 vs Azure's 90)<br />
- ‚ùå Smaller audit ecosystem (fewer third-party tools)<br />
- ‚ùå Less mature identity audit capabilities</p>
<h3>Multi-Cloud Audit Strategy</h3>
<p><strong>If you're running multi-cloud, you need centralized audit aggregation:</strong></p>
<p><strong>Option 1: Third-Party SIEM (Splunk, Sumo Logic, Datadog)</strong><br />
- <strong>Pros:</strong> Single pane of glass, cross-cloud correlation<br />
- <strong>Cons:</strong> Expensive ($50K-500K/year), complex setup<br />
- <strong>Best for:</strong> Large enterprises (1,000+ cloud resources)</p>
<p><strong>Option 2: Native per-cloud (Azure Sentinel, AWS Security Hub, GCP Chronicle)</strong><br />
- <strong>Pros:</strong> Native integration, lower cost, easier setup<br />
- <strong>Cons:</strong> Separate dashboards, manual correlation<br />
- <strong>Best for:</strong> Mid-size (100-1,000 resources)</p>
<p><strong>Option 3: Export to Common Data Lake (Azure Data Lake, S3, BigQuery)</strong><br />
- <strong>Pros:</strong> Flexible, supports custom analytics<br />
- <strong>Cons:</strong> Requires custom query development<br />
- <strong>Best for:</strong> Data-driven organizations with analytics teams</p>
<h2>The App Registration Blind Spot</h2>
<p>Let me tell you about the alert that drives every Azure admin crazy:</p>
<p><strong>Tenable Scanner Alert:</strong> "Unused app registration detected with client secret expiring in 30 days"</p>
<p>You get 50 of these every month. And every single one triggers the same questions:<br />
- Who created this app registration?<br />
- What does it do?<br />
- Is it still being used?<br />
- Who owns it?</p>
<p>Here's why these alerts are so painful:</p>
<h3>App Registrations Can't Be Tagged</h3>
<p>App registrations are <strong>NOT ARM resources</strong>. They're Azure AD objects.</p>
<p>That means:<br />
- ‚ùå No tags (can't apply Cost Center, Owner, Environment tags)<br />
- ‚ùå No Resource Graph support (can't query them with KQL in Resource Graph)<br />
- ‚ùå Different audit system (Azure AD logs, not Activity Logs)<br />
- ‚ùå Different API (Microsoft Graph, not Azure Resource Manager)</p>
<h3>The Ownership Problem</h3>
<p>When you create a VM, you can tag it: <code>Owner: john.doe@company.com</code></p>
<p>When you create an app registration, you get:<br />
- A GUID<br />
- A display name (if they bothered to make it descriptive)<br />
- Maybe a description (if you're lucky)<br />
- An "Owners" field... that's often empty</p>
<p>Three months later, when security asks "who created this?", you're digging through Azure AD audit logs hoping the data is still there.</p>
<h3>The Real-World Scenario</h3>
<p><strong>Security Team Email:</strong> "We found an app registration 'MyApp-Test-042' with a client secret expiring in 2 days. Is this still needed?"</p>
<p>Your investigation process:<br />
1. Search Azure AD Audit Logs (hoping it's within 30 days)<br />
2. Find the creation event (maybe)<br />
3. Look up the user who created it (probably someone who left 6 months ago)<br />
4. Search Slack/Teams for any mention of 'MyApp-Test-042' (desperate times)<br />
5. Ask around until someone recognizes it (maybe)<br />
6. Make a judgment call (coin flip)</p>
<p><strong>This happens every single day in large Azure environments.</strong></p>
<h2>The Day-to-Day Pain Points</h2>
<p>Let me show you the questions you get constantly and why they're so painful to answer:</p>
<h3>Question 1: "Who created this resource?"</h3>
<p><strong>Scenario:</strong> A storage account appears in a production resource group. Nobody recognizes it. Leadership wants to know who created it and why.</p>
<p><strong>The pain:</strong><br />
- Check Activity Logs ‚Üí Only goes back 90 days, creation was 4 months ago<br />
- Check Resource Tags ‚Üí No Owner tag applied<br />
- Check Resource creation logs ‚Üí Not exported to Log Analytics<br />
- <strong>Answer:</strong> "I don't know. The logs are gone."</p>
<h3>Question 2: "Who accessed this storage account?"</h3>
<p><strong>Scenario:</strong> Compliance asks for a list of everyone who accessed a specific storage account during Q2 2024 for audit documentation.</p>
<p><strong>The pain:</strong><br />
- Activity Logs show ARM operations (create, delete, update) but not data plane access<br />
- Storage Analytics logs are separate and may not be enabled<br />
- Diagnostic settings might not be configured<br />
- <strong>Answer:</strong> "Let me get back to you... tomorrow... maybe."</p>
<h3>Question 3: "What did John Doe create before he left?"</h3>
<p><strong>Scenario:</strong> Employee departed 6 months ago. ITSM ticket: Remove all resources created by john.doe@company.com</p>
<p><strong>The pain:</strong><br />
- Activity Logs only go back 90 days<br />
- Resource Graph shows current owners (tags) but not who created resources<br />
- No historical audit trail unless exported<br />
- <strong>Answer:</strong> "I can show you resources he currently owns, but not everything he created."</p>
<h3>Question 4: "Who granted admin consent to this app registration?"</h3>
<p><strong>Scenario:</strong> Security scan finds an app with excessive permissions. Need to track down who approved it and why.</p>
<p><strong>The pain:</strong><br />
- App registrations are in Azure AD, not ARM<br />
- Requires Azure AD Audit Logs (30-day default retention)<br />
- If it happened 31 days ago, the data is gone<br />
- <strong>Answer:</strong> "The audit log doesn't go back that far."</p>
<h3>Question 5: "Is this app registration still being used?"</h3>
<p><strong>Scenario:</strong> 50 app registrations flagged by Tenable. Security wants to delete unused ones.</p>
<p><strong>The pain:</strong><br />
- No built-in "last used" metric for app registrations<br />
- Sign-in logs might show service principal activity<br />
- No correlation between client secret and actual usage<br />
- <strong>Answer:</strong> "We'd have to monitor sign-in logs for 30-90 days to be sure."</p>
<p><strong>The pattern:</strong> You spend 4 hours scrambling to find WHERE the data is, then realize it doesn't exist or isn't accessible.</p>
<h2>Real-World Audit Scenarios by Industry</h2>
<p><strong>Different industries face different audit challenges. Here's what I've seen:</strong></p>
<h3>Healthcare (HIPAA Compliance)</h3>
<p><strong>The scenario:</strong><br />
Regional hospital system, 15 subscriptions, 2,000 VMs, 500TB patient data in Azure storage.</p>
<p><strong>Audit question:</strong> "Show me everyone who accessed patient records for John Doe in the last 6 years."</p>
<p><strong>The problem:</strong><br />
- Activity Logs: Only ARM-level access (who created storage account)<br />
- Data plane access: Not logged by default<br />
- Correlation: Patient name to storage blob path requires custom mapping<br />
- Retention: Default 90 days, need 6 years</p>
<p><strong>What they implemented:</strong><br />
1. <strong>Storage diagnostic settings</strong> enabled on ALL storage accounts with PHI<br />
2. <strong>Log Analytics</strong> with 730-day retention for queries<br />
3. <strong>Immutable blob storage</strong> (WORM) for 7-year archive<br />
4. <strong>Custom KQL query</strong> mapping patient ID ‚Üí storage path ‚Üí access logs<br />
5. <strong>Quarterly testing</strong> of patient access queries</p>
<p><strong>Cost:</strong> $2,500/month (500TB of storage logs adds up)</p>
<p><strong>Audit result:</strong> Passed HIPAA audit with zero findings on logging</p>
<p><strong>Key lesson:</strong> Data plane logging is critical for healthcare - ARM logs aren't enough.</p>
<hr />
<h3>Financial Services (SOX Compliance)</h3>
<p><strong>The scenario:</strong><br />
Investment bank, 44 subscriptions, financial reporting systems in Azure SQL, SOX Section 404 controls.</p>
<p><strong>Audit question:</strong> "Demonstrate segregation of duties: Who can modify financial data AND approve those changes?"</p>
<p><strong>The problem:</strong><br />
- Azure RBAC: Role assignments change over time<br />
- Historical RBAC: Not tracked by default in Activity Logs<br />
- Approvals: No built-in approval workflow in Azure<br />
- Evidence: Need to prove controls were in place for 7 years</p>
<p><strong>What they implemented:</strong><br />
1. <strong>Azure Policy</strong> enforcing specific RBAC roles for financial systems<br />
2. <strong>Change approval workflow</strong> via Azure DevOps (tracks approvals)<br />
3. <strong>Daily RBAC snapshot</strong> exported to storage (track role assignment changes)<br />
4. <strong>Privileged Identity Management (PIM)</strong> for just-in-time admin access<br />
5. <strong>Activity Logs + Azure AD logs</strong> exported to Log Analytics + 7-year storage</p>
<p><strong>Cost:</strong> $15,000/month (enterprise-scale logging + PIM licensing)</p>
<p><strong>Audit result:</strong> Passed SOX 404 audit, SOD controls documented and proven</p>
<p><strong>Key lesson:</strong> RBAC changes over time - you need historical snapshots to prove segregation of duties.</p>
<hr />
<h3>Retail (PCI-DSS Compliance)</h3>
<p><strong>The scenario:</strong><br />
E-commerce company, payment processing in Azure, 200 VMs in cardholder data environment (CDE).</p>
<p><strong>Audit question:</strong> "Show network segmentation between CDE and non-CDE environments for the last year."</p>
<p><strong>The problem:</strong><br />
- Network Security Groups (NSG): Changes over time<br />
- NSG flow logs: Not enabled by default<br />
- Network isolation: Hard to prove retroactively<br />
- Quarterly scans: No built-in tracking</p>
<p><strong>What they implemented:</strong><br />
1. <strong>NSG flow logs</strong> enabled on all CDE subnets<br />
2. <strong>Azure Policy</strong> enforcing CDE tagging (<code>PCI-Scope: True</code>)<br />
3. <strong>Network Watcher</strong> traffic analytics for visualization<br />
4. <strong>Automated NSG validation</strong> (PowerShell script, runs daily, exports results)<br />
5. <strong>Quarterly vulnerability scan</strong> results archived in storage</p>
<p><strong>Cost:</strong> $800/month (NSG flow logs are the biggest cost)</p>
<p><strong>Audit result:</strong> Passed PCI-DSS audit, network segmentation proven</p>
<p><strong>Key lesson:</strong> Network-level compliance requires NSG flow logs + policy enforcement.</p>
<hr />
<h3>SaaS Startup (SOC 2 Type II)</h3>
<p><strong>The scenario:</strong><br />
Fast-growing SaaS startup, 3 subscriptions, preparing for first SOC 2 audit to win enterprise customers.</p>
<p><strong>Audit question:</strong> "Show evidence of security controls operating effectively for the last 12 months."</p>
<p><strong>The problem:</strong><br />
- Company only 18 months old<br />
- Logs only go back 90 days (default)<br />
- No historical evidence of controls<br />
- Limited budget ($5K/month for compliance)</p>
<p><strong>What they implemented:</strong><br />
1. <strong>Minimum viable logging:</strong> Activity Logs + Azure AD logs to Log Analytics (90-day retention)<br />
2. <strong>Storage archive</strong> for 1 year (meet SOC 2 minimum)<br />
3. <strong>5 core queries</strong> documented for common audit scenarios<br />
4. <strong>Monthly export</strong> of key metrics (uptime, security events, changes)<br />
5. <strong>Quarterly security reviews</strong> documented in Confluence</p>
<p><strong>Cost:</strong> $300/month (kept it minimal, will expand post-funding)</p>
<p><strong>Audit result:</strong> Passed SOC 2 Type II audit (first try!)</p>
<p><strong>Key lesson:</strong> Start small but START. Even 90 days of proper logging beats nothing.</p>
<h2>The Solution Architecture</h2>
<p>Here's how to fix this before your next audit. This is not theoretical - this is what I've implemented in production handling SOX compliance.</p>
<h3>Step 1: Configure Log Export</h3>
<p>You need to export logs from their 30/90-day defaults to long-term storage.</p>
<h4>Export Activity Logs to Log Analytics</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create or identify your Log Analytics Workspace</span>
<span class="nv">$workspaceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;audit-logs-workspace&quot;</span>
<span class="nv">$resourceGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;governance-rg&quot;</span>
<span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eastus&quot;</span>

<span class="c1"># Create workspace if it doesn&#39;t exist</span>
az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace-name<span class="w"> </span><span class="nv">$workspaceName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--location<span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--retention-time<span class="w"> </span><span class="m">730</span><span class="w">  </span><span class="c1"># 2 years retention in LAW</span>
</code></pre></div>

<h4>Configure Diagnostic Settings for Activity Logs</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Export subscription-level Activity Logs to Log Analytics</span>
<span class="nv">$subscriptionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>
<span class="nv">$workspaceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>show<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace-name<span class="w"> </span><span class="nv">$workspaceName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>

az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="s2">&quot;export-activity-logs&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace<span class="w"> </span><span class="nv">$workspaceId</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Administrative&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Security&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;ServiceHealth&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Alert&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Recommendation&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Policy&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Autoscale&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;ResourceHealth&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    }</span>
<span class="s1">  ]&#39;</span>
</code></pre></div>

<h4>Export Azure AD Audit Logs</h4>
<p>This requires Azure AD Premium P1 or P2 licensing.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Configure Azure AD diagnostic settings via Portal or API</span>
<span class="c1"># Navigate to: Azure AD &gt; Diagnostic settings &gt; Add diagnostic setting</span>
<span class="c1"># Select:</span>
<span class="c1"># - AuditLogs (who did what in Azure AD)</span>
<span class="c1"># - SignInLogs (authentication events)</span>
<span class="c1"># - NonInteractiveUserSignInLogs (service principal activity)</span>
<span class="c1"># - ServicePrincipalSignInLogs (app registration usage)</span>
<span class="c1"># - ManagedIdentitySignInLogs (managed identity activity)</span>

<span class="c1"># Destination: Same Log Analytics Workspace</span>
</code></pre></div>

<p><strong>PowerShell equivalent:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Connect to Azure AD</span>
<span class="nb">Connect-AzureAD</span>

<span class="c"># Get the Log Analytics Workspace resource ID</span>
<span class="nv">$workspaceResourceId</span> <span class="p">=</span> <span class="s2">&quot;/subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.OperationalInsights/workspaces/$workspaceName&quot;</span>

<span class="c"># Configure diagnostic settings for Azure AD</span>
<span class="c"># Note: This requires Microsoft.Graph PowerShell module</span>
<span class="nb">Install-Module</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Graph</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span>
<span class="nb">Connect-MgGraph</span> <span class="n">-Scopes</span> <span class="s2">&quot;AuditLog.Read.All&quot;</span><span class="p">,</span> <span class="s2">&quot;Directory.Read.All&quot;</span>

<span class="c"># Create diagnostic setting</span>
<span class="nv">$params</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;export-azuread-logs&quot;</span>
    <span class="n">WorkspaceId</span> <span class="p">=</span> <span class="nv">$workspaceResourceId</span>
    <span class="n">Logs</span> <span class="p">=</span> <span class="p">@(</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;AuditLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;SignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;NonInteractiveUserSignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;ServicePrincipalSignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;ManagedIdentitySignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c"># Apply at tenant level</span>
<span class="nb">New-MgBetaDiagnosticSetting</span> <span class="n">-BodyParameter</span> <span class="nv">$params</span>
</code></pre></div>

<h4>Export to Storage Account for Long-Term Archive</h4>
<p>Log Analytics is great for querying (30-730 days), but expensive for 7-year retention. Use Storage Accounts for cheap archive.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create storage account for audit archive</span>
<span class="nv">$storageAccountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;auditarchive</span><span class="k">$(</span>Get-Random<span class="k">)</span><span class="s2">&quot;</span>
az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--location<span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--sku<span class="w"> </span>Standard_LRS<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--kind<span class="w"> </span>StorageV2<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--access-tier<span class="w"> </span>Cool<span class="w">  </span><span class="c1"># Cool tier for infrequent access</span>

<span class="c1"># Get storage account resource ID</span>
<span class="nv">$storageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>

<span class="c1"># Update diagnostic settings to include storage</span>
az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="s2">&quot;export-activity-logs-storage&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--storage-account<span class="w"> </span><span class="nv">$storageId</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Administrative&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true,</span>
<span class="s1">      &quot;retentionPolicy&quot;: {</span>
<span class="s1">        &quot;enabled&quot;: true,</span>
<span class="s1">        &quot;days&quot;: 2555</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  ]&#39;</span>
</code></pre></div>

<p><strong>Cost breakdown:</strong><br />
- Log Analytics: ~$2.50 per GB ingested + $0.12 per GB retention per month<br />
- Storage Account (Cool tier): ~$0.01 per GB per month<br />
- <strong>For 7-year retention:</strong> Storage is 95% cheaper than Log Analytics</p>
<h3>Step 2: Build Your Query Library</h3>
<p>You need pre-built KQL queries for common audit scenarios. Don't rebuild these every time.</p>
<h4>Query 1: Who Created This Resource?</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Find who created a specific resource by name</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;MICROSOFT.RESOURCES/DEPLOYMENTS/WRITE&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="k">or</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;CREATE&quot;</span>
<span class="w">    </span><span class="k">or</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WRITE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResourceId</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;your-resource-name&quot;</span><span class="w">  </span><span class="c">// Replace with actual resource name</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span><span class="w">  </span><span class="c">// Who did it</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span><span class="w">  </span><span class="c">// What was created</span>
<span class="w">    </span><span class="n">OperationNameValue</span><span class="p">,</span><span class="w">  </span><span class="c">// What action</span>
<span class="w">    </span><span class="n">ActivityStatusValue</span><span class="p">,</span><span class="w">  </span><span class="c">// Success/Failure</span>
<span class="w">    </span><span class="n">Claims</span><span class="w">  </span><span class="c">// Full identity context</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
<span class="p">|</span><span class="w"> </span><span class="k">take</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>

<h4>Query 2: All Actions by a Specific User</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Find everything a user did (useful for offboarding investigations)</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Caller</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;john.doe@company.com&quot;</span><span class="w">  </span><span class="c">// Replace with actual user</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span><span class="w">  </span><span class="c">// Adjust time range as needed</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span>
<span class="w">    </span><span class="n">OperationNameValue</span><span class="p">,</span>
<span class="w">    </span><span class="n">ActivityStatusValue</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 3: Resource Deletions</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track all resource deletions (critical for audit trails)</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">OperationNameValue</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 4: Who Granted Admin Consent to an App?</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track admin consent grants (Azure AD Audit Logs)</span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Consent to application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">ConsentedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">Permissions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">modifiedProperties</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">ConsentedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppName</span><span class="p">,</span>
<span class="w">    </span><span class="n">Permissions</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 5: App Registration Creation and Ownership</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track app registration creation (Azure AD Audit Logs)</span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Add application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">AppId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppName</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppId</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 6: Service Principal Sign-In Activity</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Check if an app registration is actually being used</span>
<span class="n">AADServicePrincipalSignInLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">AppId</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;your-app-id-guid&quot;</span><span class="w">  </span><span class="c">// Replace with actual App ID</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">SignInCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span>
<span class="w">    </span><span class="n">LastSignIn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">UniqueResources</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcount</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">AppDisplayName</span><span class="p">,</span><span class="w"> </span><span class="n">AppId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppDisplayName</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppId</span><span class="p">,</span>
<span class="w">    </span><span class="n">SignInCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">LastSignIn</span><span class="p">,</span>
<span class="w">    </span><span class="n">UniqueResources</span>
</code></pre></div>

<h4>Query 7: Storage Account Access (Data Plane)</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track who accessed storage account data (requires diagnostic settings on storage)</span>
<span class="n">StorageBlobLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">AccountName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;yourstorageaccount&quot;</span><span class="w">  </span><span class="c">// Replace with actual storage account</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">StatusCode</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="mi">200</span><span class="w">  </span><span class="c">// Successful operations</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">CallerIdentity</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">Identity</span><span class="p">)</span><span class="err">.</span><span class="n">claims</span><span class="err">.</span><span class="n">upn</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">AccessCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span>
<span class="w">    </span><span class="n">LastAccess</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">CallerIdentity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationName</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AccessCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h2>Common Audit Questions: Quick Reference Cheat Sheet</h2>
<p><strong>When the auditor emails at 4 PM asking for data by tomorrow, use this:</strong></p>
<table>
<thead>
<tr>
<th>Auditor Question</th>
<th>Azure Log Source</th>
<th>KQL Query Type</th>
<th>Typical Retention Need</th>
</tr>
</thead>
<tbody>
<tr>
<td>"Who created this resource?"</td>
<td>Activity Logs</td>
<td>Resource creation query</td>
<td>90 days - 7 years</td>
</tr>
<tr>
<td>"Who deleted this resource?"</td>
<td>Activity Logs</td>
<td>Resource deletion query</td>
<td>90 days - 7 years</td>
</tr>
<tr>
<td>"What did user X do?"</td>
<td>Activity Logs + Azure AD</td>
<td>User activity query</td>
<td>90 days - 7 years</td>
</tr>
<tr>
<td>"Who accessed this storage account?"</td>
<td>Storage diagnostic logs</td>
<td>Data plane access query</td>
<td>1-7 years</td>
</tr>
<tr>
<td>"Who has Owner role on subscription?"</td>
<td>Azure RBAC</td>
<td>Role assignment query (current state)</td>
<td>Real-time</td>
</tr>
<tr>
<td>"Who HAD Owner role 6 months ago?"</td>
<td>Activity Logs (role changes)</td>
<td>Historical role query</td>
<td>6 months - 7 years</td>
</tr>
<tr>
<td>"Who approved this app consent?"</td>
<td>Azure AD Audit Logs</td>
<td>Admin consent query</td>
<td>30 days - 7 years</td>
</tr>
<tr>
<td>"Is this app registration still used?"</td>
<td>Service Principal Sign-In Logs</td>
<td>Sign-in activity query</td>
<td>30-90 days</td>
</tr>
<tr>
<td>"Show all failed login attempts"</td>
<td>Azure AD Sign-In Logs</td>
<td>Failed auth query</td>
<td>30 days - 1 year</td>
</tr>
<tr>
<td>"Who modified this NSG rule?"</td>
<td>Activity Logs</td>
<td>NSG change query</td>
<td>90 days - 3 years</td>
</tr>
<tr>
<td>"Show database schema changes"</td>
<td>Azure SQL Auditing</td>
<td>SQL audit query</td>
<td>90 days - 7 years</td>
</tr>
<tr>
<td>"List all privileged access"</td>
<td>Azure AD PIM Logs</td>
<td>PIM activation query</td>
<td>30 days - 1 year</td>
</tr>
</tbody>
</table>
<h3>The 5 Queries Every Compliance Team Needs</h3>
<p><strong>Save these in your query library. You'll use them constantly:</strong></p>
<p><strong>Query 1: Last 30 Days of Resource Deletions</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceGroup</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Query 2: Changes by High-Privilege Users</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Caller</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;admin1@company.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;admin2@company.com&quot;</span><span class="p">)</span><span class="w">  </span><span class="c">// Replace with actual admins</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">ChangeCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="n">OperationNameValue</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ChangeCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Query 3: Admin Consent Grants (Last 90 Days)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Consent to application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="p">,</span><span class="w"> </span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="n">AppName</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Query 4: Failed Sign-Ins (Potential Brute Force)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">SigninLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResultType</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w">  </span><span class="c">// 0 = success</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">FailCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">UserPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="n">IPAddress</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">FailCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">FailCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Query 5: Storage Account Access (Data Plane)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">StorageBlobLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">7</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">StatusCode</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="mi">200</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">AccessCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AccountName</span><span class="p">,</span><span class="w"> </span><span class="n">CallerIpAddress</span><span class="p">,</span><span class="w"> </span><span class="n">OperationName</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AccessCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Pro tip:</strong> Save these as "Saved Queries" in Log Analytics. Name them clearly: "AUDIT - Resource Deletions", "AUDIT - Admin Changes", etc.</p>
<h3>Step 3: Document Your Logging Architecture</h3>
<p>Create a one-page reference document that answers:</p>
<p><strong>Audit Log Documentation Template:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh"># Azure Audit Logging Architecture</span>

<span class="gu">## Log Analytics Workspace</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Name:**</span> audit-logs-workspace
<span class="k">-</span><span class="w"> </span><span class="gs">**Resource Group:**</span> governance-rg
<span class="k">-</span><span class="w"> </span><span class="gs">**Retention:**</span> 730 days (2 years)
<span class="k">-</span><span class="w"> </span><span class="gs">**Access:**</span> Security team, Compliance team, IT leadership

<span class="gu">## Storage Account Archive</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Name:**</span> auditarchiveXXXXXX
<span class="k">-</span><span class="w"> </span><span class="gs">**Resource Group:**</span> governance-rg
<span class="k">-</span><span class="w"> </span><span class="gs">**Retention:**</span> 2,555 days (7 years)
<span class="k">-</span><span class="w"> </span><span class="gs">**Access:**</span> Compliance team only (RBAC locked down)

<span class="gu">## What&#39;s Collected</span>

<span class="gu">### Activity Logs (ARM Resources)</span>
<span class="k">-</span><span class="w"> </span>All subscriptions configured with diagnostic settings
<span class="k">-</span><span class="w"> </span>Categories: Administrative, Security, Policy, Alerts
<span class="k">-</span><span class="w"> </span>Retention: 730 days in LAW, 7 years in Storage

<span class="gu">### Azure AD Audit Logs</span>
<span class="k">-</span><span class="w"> </span>AuditLogs (who did what in Azure AD)
<span class="k">-</span><span class="w"> </span>SignInLogs (user authentication)
<span class="k">-</span><span class="w"> </span>ServicePrincipalSignInLogs (app registration usage)
<span class="k">-</span><span class="w"> </span>Retention: 730 days in LAW, 7 years in Storage

<span class="gu">## How to Query</span>

<span class="gu">### Portal Access</span>
<span class="k">1.</span> Navigate to: Log Analytics Workspace &gt; Logs
<span class="k">2.</span> Select &quot;audit-logs-workspace&quot;
<span class="k">3.</span> Use pre-built queries from: [Link to internal wiki/SharePoint]

<span class="gu">### Common Queries</span>
<span class="k">-</span><span class="w"> </span>Who created this resource? ‚Üí Query <span class="ni">#1</span>
<span class="k">-</span><span class="w"> </span>What did user X do? ‚Üí Query <span class="ni">#2</span>
<span class="k">-</span><span class="w"> </span>Resource deletions ‚Üí Query <span class="ni">#3</span>
<span class="k">-</span><span class="w"> </span>App consent grants ‚Üí Query <span class="ni">#4</span>

<span class="gu">## Quarterly Audit Process</span>
<span class="k">1.</span> Compliance team requests specific queries
<span class="k">2.</span> IT runs queries from template library
<span class="k">3.</span> Export results to Excel/CSV
<span class="k">4.</span> Compliance validates and archives

<span class="gu">## Contacts</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**IT Governance:**</span> your-team@company.com
<span class="k">-</span><span class="w"> </span><span class="gs">**Compliance:**</span> compliance@company.com
<span class="k">-</span><span class="w"> </span><span class="gs">**Azure Admin:**</span> azure-admins@company.com
</code></pre></div>

<p><strong>Save this document where your team can find it.</strong> SharePoint, Confluence, internal wiki - wherever you keep runbooks.</p>
<h3>Step 4: External Tracking for App Registrations</h3>
<p>Since app registrations can't be tagged, you need external tracking.</p>
<p><strong>Option 1: Spreadsheet (Quick Start)</strong></p>
<p>Create a simple tracking sheet:</p>
<table>
<thead>
<tr>
<th>App Name</th>
<th>App ID</th>
<th>Created By</th>
<th>Created Date</th>
<th>Purpose</th>
<th>Owner</th>
<th>Status</th>
<th>Last Review</th>
</tr>
</thead>
<tbody>
<tr>
<td>MyApp-Prod</td>
<td>guid</td>
<td>john.doe</td>
<td>2024-03-15</td>
<td>Production API</td>
<td>Jane Smith</td>
<td>Active</td>
<td>2024-10-01</td>
</tr>
<tr>
<td>TestApp-042</td>
<td>guid</td>
<td>old.user</td>
<td>2023-08-22</td>
<td>Testing</td>
<td>Unknown</td>
<td>Review</td>
<td>2024-10-01</td>
</tr>
</tbody>
</table>
<p><strong>Update process:</strong><br />
- New app registration? Add row<br />
- Quarterly review? Update Status and Last Review<br />
- Tenable alert? Check this sheet first</p>
<p><strong>Option 2: CMDB Integration (Enterprise)</strong></p>
<p>If you have a CMDB (ServiceNow, Azure DevOps, Jira), create:<br />
- CI Type: "Azure App Registration"<br />
- Automated sync via Microsoft Graph API<br />
- Link to resource owner records</p>
<p><strong>Option 3: Automation Script</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Export all app registrations to CSV for tracking</span>
<span class="nb">Connect-AzureAD</span>

<span class="nv">$apps</span> <span class="p">=</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-All</span> <span class="nv">$true</span>
<span class="nv">$report</span> <span class="p">=</span> <span class="p">@()</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$app</span> <span class="k">in</span> <span class="nv">$apps</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$owners</span> <span class="p">=</span> <span class="nb">Get-AzureADApplicationOwner</span> <span class="n">-ObjectId</span> <span class="nv">$app</span><span class="p">.</span><span class="n">ObjectId</span>

    <span class="nv">$report</span> <span class="p">+=</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
        <span class="n">DisplayName</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">DisplayName</span>
        <span class="n">AppId</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">AppId</span>
        <span class="n">ObjectId</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">ObjectId</span>
        <span class="n">CreatedDateTime</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">CreatedDateTime</span>
        <span class="n">Owners</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$owners</span><span class="p">.</span><span class="n">UserPrincipalName</span> <span class="n">-join</span> <span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="n">SignInAudience</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">SignInAudience</span>
        <span class="n">PublisherDomain</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">PublisherDomain</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$report</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="s2">&quot;app-registrations-inventory.csv&quot;</span> <span class="n">-NoTypeInformation</span>

<span class="nb">Write-Host</span> <span class="s2">&quot;Exported </span><span class="p">$(</span><span class="nv">$report</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> app registrations to CSV&quot;</span>
</code></pre></div>

<p>Run this monthly. Compare to last month's export. Flag new apps without owners.</p>
<h3>Step 5: Test Quarterly (Audit Drills)</h3>
<p>Don't wait for a real audit to discover your logging is broken. Run drills.</p>
<p><strong>Quarterly Audit Drill Checklist:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh"># Q4 2025 Audit Drill</span>

<span class="gu">## Test Date: October 26, 2025</span>
<span class="gu">## Tester: [Your Name]</span>

<span class="gu">### Test 1: Log Retention Verification</span>
<span class="k">- [ ]</span> Verify Activity Logs retention: Query logs from 90+ days ago
<span class="k">- [ ]</span> Verify Azure AD logs retention: Query AuditLogs from 30+ days ago
<span class="k">- [ ]</span> Verify Storage Account archive: Check oldest logs in storage
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 2: Query Execution</span>
<span class="k">- [ ]</span> Run Query <span class="ni">#1:</span> Who created resource X? (pick random VM)
<span class="k">- [ ]</span> Run Query <span class="ni">#2:</span> What did user Y do? (pick random user)
<span class="k">- [ ]</span> Run Query <span class="ni">#4:</span> Recent admin consent grants
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 3: Documentation Access</span>
<span class="k">- [ ]</span> Locate audit documentation
<span class="k">- [ ]</span> Verify links to Log Analytics Workspace
<span class="k">- [ ]</span> Verify query library is up to date
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 4: App Registration Tracking</span>
<span class="k">- [ ]</span> Open app registration inventory
<span class="k">- [ ]</span> Verify last update date
<span class="k">- [ ]</span> Spot check 5 random apps: do owners match Azure AD?
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 5: Access Verification</span>
<span class="k">- [ ]</span> Confirm compliance team has LAW access
<span class="k">- [ ]</span> Confirm storage account access is restricted
<span class="k">- [ ]</span> Verify audit log export is still running
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">## Issues Found:</span>
[List any issues discovered during drill]

<span class="gu">## Action Items:</span>
<span class="k">- [ ]</span> Fix issue <span class="ni">#1</span>
<span class="k">- [ ]</span> Update documentation
<span class="k">- [ ]</span> Retest in 30 days

<span class="gu">## Next Drill: January 26, 2026</span>
</code></pre></div>

<p><strong>Why quarterly?</strong> <br />
- Catches configuration drift before audit season<br />
- Validates your team knows where logs are<br />
- Proves your retention is actually working</p>
<h2>What This Looks Like in Production</h2>
<p>Let me show you what this setup looks like at scale.</p>
<h3>Enterprise Bank Example (SOX Compliance)</h3>
<p><strong>Environment:</strong><br />
- 40+ Azure subscriptions<br />
- Multiple Active Directory domains (consolidation project)<br />
- 300+ applications<br />
- SOX audit requirement: 7 years</p>
<p><strong>What was implemented:</strong></p>
<ol>
<li><strong>Centralized Log Analytics Workspace</strong></li>
<li>One workspace for all subscriptions</li>
<li>730-day retention (balancing cost vs query access)</li>
<li>
<p>Configured via Azure Policy (automatic for new subscriptions)</p>
</li>
<li>
<p><strong>Storage Account Archive</strong></p>
</li>
<li>Separate storage account per compliance zone</li>
<li>7-year retention</li>
<li>Immutable storage (WORM) for tamper-proof logs</li>
<li>
<p>Lifecycle management (auto-archive to Cool tier after 90 days)</p>
</li>
<li>
<p><strong>Query Library</strong></p>
</li>
<li>25 pre-built queries for common audit scenarios</li>
<li>Stored in internal wiki with examples</li>
<li>
<p>Updated quarterly based on actual audit requests</p>
</li>
<li>
<p><strong>App Registration Tracking</strong></p>
</li>
<li>CSV export automated monthly via Azure Automation</li>
<li>Stored in SharePoint with version history</li>
<li>Quarterly review with security team</li>
<li>
<p>Tenable alerts cross-referenced against this inventory</p>
</li>
<li>
<p><strong>Azure Policy Enforcement</strong></p>
</li>
<li>Diagnostic settings automatically applied to new subscriptions</li>
<li>Activity Log export mandatory via policy</li>
<li>Storage account lifecycle management enforced</li>
</ol>
<p><strong>Cost:</strong><br />
- Log Analytics: ~$800/month (all subscriptions)<br />
- Storage Account: ~$50/month (7 years of logs)<br />
- <strong>Total:</strong> ~$850/month for complete audit compliance</p>
<p><strong>ROI:</strong><br />
- First SOX audit: 4 hours to produce all requested logs (vs. weeks previously)<br />
- Security incidents: Immediate answers to "who did what when"<br />
- Offboarding: Complete audit trail of departed employee actions</p>
<h3>Small Environment Example (Startup, 1-3 Subscriptions)</h3>
<p>Don't overthink it if you're small. Start simple:</p>
<p><strong>Minimum Viable Setup:</strong></p>
<ol>
<li><strong>One Log Analytics Workspace</strong></li>
<li>90-day retention (free tier: 5GB/month)</li>
<li>Activity Logs exported from all subscriptions</li>
<li>
<p>Azure AD logs exported (requires Azure AD Premium P1)</p>
</li>
<li>
<p><strong>One Storage Account</strong></p>
</li>
<li>Standard LRS, Cool tier</li>
<li>
<p>1-year retention (extend as budget allows)</p>
</li>
<li>
<p><strong>Five Core Queries</strong></p>
</li>
<li>Who created this?</li>
<li>What did this user do?</li>
<li>Resource deletions</li>
<li>Admin consent grants</li>
<li>
<p>App registration creation</p>
</li>
<li>
<p><strong>Simple App Tracking</strong></p>
</li>
<li>Excel spreadsheet</li>
<li>Updated when Tenable alerts fire</li>
<li>Quarterly manual review</li>
</ol>
<p><strong>Cost:</strong><br />
- Log Analytics: $0-50/month (depending on log volume)<br />
- Storage Account: $5-10/month<br />
- <strong>Total:</strong> ~$60/month or less</p>
<p><strong>When to upgrade:</strong><br />
- Growing past 5 subscriptions ‚Üí Enforce with Azure Policy<br />
- Getting audited ‚Üí Extend retention to match requirements<br />
- Multiple teams ‚Üí Add RBAC and centralized governance</p>
<h2>The Business Case for Leadership</h2>
<p>If you need budget approval, here's your talking points:</p>
<h3>The Risk (What Happens If We Don't)</h3>
<p><strong>Scenario 1: Failed Audit</strong><br />
- Auditor requests logs from 18 months ago<br />
- You can't produce them (90-day default)<br />
- <strong>Result:</strong> Audit finding, potential compliance penalty, reputational damage</p>
<p><strong>Scenario 2: Security Incident</strong><br />
- Breach detected, forensics team needs 6 months of logs<br />
- Activity Logs only go back 90 days<br />
- <strong>Result:</strong> Can't determine scope of breach, can't identify entry point, liability exposure</p>
<p><strong>Scenario 3: Offboarding Investigation</strong><br />
- Employee leaves, manager wants to know what they had access to<br />
- No historical audit trail<br />
- <strong>Result:</strong> 40 hours of manual investigation, incomplete results</p>
<h3>The Cost (What It Actually Takes)</h3>
<p><strong>Setup:</strong><br />
- Engineering time: 8-16 hours (one-time)<br />
- Monthly cost: $50-1,000 depending on scale<br />
- Quarterly testing: 2 hours per quarter</p>
<p><strong>ROI:</strong><br />
- First audit: 80% time savings (hours vs. weeks)<br />
- Security incidents: Immediate forensics capability<br />
- Offboarding: 90% time savings (2 hours vs. 40 hours)</p>
<p><strong>Budget ask:</strong><br />
- Small environment: $1,000/year<br />
- Medium environment: $10,000/year<br />
- Enterprise environment: $50,000/year</p>
<p><strong>Comparison:</strong><br />
- One failed audit finding: $50,000-500,000 in remediation + penalties<br />
- One security breach investigation: $100,000+ in consulting fees<br />
- This solution: $1,000-50,000/year</p>
<p><strong>Approval probability: Very high.</strong></p>
<h2>Audit Tool Alternatives: Azure Native vs. Third-Party</h2>
<p><strong>Should you use Azure's native tools or pay for third-party solutions?</strong></p>
<h3>Tool Comparison Matrix</h3>
<table>
<thead>
<tr>
<th>Tool Category</th>
<th>Azure Native</th>
<th>Third-Party Examples</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Log Collection</strong></td>
<td>Azure Monitor, Log Analytics</td>
<td>Splunk, Sumo Logic, Datadog</td>
<td>Azure Native: &lt;1,000 resources<br>Third-Party: Multi-cloud or &gt;5,000 resources</td>
</tr>
<tr>
<td><strong>SIEM</strong></td>
<td>Microsoft Sentinel</td>
<td>Splunk Enterprise Security, IBM QRadar</td>
<td>Azure Native: Azure-only, &lt;10,000 resources<br>Third-Party: Multi-cloud, complex SOC</td>
</tr>
<tr>
<td><strong>Compliance Dashboards</strong></td>
<td>Azure Policy + Defender</td>
<td>CloudHealth, Prisma Cloud, Lacework</td>
<td>Azure Native: Basic compliance<br>Third-Party: Multi-framework reporting</td>
</tr>
<tr>
<td><strong>Log Storage</strong></td>
<td>Azure Storage (Cool/Archive)</td>
<td>AWS S3, Wasabi, Backblaze B2</td>
<td>Azure Native: Simplicity, native integration<br>Third-Party: Multi-cloud consistency</td>
</tr>
<tr>
<td><strong>Query/Analytics</strong></td>
<td>KQL in Log Analytics</td>
<td>Splunk SPL, Sumo Logic queries</td>
<td>Azure Native: Azure data only<br>Third-Party: Cross-platform correlation</td>
</tr>
<tr>
<td><strong>Alerting</strong></td>
<td>Azure Monitor Alerts</td>
<td>PagerDuty, Opsgenie, VictorOps</td>
<td>Azure Native: Azure-only alerts<br>Third-Party: Multi-tool integration</td>
</tr>
</tbody>
</table>
<h3>Cost Comparison (7-Year Retention for 500GB/month logs)</h3>
<table>
<thead>
<tr>
<th>Solution</th>
<th>Setup Cost</th>
<th>Monthly Cost</th>
<th>Total 7-Year Cost</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Azure Native</strong> (Log Analytics 2yr + Storage 7yr)</td>
<td>$500</td>
<td>$850</td>
<td>$71,700</td>
<td>Simple, integrated, KQL</td>
<td>Azure-only, limited ML</td>
</tr>
<tr>
<td><strong>Splunk Cloud</strong></td>
<td>$10K</td>
<td>$2,500</td>
<td>$220K</td>
<td>Powerful, mature, ML/AI</td>
<td>Expensive, complex, overkill for small orgs</td>
</tr>
<tr>
<td><strong>Sumo Logic</strong></td>
<td>$5K</td>
<td>$1,800</td>
<td>$156K</td>
<td>Cloud-native, good UI</td>
<td>Expensive, query language learning curve</td>
</tr>
<tr>
<td><strong>Datadog</strong></td>
<td>$2K</td>
<td>$1,200</td>
<td>$102K</td>
<td>Great UX, good integrations</td>
<td>Expensive for long retention</td>
</tr>
<tr>
<td><strong>Elastic (ELK)</strong></td>
<td>$8K (self-host setup)</td>
<td>$600 (compute)</td>
<td>$58K</td>
<td>Open-source, flexible</td>
<td>DIY maintenance, steep learning curve</td>
</tr>
</tbody>
</table>
<h3>Decision Framework</h3>
<p><strong>Use Azure Native When:</strong><br />
- ‚úÖ You're Azure-only (no multi-cloud)<br />
- ‚úÖ &lt;1,000 Azure resources<br />
- ‚úÖ Budget &lt;$2K/month for logging<br />
- ‚úÖ Team knows KQL<br />
- ‚úÖ Basic compliance (SOC 2, ISO 27001)</p>
<p><strong>Use Third-Party When:</strong><br />
- ‚úÖ Multi-cloud environment (Azure + AWS/GCP)<br />
- ‚úÖ &gt;5,000 resources across clouds<br />
- ‚úÖ Budget &gt;$5K/month for security<br />
- ‚úÖ Complex compliance (SOX, HIPAA, PCI-DSS)<br />
- ‚úÖ Need advanced ML/AI threat detection<br />
- ‚úÖ 24/7 SOC team needs specialized SIEM</p>
<p><strong>Hybrid Approach:</strong><br />
- Azure native collection (Log Analytics + Storage)<br />
- Export to third-party SIEM for analysis<br />
- Best of both: native integration + advanced analytics</p>
<h3>Real Example: When We Switched</h3>
<p><strong>Scenario:</strong> Started with Azure native (Log Analytics + Storage), grew to 5,000+ resources + AWS.</p>
<p><strong>Why we switched to Splunk:</strong><br />
1. Multi-cloud correlation (Azure + AWS)<br />
2. Advanced ML for anomaly detection<br />
3. Security team already knew Splunk<br />
4. Compliance team wanted single dashboard</p>
<p><strong>Cost impact:</strong><br />
- Before: $800/month (Azure native)<br />
- After: $3,500/month (Splunk Cloud)<br />
- <strong>Increase: 4.4x</strong></p>
<p><strong>Was it worth it?</strong><br />
- ‚úÖ Detected 3 security incidents missed by Azure native<br />
- ‚úÖ Reduced audit prep time from 40 hours ‚Üí 8 hours<br />
- ‚úÖ Cross-cloud visibility prevented cloud sprawl</p>
<p><strong>ROI: Positive after first prevented incident.</strong></p>
<h2>Common Mistakes to Avoid</h2>
<p>I've seen these mistakes repeatedly. Don't repeat them.</p>
<h3>Mistake #1: "We'll Set It Up When We Need It"</h3>
<p><strong>The problem:</strong> By the time you need audit logs, it's too late. You can't retroactively create historical data.</p>
<p><strong>The fix:</strong> Set up retention BEFORE your next audit cycle. If you're audited in Q1 2026, configure this by end of Q4 2025.</p>
<h3>Mistake #2: "We Only Need Activity Logs"</h3>
<p><strong>The problem:</strong> Activity Logs cover ARM resources (VMs, storage). You're missing the entire identity layer (app registrations, consent grants, role assignments).</p>
<p><strong>The fix:</strong> Export BOTH Activity Logs and Azure AD Audit Logs. They're separate systems covering different types of actions.</p>
<h3>Mistake #3: "Log Analytics Retention = Archive"</h3>
<p><strong>The problem:</strong> Log Analytics retention (30-730 days) is great for querying, but expensive for 5-7 year archive requirements.</p>
<p><strong>The fix:</strong> Use Log Analytics for recent logs (90-730 days), then archive to Storage Account for long-term retention. It's 95% cheaper.</p>
<h3>Mistake #4: "We'll Query the Storage Account When Needed"</h3>
<p><strong>The problem:</strong> Querying logs directly from Storage Account is painful. No KQL support, just raw JSON files.</p>
<p><strong>The fix:</strong> Log Analytics for query access (recent logs), Storage Account for compliance archive (old logs you rarely need).</p>
<h3>Mistake #5: "Tagging Solves Everything"</h3>
<p><strong>The problem:</strong> Tags are great for ARM resources, but app registrations can't be tagged. You need separate tracking.</p>
<p><strong>The fix:</strong> External tracking system (spreadsheet, CMDB, automated export) for app registrations. Update it monthly.</p>
<h3>Mistake #6: "Set It and Forget It"</h3>
<p><strong>The problem:</strong> Diagnostic settings get deleted. Log Analytics fills up. Storage accounts get misconfigured. No one notices until the audit.</p>
<p><strong>The fix:</strong> Quarterly audit drills. Test your queries. Verify your retention. Update your documentation.</p>
<h2>The 30-Minute Quick Start</h2>
<p>If you're reading this during an audit crisis, here's your emergency process:</p>
<h3>Hour 1: Verify What You Have</h3>
<div class="codehilite"><pre><span></span><code><span class="c">// Check Activity Log retention</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">OldestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">NewestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">DaysCovered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime_diff</span><span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">))</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">OldestLog</span><span class="p">,</span><span class="w"> </span><span class="n">NewestLog</span><span class="p">,</span><span class="w"> </span><span class="n">DaysCovered</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c">// Check Azure AD log retention  </span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">OldestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">NewestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">DaysCovered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime_diff</span><span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">))</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">OldestLog</span><span class="p">,</span><span class="w"> </span><span class="n">NewestLog</span><span class="p">,</span><span class="w"> </span><span class="n">DaysCovered</span>
</code></pre></div>

<p><strong>If DaysCovered &lt; 90:</strong> You're running on defaults. You need to configure exports NOW.</p>
<h3>Hour 2: Configure Exports (Emergency Mode)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Quick setup: Export logs to new Log Analytics Workspace</span>
az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span>emergency-audit-rg<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace-name<span class="w"> </span>emergency-audit-logs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--location<span class="w"> </span>eastus<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--retention-time<span class="w"> </span><span class="m">730</span>

<span class="c1"># Get workspace ID</span>
<span class="nv">workspaceId</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>show<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span>emergency-audit-rg<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace-name<span class="w"> </span>emergency-audit-logs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>

<span class="c1"># Configure diagnostic settings for current subscription</span>
<span class="nv">subscriptionId</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>
az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>emergency-export<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace<span class="w"> </span><span class="nv">$workspaceId</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[{&quot;category&quot;:&quot;Administrative&quot;,&quot;enabled&quot;:true}]&#39;</span>
</code></pre></div>

<p><strong>Important:</strong> This only captures NEW logs going forward. You can't recover old logs that already expired.</p>
<h3>Hour 3: Document What You've Done</h3>
<p>Create a one-page summary:<br />
- What logs are being captured NOW<br />
- Where they're going (workspace name, resource group)<br />
- How long we'll keep them (retention setting)<br />
- What logs we DON'T have (date ranges we lost)</p>
<p><strong>Be honest in your audit:</strong> "We discovered a gap in our retention configuration. We've corrected it as of [date]. Historical logs prior to [date] are not available."</p>
<h2>The Takeaway</h2>
<p>Most Azure environments are silently non-compliant with audit requirements because nobody talks about the 90-day default.</p>
<p><strong>The three-part problem:</strong><br />
1. Do you HAVE the logs? (retention configuration)<br />
2. Do you KNOW WHERE they are? (documentation gap)<br />
3. Can you QUERY them? (skills gap)</p>
<p><strong>The solution:</strong><br />
1. Export Activity Logs + Azure AD logs to Log Analytics + Storage<br />
2. Build a query library for common audit scenarios<br />
3. Document your logging architecture<br />
4. Track app registrations externally (they can't be tagged)<br />
5. Test quarterly with audit drills</p>
<p><strong>The cost:</strong> $50-1,000/month depending on scale.</p>
<p><strong>The ROI:</strong> You'll know this was worth it the moment someone asks "who created this resource 6 months ago?" and you actually have an answer.</p>
<hr />
<p><strong>What's your audit logging setup look like?</strong> Are you running on the 90-day default, or have you built something more robust? Reply in the comments or shoot me an email - I'd love to hear how other organizations are handling this.</p>
<p>And if you found this useful, share it with your compliance team. They'll thank you during the next audit cycle.</p>
  </div>

  
  <section class="starter-kit-callout" style="
    max-width: 800px;
    margin: 3rem auto 2rem;
    padding: 2rem;
    border-radius: 12px;
    background: var(--bg-light);
    border: 1px solid var(--border);
    text-align: left;
  ">
    <h3 style="margin-top: 0;">Azure Admin Starter Kit (Free Download)</h3>
    <p style="margin-bottom: 1rem;">
      Get my KQL cheat sheet, 50 Windows + 50 Linux commands, and an Azure RACI template in one free bundle.
    </p>
    <a href="/blog/starter-kit/" class="btn">Get the Starter Kit ‚Üí</a>
  </section>

  
  <aside class="email-capture" style="max-width: 800px; margin: 4rem auto; padding: 3rem; background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%); border-radius: 12px; text-align: center; color: white;">
    <h3 style="margin-top: 0; color: white; font-size: 1.75rem;">Get Azure operational guides in your inbox</h3>
    <p style="margin: 1rem 0 2rem; font-size: 1.1rem; color: white;">Weekly tips from managing 44 Azure subscriptions. No marketing BS.</p>
    
    <form action="https://app.kit.com/forms/8896829/subscriptions" method="post" style="max-width: 500px; margin: 0 auto; display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
      <input type="email" 
             name="email_address" 
             placeholder="your@email.com" 
             required 
             style="flex: 1; min-width: 250px; padding: 0.875rem 1rem; border: none; border-radius: 8px; font-size: 1rem; color: #333;">
      <button type="submit" 
              style="padding: 0.875rem 2rem; background: white; color: #0078d4; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; white-space: nowrap; font-size: 1rem; transition: all 0.2s;">
        Subscribe
      </button>
    </form>
    
    <p style="margin: 1.5rem 0 0; font-size: 0.9rem; opacity: 0.9; color: white;">
      Join 500+ Azure admins. Unsubscribe anytime.
    </p>
  </aside>

  
  
  <aside class="related-posts" style="max-width: 800px; margin: 3rem auto; padding: 2rem; background: var(--bg-light); border-radius: 12px;">
    <h3 style="margin-top: 0;">Related Posts</h3>
    <ul style="list-style: none; padding: 0;">
      
      <li style="margin: 1rem 0;">
        <a href="/blog/azqr-persistent-dashboard" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Building a Persistent Azure Operations Dashboard (AZQR + App Service + Storage)</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-12-17</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="/blog/azure-tags-operational-intelligence" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Azure Tags for Operational Intelligence: How We Answer Executive Questions in 30 Seconds Instead of 3 Days</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-12-17</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="/blog/azure-migrate-certificate-18-month-limit" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Azure Migrate&#39;s 18-Month Data Deletion: The Enterprise Migration Timer Microsoft Calls &#39;Expected Behavior&#39;</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-12-16</span>
        </a>
      </li>
      
    </ul>
  </aside>
  

  
  
  
    <!-- CTA: KQL Query Library -->
<div class="cta-block" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 2rem; border-radius: 8px; margin: 3rem 0; text-align: center; color: white;">
  <h3 style="margin: 0 0 1rem; font-size: 1.75rem; color: white;">üìä Stop Rewriting the Same KQL Queries</h3>
  <p style="margin: 0 0 1.5rem; font-size: 1.1rem; line-height: 1.6;">
    Get <strong>45+ production-ready KQL queries</strong> for Azure Resource Graph, Log Analytics, and Activity Logs.
    Copy-paste ready with comments and business context.
  </p>
  <a href="/static/downloads/KQL-Query-Library-Complete.pdf" 
     download
     style="display: inline-block; padding: 0.75rem 2rem; background: white; color: #f5576c; text-decoration: none; border-radius: 6px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;"
     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)'"
     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
    Download Complete Query Library
  </a>
  <p style="margin: 1rem 0 0; font-size: 0.9rem; opacity: 0.9;">
    PDF format ‚Ä¢ No email required ‚Ä¢ Instant download
  </p>
</div>
  

  
  <nav class="post-nav">
    
      <a href="/blog/not-renewing-azure-certs-choosing-ai-102">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">‚Üê Previous</span>
        <strong>I&#39;m Not Renewing My Azure Certifications. Here&#39;s Why I&#39;m Getting AI-102 Instead.</strong>
      </a>
    
    
      <a href="/blog/tenable-says-remove-dotnet6" style="text-align: right;">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Next ‚Üí</span>
        <strong>Security Found .NET 6 on 47 VMs. Now I&#39;m Supposed to Remove It. Here&#39;s Why That&#39;s Impossible.</strong>
      </a>
    
  </nav>

</article>

    </div>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025 Azure Noob ‚Äî Don&#39;t be a Noob</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem;">
        <a href="/rss.xml" title="Subscribe via RSS">RSS Feed</a> ¬∑ 
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
      </p>
      <p style="margin-top: 1.5rem; font-size: 0.85rem; opacity: 0.7; font-style: italic;">
        "Trust in the Lord with all your heart, and lean not on your own understanding;<br>
        in all your ways acknowledge Him, and He will make your paths straight" ‚Äî Proverbs 3:5-6
      </p>
    </div>
  </footer>

  <!-- Copy code functionality -->
  <script src="/static/copy-code.js"></script>

  <!-- Exit-Intent Popup -->
  <div id="exit-popup" class="exit-popup" style="display: none;">
    <div class="exit-popup-content">
      <button class="exit-popup-close" onclick="closeExitPopup()">&times;</button>
      <h2>Wait! Before You Go...</h2>
      <p class="exit-popup-subtitle">Get the <strong>FREE Azure Admin Starter Kit</strong></p>
      <ul class="exit-popup-benefits">
        <li>‚úì 15 Essential KQL Queries</li>
        <li>‚úì 50 Windows Commands</li>
        <li>‚úì 50 Linux Commands</li>
      </ul>
      <form id="exit-popup-form" class="exit-popup-form">
        <input type="email" id="popup-email" placeholder="Enter your email" required>
        <button type="submit" class="exit-popup-submit">Send Me The Free Kit</button>
      </form>
      <p class="exit-popup-privacy">We'll also notify you about new tools & guides. Unsubscribe anytime.</p>
    </div>
  </div>

  <style>
  .exit-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .exit-popup-content {
    background: white;
    padding: 2.5rem;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .exit-popup-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #999;
    line-height: 1;
  }

  .exit-popup-close:hover {
    color: #333;
  }

  .exit-popup h2 {
    margin: 0 0 0.5rem 0;
    color: #0078d4;
    font-size: 2rem;
  }

  .exit-popup-subtitle {
    font-size: 1.2rem;
    margin: 0 0 1.5rem 0;
  }

  .exit-popup-benefits {
    list-style: none;
    padding: 0;
    margin: 1.5rem 0;
  }

  .exit-popup-benefits li {
    padding: 0.5rem 0;
    font-size: 1.1rem;
  }

  .exit-popup-form {
    margin: 1.5rem 0;
  }

  .exit-popup-form input[type="email"] {
    width: 100%;
    padding: 1rem;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    margin-bottom: 1rem;
  }

  .exit-popup-form input[type="email"]:focus {
    outline: none;
    border-color: #0078d4;
  }

  .exit-popup-submit {
    width: 100%;
    padding: 1rem 2rem;
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }

  .exit-popup-submit:hover {
    background: #005a9e;
  }

  .exit-popup-privacy {
    font-size: 0.85rem;
    color: #666;
    margin-top: 1rem;
    text-align: center;
  }
  </style>

  <script>
  // Exit-intent detection
  let exitPopupShown = false;
  let mouseY = 0;

  document.addEventListener('mousemove', (e) => {
    mouseY = e.clientY;
  });

  document.addEventListener('mouseout', (e) => {
    // If mouse leaves through top of viewport and popup hasn't been shown
    if (!exitPopupShown && e.clientY <= 0 && mouseY <= 100) {
      // Check if user has seen it before (session storage)
      if (!sessionStorage.getItem('exitPopupSeen')) {
        showExitPopup();
      }
    }
  });

  function showExitPopup() {
    exitPopupShown = true;
    document.getElementById('exit-popup').style.display = 'flex';
    sessionStorage.setItem('exitPopupSeen', 'true');
  }

  function closeExitPopup() {
    document.getElementById('exit-popup').style.display = 'none';
  }

  // Handle form submission
  document.getElementById('exit-popup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('popup-email').value;
    
    // Send to ConvertKit (we'll set this up next)
    try {
      // For now, just close and redirect
      closeExitPopup();
      
      // Track in Google Analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'signup', {
          'event_category': 'email',
          'event_label': 'exit_popup',
          'value': email
        });
      }
      
      // Redirect to starter kit page
      window.location.href = '/blog/starter-kit/';
      
    } catch (error) {
      console.error('Error:', error);
      // Still redirect even if tracking fails
      window.location.href = '/blog/starter-kit/';
    }
  });

  // Close on background click
  document.getElementById('exit-popup').addEventListener('click', (e) => {
    if (e.target.id === 'exit-popup') {
      closeExitPopup();
    }
  });
  </script>
</body>
</html>