<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  

  <!-- Primary SEO -->
  <title>Azure Noob</title>
  <meta name="description" content="Don&#39;t be a Noob">
  <link rel="canonical" href="https://azure-noob.com" />

  <!-- Favicons -->
  <link rel="icon" href="../../static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Azure Noob">
  <meta property="og:description" content="Don&#39;t be a Noob">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://azure-noob.com">
  <meta property="og:image" content="../../static/images/hero/cloud-wars.png">

  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Azure Noob">
  <meta name="twitter:description" content="Don&#39;t be a Noob">
  <meta name="twitter:image" content="../../static/images/hero/cloud-wars.png">

  <!-- Styles -->
  <link rel="stylesheet" href="../../static/styles.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="../../index.html" class="brand-link">
          <img src="../../static/images/logo.png" alt="Azure Noob logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong>Azure Noob</strong>
        </span>
      </div>
      <nav class="nav">
        <a href="../../index.html">Home</a>
        <a href="../index.html">Blog</a>
        <a href="../../about/index.html">About</a>
        <a href="../../tags/index.html">Tags</a>
        <a href="../../search/index.html">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      
<article class="post">

  
  
    
    <div class="hero">
      <img src="../../static/images/hero/azure-audit-gap.png" alt="The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit">
    </div>
  

  <header class="post-header">
    <h1>The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit</h1>
    <p class="muted">
      2025-10-26 ¬∑ ~29 min read
    </p>
    
    
    <ul class="tags-list">
      
      <li><a href="../../tags/Azure/index.html" class="tag-badge">Azure</a></li>
      
      <li><a href="../../tags/Compliance/index.html" class="tag-badge">Compliance</a></li>
      
      <li><a href="../../tags/Auditing/index.html" class="tag-badge">Auditing</a></li>
      
      <li><a href="../../tags/KQL/index.html" class="tag-badge">KQL</a></li>
      
      <li><a href="../../tags/Security/index.html" class="tag-badge">Security</a></li>
      
      <li><a href="../../tags/Governance/index.html" class="tag-badge">Governance</a></li>
      
    </ul>
    
    
    
      <p class="summary">Most Azure environments are silently non-compliant with regulatory audit requirements. Here&#39;s the three-part problem everyone faces, how app registrations create blind spots, and the architecture to fix it before your next audit.</p>
    
  </header>

  
  <p class="post-actions" style="margin:.5rem 0 0; text-align: center;">
    <button class="btn"
            onclick="window.print(); return false;"
            title="Print this page"
            aria-label="Print this page"
            style="cursor: pointer; background: none; border: 2px solid var(--azure-blue);">
      üñ®Ô∏è Print this page
    </button>
  </p>

  
  <div class="post-body">
    <h2>The Question That Starts the Panic</h2>
<p>"Who created this storage account three months ago?"</p>
<p>You're sitting in a meeting. Security is investigating potential data exposure. Leadership wants answers. You confidently open Azure Portal, navigate to Activity Logs, and...</p>
<p><strong>The data is gone.</strong></p>
<p>Azure Activity Logs keep 90 days by default. Your regulatory requirements demand 5-7 years. And this moment - when you realize you can't answer basic audit questions - is how most organizations discover they're silently non-compliant.</p>
<h2>The Three-Part Audit Problem</h2>
<p>Let me break down what's actually happening in most Azure environments:</p>
<h3>Part 1: Do You HAVE the Logs?</h3>
<p>This is about retention configuration. Out of the box, Azure gives you:</p>
<ul>
<li><strong>Activity Logs (ARM resources):</strong> 90 days in the portal</li>
<li><strong>Azure AD Audit Logs:</strong> 30 days in the portal</li>
<li><strong>That's it.</strong></li>
</ul>
<p>Meanwhile, regulatory frameworks demand:<br />
- <strong>SOX:</strong> 7 years<br />
- <strong>HIPAA:</strong> 6 years<br />
- <strong>GDPR:</strong> Varies by data category<br />
- <strong>PCI-DSS:</strong> 1 year online, 3 years archive<br />
- <strong>State regulations:</strong> Often 5-7 years</p>
<p><strong>The gap:</strong> You're configured for 90 days, but legally required to keep 5-7 years. Most organizations don't discover this until they're asked to produce logs they don't have.</p>
<h3>Part 2: Do You KNOW WHERE the Logs Are?</h3>
<p>Even if you've configured log retention properly, there's a documentation problem. Your logs might be scattered across:</p>
<ul>
<li>Activity Logs in the portal (90 days)</li>
<li>Log Analytics Workspace (configured retention, maybe 30-730 days)</li>
<li>Storage Account archive (hopefully years)</li>
<li>Azure Monitor diagnostic settings (per-resource configuration)</li>
<li>Azure AD Audit Logs (separate system entirely)</li>
</ul>
<p>When the auditor asks "show me who accessed this storage account in Q2 2023," can you immediately answer:<br />
1. WHERE that data lives?<br />
2. HOW to query it?<br />
3. WHO has access to retrieve it?</p>
<p>Most teams spend 4 hours scrambling to find WHERE the data is before they can even start answering the actual question.</p>
<h3>Part 3: Can You QUERY the Logs?</h3>
<p>You've exported logs to a Log Analytics Workspace. Great! Now what?</p>
<p>You need to:<br />
- Know KQL (Kusto Query Language)<br />
- Understand the schema differences between Activity Logs and Azure AD logs<br />
- Build custom queries for common audit scenarios<br />
- Document those queries so you're not rebuilding them every audit cycle</p>
<p><strong>The reality:</strong> Most organizations have configured retention (Part 1), but lack the query skills (Part 3) to actually extract answers when needed.</p>
<h2>The Two Separate Audit Systems</h2>
<p>Here's what trips up most Azure admins: <strong>You're not dealing with one audit system. You're dealing with two.</strong></p>
<h3>System 1: Azure Activity Logs (ARM Resources)</h3>
<p>This covers your ARM resources:<br />
- Virtual machines<br />
- Storage accounts<br />
- Virtual networks<br />
- Key vaults<br />
- Managed disks<br />
- Resource groups</p>
<p><strong>Where it lives:</strong> Azure Resource Manager (ARM) / Azure Monitor<br />
<strong>Query tool:</strong> Resource Graph (for resources) + Log Analytics (for activity)<br />
<strong>Retention default:</strong> 90 days in portal</p>
<h3>System 2: Azure AD Audit Logs (Identity Resources)</h3>
<p>This covers your identity layer:<br />
- App registrations<br />
- Service principals<br />
- Enterprise applications<br />
- User sign-ins<br />
- Admin consent grants<br />
- Role assignments</p>
<p><strong>Where it lives:</strong> Azure Active Directory / Microsoft Entra ID<br />
<strong>Query tool:</strong> Microsoft Graph API or Log Analytics (if exported)<br />
<strong>Retention default:</strong> 30 days in portal</p>
<p><strong>The problem:</strong> Most people only monitor ONE of these systems and completely miss the other.</p>
<h2>The App Registration Blind Spot</h2>
<p>Let me tell you about the alert that drives every Azure admin crazy:</p>
<p><strong>Tenable Scanner Alert:</strong> "Unused app registration detected with client secret expiring in 30 days"</p>
<p>You get 50 of these every month. And every single one triggers the same questions:<br />
- Who created this app registration?<br />
- What does it do?<br />
- Is it still being used?<br />
- Who owns it?</p>
<p>Here's why these alerts are so painful:</p>
<h3>App Registrations Can't Be Tagged</h3>
<p>App registrations are <strong>NOT ARM resources</strong>. They're Azure AD objects.</p>
<p>That means:<br />
- ‚ùå No tags (can't apply Cost Center, Owner, Environment tags)<br />
- ‚ùå No Resource Graph support (can't query them with KQL in Resource Graph)<br />
- ‚ùå Different audit system (Azure AD logs, not Activity Logs)<br />
- ‚ùå Different API (Microsoft Graph, not Azure Resource Manager)</p>
<h3>The Ownership Problem</h3>
<p>When you create a VM, you can tag it: <code>Owner: john.doe@company.com</code></p>
<p>When you create an app registration, you get:<br />
- A GUID<br />
- A display name (if they bothered to make it descriptive)<br />
- Maybe a description (if you're lucky)<br />
- An "Owners" field... that's often empty</p>
<p>Three months later, when security asks "who created this?", you're digging through Azure AD audit logs hoping the data is still there.</p>
<h3>The Real-World Scenario</h3>
<p><strong>Security Team Email:</strong> "We found an app registration 'MyApp-Test-042' with a client secret expiring in 2 days. Is this still needed?"</p>
<p>Your investigation process:<br />
1. Search Azure AD Audit Logs (hoping it's within 30 days)<br />
2. Find the creation event (maybe)<br />
3. Look up the user who created it (probably someone who left 6 months ago)<br />
4. Search Slack/Teams for any mention of 'MyApp-Test-042' (desperate times)<br />
5. Ask around until someone recognizes it (maybe)<br />
6. Make a judgment call (coin flip)</p>
<p><strong>This happens every single day in large Azure environments.</strong></p>
<h2>The Day-to-Day Pain Points</h2>
<p>Let me show you the questions you get constantly and why they're so painful to answer:</p>
<h3>Question 1: "Who created this resource?"</h3>
<p><strong>Scenario:</strong> A storage account appears in a production resource group. Nobody recognizes it. Leadership wants to know who created it and why.</p>
<p><strong>The pain:</strong><br />
- Check Activity Logs ‚Üí Only goes back 90 days, creation was 4 months ago<br />
- Check Resource Tags ‚Üí No Owner tag applied<br />
- Check Resource creation logs ‚Üí Not exported to Log Analytics<br />
- <strong>Answer:</strong> "I don't know. The logs are gone."</p>
<h3>Question 2: "Who accessed this storage account?"</h3>
<p><strong>Scenario:</strong> Compliance asks for a list of everyone who accessed a specific storage account during Q2 2024 for audit documentation.</p>
<p><strong>The pain:</strong><br />
- Activity Logs show ARM operations (create, delete, update) but not data plane access<br />
- Storage Analytics logs are separate and may not be enabled<br />
- Diagnostic settings might not be configured<br />
- <strong>Answer:</strong> "Let me get back to you... tomorrow... maybe."</p>
<h3>Question 3: "What did John Doe create before he left?"</h3>
<p><strong>Scenario:</strong> Employee departed 6 months ago. ITSM ticket: Remove all resources created by john.doe@company.com</p>
<p><strong>The pain:</strong><br />
- Activity Logs only go back 90 days<br />
- Resource Graph shows current owners (tags) but not who created resources<br />
- No historical audit trail unless exported<br />
- <strong>Answer:</strong> "I can show you resources he currently owns, but not everything he created."</p>
<h3>Question 4: "Who granted admin consent to this app registration?"</h3>
<p><strong>Scenario:</strong> Security scan finds an app with excessive permissions. Need to track down who approved it and why.</p>
<p><strong>The pain:</strong><br />
- App registrations are in Azure AD, not ARM<br />
- Requires Azure AD Audit Logs (30-day default retention)<br />
- If it happened 31 days ago, the data is gone<br />
- <strong>Answer:</strong> "The audit log doesn't go back that far."</p>
<h3>Question 5: "Is this app registration still being used?"</h3>
<p><strong>Scenario:</strong> 50 app registrations flagged by Tenable. Security wants to delete unused ones.</p>
<p><strong>The pain:</strong><br />
- No built-in "last used" metric for app registrations<br />
- Sign-in logs might show service principal activity<br />
- No correlation between client secret and actual usage<br />
- <strong>Answer:</strong> "We'd have to monitor sign-in logs for 30-90 days to be sure."</p>
<p><strong>The pattern:</strong> You spend 4 hours scrambling to find WHERE the data is, then realize it doesn't exist or isn't accessible.</p>
<h2>The Solution Architecture</h2>
<p>Here's how to fix this before your next audit. This is not theoretical - this is what I've implemented in production handling SOX compliance.</p>
<h3>Step 1: Configure Log Export</h3>
<p>You need to export logs from their 30/90-day defaults to long-term storage.</p>
<h4>Export Activity Logs to Log Analytics</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create or identify your Log Analytics Workspace</span>
<span class="nv">$workspaceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;audit-logs-workspace&quot;</span>
<span class="nv">$resourceGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;governance-rg&quot;</span>
<span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eastus&quot;</span>

<span class="c1"># Create workspace if it doesn&#39;t exist</span>
az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace-name<span class="w"> </span><span class="nv">$workspaceName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--location<span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--retention-time<span class="w"> </span><span class="m">730</span><span class="w">  </span><span class="c1"># 2 years retention in LAW</span>
</code></pre></div>

<h4>Configure Diagnostic Settings for Activity Logs</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Export subscription-level Activity Logs to Log Analytics</span>
<span class="nv">$subscriptionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>
<span class="nv">$workspaceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>show<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace-name<span class="w"> </span><span class="nv">$workspaceName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>

az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="s2">&quot;export-activity-logs&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--workspace<span class="w"> </span><span class="nv">$workspaceId</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Administrative&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Security&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;ServiceHealth&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Alert&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Recommendation&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Policy&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Autoscale&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    },</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;ResourceHealth&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true</span>
<span class="s1">    }</span>
<span class="s1">  ]&#39;</span>
</code></pre></div>

<h4>Export Azure AD Audit Logs</h4>
<p>This requires Azure AD Premium P1 or P2 licensing.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Configure Azure AD diagnostic settings via Portal or API</span>
<span class="c1"># Navigate to: Azure AD &gt; Diagnostic settings &gt; Add diagnostic setting</span>
<span class="c1"># Select:</span>
<span class="c1"># - AuditLogs (who did what in Azure AD)</span>
<span class="c1"># - SignInLogs (authentication events)</span>
<span class="c1"># - NonInteractiveUserSignInLogs (service principal activity)</span>
<span class="c1"># - ServicePrincipalSignInLogs (app registration usage)</span>
<span class="c1"># - ManagedIdentitySignInLogs (managed identity activity)</span>

<span class="c1"># Destination: Same Log Analytics Workspace</span>
</code></pre></div>

<p><strong>PowerShell equivalent:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Connect to Azure AD</span>
<span class="nb">Connect-AzureAD</span>

<span class="c"># Get the Log Analytics Workspace resource ID</span>
<span class="nv">$workspaceResourceId</span> <span class="p">=</span> <span class="s2">&quot;/subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.OperationalInsights/workspaces/$workspaceName&quot;</span>

<span class="c"># Configure diagnostic settings for Azure AD</span>
<span class="c"># Note: This requires Microsoft.Graph PowerShell module</span>
<span class="nb">Install-Module</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Graph</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span>
<span class="nb">Connect-MgGraph</span> <span class="n">-Scopes</span> <span class="s2">&quot;AuditLog.Read.All&quot;</span><span class="p">,</span> <span class="s2">&quot;Directory.Read.All&quot;</span>

<span class="c"># Create diagnostic setting</span>
<span class="nv">$params</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;export-azuread-logs&quot;</span>
    <span class="n">WorkspaceId</span> <span class="p">=</span> <span class="nv">$workspaceResourceId</span>
    <span class="n">Logs</span> <span class="p">=</span> <span class="p">@(</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;AuditLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;SignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;NonInteractiveUserSignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;ServicePrincipalSignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">@{</span> <span class="n">Category</span> <span class="p">=</span> <span class="s2">&quot;ManagedIdentitySignInLogs&quot;</span><span class="p">;</span> <span class="n">Enabled</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c"># Apply at tenant level</span>
<span class="nb">New-MgBetaDiagnosticSetting</span> <span class="n">-BodyParameter</span> <span class="nv">$params</span>
</code></pre></div>

<h4>Export to Storage Account for Long-Term Archive</h4>
<p>Log Analytics is great for querying (30-730 days), but expensive for 7-year retention. Use Storage Accounts for cheap archive.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create storage account for audit archive</span>
<span class="nv">$storageAccountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;auditarchive</span><span class="k">$(</span>Get-Random<span class="k">)</span><span class="s2">&quot;</span>
az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--location<span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--sku<span class="w"> </span>Standard_LRS<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--kind<span class="w"> </span>StorageV2<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--access-tier<span class="w"> </span>Cool<span class="w">  </span><span class="c1"># Cool tier for infrequent access</span>

<span class="c1"># Get storage account resource ID</span>
<span class="nv">$storageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="o">)</span>

<span class="c1"># Update diagnostic settings to include storage</span>
az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--name<span class="w"> </span><span class="s2">&quot;export-activity-logs-storage&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--storage-account<span class="w"> </span><span class="nv">$storageId</span><span class="w"> </span><span class="sb">`</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {</span>
<span class="s1">      &quot;category&quot;: &quot;Administrative&quot;,</span>
<span class="s1">      &quot;enabled&quot;: true,</span>
<span class="s1">      &quot;retentionPolicy&quot;: {</span>
<span class="s1">        &quot;enabled&quot;: true,</span>
<span class="s1">        &quot;days&quot;: 2555</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  ]&#39;</span>
</code></pre></div>

<p><strong>Cost breakdown:</strong><br />
- Log Analytics: ~$2.50 per GB ingested + $0.12 per GB retention per month<br />
- Storage Account (Cool tier): ~$0.01 per GB per month<br />
- <strong>For 7-year retention:</strong> Storage is 95% cheaper than Log Analytics</p>
<h3>Step 2: Build Your Query Library</h3>
<p>You need pre-built KQL queries for common audit scenarios. Don't rebuild these every time.</p>
<h4>Query 1: Who Created This Resource?</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Find who created a specific resource by name</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;MICROSOFT.RESOURCES/DEPLOYMENTS/WRITE&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="k">or</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;CREATE&quot;</span>
<span class="w">    </span><span class="k">or</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;WRITE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResourceId</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;your-resource-name&quot;</span><span class="w">  </span><span class="c">// Replace with actual resource name</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span><span class="w">  </span><span class="c">// Who did it</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span><span class="w">  </span><span class="c">// What was created</span>
<span class="w">    </span><span class="n">OperationNameValue</span><span class="p">,</span><span class="w">  </span><span class="c">// What action</span>
<span class="w">    </span><span class="n">ActivityStatusValue</span><span class="p">,</span><span class="w">  </span><span class="c">// Success/Failure</span>
<span class="w">    </span><span class="n">Claims</span><span class="w">  </span><span class="c">// Full identity context</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
<span class="p">|</span><span class="w"> </span><span class="k">take</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>

<h4>Query 2: All Actions by a Specific User</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Find everything a user did (useful for offboarding investigations)</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Caller</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;john.doe@company.com&quot;</span><span class="w">  </span><span class="c">// Replace with actual user</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span><span class="w">  </span><span class="c">// Adjust time range as needed</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span>
<span class="w">    </span><span class="n">OperationNameValue</span><span class="p">,</span>
<span class="w">    </span><span class="n">ActivityStatusValue</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 3: Resource Deletions</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track all resource deletions (critical for audit trails)</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationNameValue</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">OperationNameValue</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 4: Who Granted Admin Consent to an App?</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track admin consent grants (Azure AD Audit Logs)</span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Consent to application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">ConsentedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">Permissions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">modifiedProperties</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">ConsentedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppName</span><span class="p">,</span>
<span class="w">    </span><span class="n">Permissions</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 5: App Registration Creation and Ownership</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track app registration creation (Azure AD Audit Logs)</span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Add application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">AppId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppName</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppId</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h4>Query 6: Service Principal Sign-In Activity</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Check if an app registration is actually being used</span>
<span class="n">AADServicePrincipalSignInLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">AppId</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;your-app-id-guid&quot;</span><span class="w">  </span><span class="c">// Replace with actual App ID</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">SignInCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span>
<span class="w">    </span><span class="n">LastSignIn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">UniqueResources</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcount</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">AppDisplayName</span><span class="p">,</span><span class="w"> </span><span class="n">AppId</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppDisplayName</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppId</span><span class="p">,</span>
<span class="w">    </span><span class="n">SignInCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">LastSignIn</span><span class="p">,</span>
<span class="w">    </span><span class="n">UniqueResources</span>
</code></pre></div>

<h4>Query 7: Storage Account Access (Data Plane)</h4>
<div class="codehilite"><pre><span></span><code><span class="c">// Track who accessed storage account data (requires diagnostic settings on storage)</span>
<span class="n">StorageBlobLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">AccountName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;yourstorageaccount&quot;</span><span class="w">  </span><span class="c">// Replace with actual storage account</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">StatusCode</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="mi">200</span><span class="w">  </span><span class="c">// Successful operations</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">CallerIdentity</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">Identity</span><span class="p">)</span><span class="err">.</span><span class="n">claims</span><span class="err">.</span><span class="n">upn</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">AccessCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span>
<span class="w">    </span><span class="n">LastAccess</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">CallerIdentity</span><span class="p">,</span><span class="w"> </span><span class="n">OperationName</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AccessCount</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h3>Step 3: Document Your Logging Architecture</h3>
<p>Create a one-page reference document that answers:</p>
<p><strong>Audit Log Documentation Template:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh"># Azure Audit Logging Architecture</span>

<span class="gu">## Log Analytics Workspace</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Name:**</span> audit-logs-workspace
<span class="k">-</span><span class="w"> </span><span class="gs">**Resource Group:**</span> governance-rg
<span class="k">-</span><span class="w"> </span><span class="gs">**Retention:**</span> 730 days (2 years)
<span class="k">-</span><span class="w"> </span><span class="gs">**Access:**</span> Security team, Compliance team, IT leadership

<span class="gu">## Storage Account Archive</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Name:**</span> auditarchiveXXXXXX
<span class="k">-</span><span class="w"> </span><span class="gs">**Resource Group:**</span> governance-rg
<span class="k">-</span><span class="w"> </span><span class="gs">**Retention:**</span> 2,555 days (7 years)
<span class="k">-</span><span class="w"> </span><span class="gs">**Access:**</span> Compliance team only (RBAC locked down)

<span class="gu">## What&#39;s Collected</span>

<span class="gu">### Activity Logs (ARM Resources)</span>
<span class="k">-</span><span class="w"> </span>All subscriptions configured with diagnostic settings
<span class="k">-</span><span class="w"> </span>Categories: Administrative, Security, Policy, Alerts
<span class="k">-</span><span class="w"> </span>Retention: 730 days in LAW, 7 years in Storage

<span class="gu">### Azure AD Audit Logs</span>
<span class="k">-</span><span class="w"> </span>AuditLogs (who did what in Azure AD)
<span class="k">-</span><span class="w"> </span>SignInLogs (user authentication)
<span class="k">-</span><span class="w"> </span>ServicePrincipalSignInLogs (app registration usage)
<span class="k">-</span><span class="w"> </span>Retention: 730 days in LAW, 7 years in Storage

<span class="gu">## How to Query</span>

<span class="gu">### Portal Access</span>
<span class="k">1.</span> Navigate to: Log Analytics Workspace &gt; Logs
<span class="k">2.</span> Select &quot;audit-logs-workspace&quot;
<span class="k">3.</span> Use pre-built queries from: [Link to internal wiki/SharePoint]

<span class="gu">### Common Queries</span>
<span class="k">-</span><span class="w"> </span>Who created this resource? ‚Üí Query <span class="ni">#1</span>
<span class="k">-</span><span class="w"> </span>What did user X do? ‚Üí Query <span class="ni">#2</span>
<span class="k">-</span><span class="w"> </span>Resource deletions ‚Üí Query <span class="ni">#3</span>
<span class="k">-</span><span class="w"> </span>App consent grants ‚Üí Query <span class="ni">#4</span>

<span class="gu">## Quarterly Audit Process</span>
<span class="k">1.</span> Compliance team requests specific queries
<span class="k">2.</span> IT runs queries from template library
<span class="k">3.</span> Export results to Excel/CSV
<span class="k">4.</span> Compliance validates and archives

<span class="gu">## Contacts</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**IT Governance:**</span> your-team@company.com
<span class="k">-</span><span class="w"> </span><span class="gs">**Compliance:**</span> compliance@company.com
<span class="k">-</span><span class="w"> </span><span class="gs">**Azure Admin:**</span> azure-admins@company.com
</code></pre></div>

<p><strong>Save this document where your team can find it.</strong> SharePoint, Confluence, internal wiki - wherever you keep runbooks.</p>
<h3>Step 4: External Tracking for App Registrations</h3>
<p>Since app registrations can't be tagged, you need external tracking.</p>
<p><strong>Option 1: Spreadsheet (Quick Start)</strong></p>
<p>Create a simple tracking sheet:</p>
<table>
<thead>
<tr>
<th>App Name</th>
<th>App ID</th>
<th>Created By</th>
<th>Created Date</th>
<th>Purpose</th>
<th>Owner</th>
<th>Status</th>
<th>Last Review</th>
</tr>
</thead>
<tbody>
<tr>
<td>MyApp-Prod</td>
<td>guid</td>
<td>john.doe</td>
<td>2024-03-15</td>
<td>Production API</td>
<td>Jane Smith</td>
<td>Active</td>
<td>2024-10-01</td>
</tr>
<tr>
<td>TestApp-042</td>
<td>guid</td>
<td>old.user</td>
<td>2023-08-22</td>
<td>Testing</td>
<td>Unknown</td>
<td>Review</td>
<td>2024-10-01</td>
</tr>
</tbody>
</table>
<p><strong>Update process:</strong><br />
- New app registration? Add row<br />
- Quarterly review? Update Status and Last Review<br />
- Tenable alert? Check this sheet first</p>
<p><strong>Option 2: CMDB Integration (Enterprise)</strong></p>
<p>If you have a CMDB (ServiceNow, Azure DevOps, Jira), create:<br />
- CI Type: "Azure App Registration"<br />
- Automated sync via Microsoft Graph API<br />
- Link to resource owner records</p>
<p><strong>Option 3: Automation Script</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Export all app registrations to CSV for tracking</span>
<span class="nb">Connect-AzureAD</span>

<span class="nv">$apps</span> <span class="p">=</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-All</span> <span class="nv">$true</span>
<span class="nv">$report</span> <span class="p">=</span> <span class="p">@()</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$app</span> <span class="k">in</span> <span class="nv">$apps</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$owners</span> <span class="p">=</span> <span class="nb">Get-AzureADApplicationOwner</span> <span class="n">-ObjectId</span> <span class="nv">$app</span><span class="p">.</span><span class="n">ObjectId</span>

    <span class="nv">$report</span> <span class="p">+=</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
        <span class="n">DisplayName</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">DisplayName</span>
        <span class="n">AppId</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">AppId</span>
        <span class="n">ObjectId</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">ObjectId</span>
        <span class="n">CreatedDateTime</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">CreatedDateTime</span>
        <span class="n">Owners</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$owners</span><span class="p">.</span><span class="n">UserPrincipalName</span> <span class="n">-join</span> <span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="n">SignInAudience</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">SignInAudience</span>
        <span class="n">PublisherDomain</span> <span class="p">=</span> <span class="nv">$app</span><span class="p">.</span><span class="n">PublisherDomain</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$report</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="s2">&quot;app-registrations-inventory.csv&quot;</span> <span class="n">-NoTypeInformation</span>

<span class="nb">Write-Host</span> <span class="s2">&quot;Exported </span><span class="p">$(</span><span class="nv">$report</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> app registrations to CSV&quot;</span>
</code></pre></div>

<p>Run this monthly. Compare to last month's export. Flag new apps without owners.</p>
<h3>Step 5: Test Quarterly (Audit Drills)</h3>
<p>Don't wait for a real audit to discover your logging is broken. Run drills.</p>
<p><strong>Quarterly Audit Drill Checklist:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh"># Q4 2025 Audit Drill</span>

<span class="gu">## Test Date: October 26, 2025</span>
<span class="gu">## Tester: [Your Name]</span>

<span class="gu">### Test 1: Log Retention Verification</span>
<span class="k">- [ ]</span> Verify Activity Logs retention: Query logs from 90+ days ago
<span class="k">- [ ]</span> Verify Azure AD logs retention: Query AuditLogs from 30+ days ago
<span class="k">- [ ]</span> Verify Storage Account archive: Check oldest logs in storage
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 2: Query Execution</span>
<span class="k">- [ ]</span> Run Query <span class="ni">#1:</span> Who created resource X? (pick random VM)
<span class="k">- [ ]</span> Run Query <span class="ni">#2:</span> What did user Y do? (pick random user)
<span class="k">- [ ]</span> Run Query <span class="ni">#4:</span> Recent admin consent grants
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 3: Documentation Access</span>
<span class="k">- [ ]</span> Locate audit documentation
<span class="k">- [ ]</span> Verify links to Log Analytics Workspace
<span class="k">- [ ]</span> Verify query library is up to date
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 4: App Registration Tracking</span>
<span class="k">- [ ]</span> Open app registration inventory
<span class="k">- [ ]</span> Verify last update date
<span class="k">- [ ]</span> Spot check 5 random apps: do owners match Azure AD?
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">### Test 5: Access Verification</span>
<span class="k">- [ ]</span> Confirm compliance team has LAW access
<span class="k">- [ ]</span> Confirm storage account access is restricted
<span class="k">- [ ]</span> Verify audit log export is still running
<span class="k">- [ ]</span> <span class="gs">**Result:**</span> Pass/Fail + Notes

<span class="gu">## Issues Found:</span>
[List any issues discovered during drill]

<span class="gu">## Action Items:</span>
<span class="k">- [ ]</span> Fix issue <span class="ni">#1</span>
<span class="k">- [ ]</span> Update documentation
<span class="k">- [ ]</span> Retest in 30 days

<span class="gu">## Next Drill: January 26, 2026</span>
</code></pre></div>

<p><strong>Why quarterly?</strong> <br />
- Catches configuration drift before audit season<br />
- Validates your team knows where logs are<br />
- Proves your retention is actually working</p>
<h2>What This Looks Like in Production</h2>
<p>Let me show you what this setup looks like at scale.</p>
<h3>Enterprise Bank Example (SOX Compliance)</h3>
<p><strong>Environment:</strong><br />
- 40+ Azure subscriptions<br />
- Multiple Active Directory domains (consolidation project)<br />
- 300+ applications<br />
- SOX audit requirement: 7 years</p>
<p><strong>What was implemented:</strong></p>
<ol>
<li><strong>Centralized Log Analytics Workspace</strong></li>
<li>One workspace for all subscriptions</li>
<li>730-day retention (balancing cost vs query access)</li>
<li>
<p>Configured via Azure Policy (automatic for new subscriptions)</p>
</li>
<li>
<p><strong>Storage Account Archive</strong></p>
</li>
<li>Separate storage account per compliance zone</li>
<li>7-year retention</li>
<li>Immutable storage (WORM) for tamper-proof logs</li>
<li>
<p>Lifecycle management (auto-archive to Cool tier after 90 days)</p>
</li>
<li>
<p><strong>Query Library</strong></p>
</li>
<li>25 pre-built queries for common audit scenarios</li>
<li>Stored in internal wiki with examples</li>
<li>
<p>Updated quarterly based on actual audit requests</p>
</li>
<li>
<p><strong>App Registration Tracking</strong></p>
</li>
<li>CSV export automated monthly via Azure Automation</li>
<li>Stored in SharePoint with version history</li>
<li>Quarterly review with security team</li>
<li>
<p>Tenable alerts cross-referenced against this inventory</p>
</li>
<li>
<p><strong>Azure Policy Enforcement</strong></p>
</li>
<li>Diagnostic settings automatically applied to new subscriptions</li>
<li>Activity Log export mandatory via policy</li>
<li>Storage account lifecycle management enforced</li>
</ol>
<p><strong>Cost:</strong><br />
- Log Analytics: ~$800/month (all subscriptions)<br />
- Storage Account: ~$50/month (7 years of logs)<br />
- <strong>Total:</strong> ~$850/month for complete audit compliance</p>
<p><strong>ROI:</strong><br />
- First SOX audit: 4 hours to produce all requested logs (vs. weeks previously)<br />
- Security incidents: Immediate answers to "who did what when"<br />
- Offboarding: Complete audit trail of departed employee actions</p>
<h3>Small Environment Example (Startup, 1-3 Subscriptions)</h3>
<p>Don't overthink it if you're small. Start simple:</p>
<p><strong>Minimum Viable Setup:</strong></p>
<ol>
<li><strong>One Log Analytics Workspace</strong></li>
<li>90-day retention (free tier: 5GB/month)</li>
<li>Activity Logs exported from all subscriptions</li>
<li>
<p>Azure AD logs exported (requires Azure AD Premium P1)</p>
</li>
<li>
<p><strong>One Storage Account</strong></p>
</li>
<li>Standard LRS, Cool tier</li>
<li>
<p>1-year retention (extend as budget allows)</p>
</li>
<li>
<p><strong>Five Core Queries</strong></p>
</li>
<li>Who created this?</li>
<li>What did this user do?</li>
<li>Resource deletions</li>
<li>Admin consent grants</li>
<li>
<p>App registration creation</p>
</li>
<li>
<p><strong>Simple App Tracking</strong></p>
</li>
<li>Excel spreadsheet</li>
<li>Updated when Tenable alerts fire</li>
<li>Quarterly manual review</li>
</ol>
<p><strong>Cost:</strong><br />
- Log Analytics: $0-50/month (depending on log volume)<br />
- Storage Account: $5-10/month<br />
- <strong>Total:</strong> ~$60/month or less</p>
<p><strong>When to upgrade:</strong><br />
- Growing past 5 subscriptions ‚Üí Enforce with Azure Policy<br />
- Getting audited ‚Üí Extend retention to match requirements<br />
- Multiple teams ‚Üí Add RBAC and centralized governance</p>
<h2>The Business Case for Leadership</h2>
<p>If you need budget approval, here's your talking points:</p>
<h3>The Risk (What Happens If We Don't)</h3>
<p><strong>Scenario 1: Failed Audit</strong><br />
- Auditor requests logs from 18 months ago<br />
- You can't produce them (90-day default)<br />
- <strong>Result:</strong> Audit finding, potential compliance penalty, reputational damage</p>
<p><strong>Scenario 2: Security Incident</strong><br />
- Breach detected, forensics team needs 6 months of logs<br />
- Activity Logs only go back 90 days<br />
- <strong>Result:</strong> Can't determine scope of breach, can't identify entry point, liability exposure</p>
<p><strong>Scenario 3: Offboarding Investigation</strong><br />
- Employee leaves, manager wants to know what they had access to<br />
- No historical audit trail<br />
- <strong>Result:</strong> 40 hours of manual investigation, incomplete results</p>
<h3>The Cost (What It Actually Takes)</h3>
<p><strong>Setup:</strong><br />
- Engineering time: 8-16 hours (one-time)<br />
- Monthly cost: $50-1,000 depending on scale<br />
- Quarterly testing: 2 hours per quarter</p>
<p><strong>ROI:</strong><br />
- First audit: 80% time savings (hours vs. weeks)<br />
- Security incidents: Immediate forensics capability<br />
- Offboarding: 90% time savings (2 hours vs. 40 hours)</p>
<p><strong>Budget ask:</strong><br />
- Small environment: $1,000/year<br />
- Medium environment: $10,000/year<br />
- Enterprise environment: $50,000/year</p>
<p><strong>Comparison:</strong><br />
- One failed audit finding: $50,000-500,000 in remediation + penalties<br />
- One security breach investigation: $100,000+ in consulting fees<br />
- This solution: $1,000-50,000/year</p>
<p><strong>Approval probability: Very high.</strong></p>
<h2>Common Mistakes to Avoid</h2>
<p>I've seen these mistakes repeatedly. Don't repeat them.</p>
<h3>Mistake 1: "We'll Set It Up When We Need It"</h3>
<p><strong>The problem:</strong> By the time you need audit logs, it's too late. You can't retroactively create historical data.</p>
<p><strong>The fix:</strong> Set up retention BEFORE your next audit cycle. If you're audited in Q1 2026, configure this by end of Q4 2025.</p>
<h3>Mistake 2: "We Only Need Activity Logs"</h3>
<p><strong>The problem:</strong> Activity Logs cover ARM resources (VMs, storage). You're missing the entire identity layer (app registrations, consent grants, role assignments).</p>
<p><strong>The fix:</strong> Export BOTH Activity Logs and Azure AD Audit Logs. They're separate systems covering different types of actions.</p>
<h3>Mistake 3: "Log Analytics Retention = Archive"</h3>
<p><strong>The problem:</strong> Log Analytics retention (30-730 days) is great for querying, but expensive for 5-7 year archive requirements.</p>
<p><strong>The fix:</strong> Use Log Analytics for recent logs (90-730 days), then archive to Storage Account for long-term retention. It's 95% cheaper.</p>
<h3>Mistake 4: "We'll Query the Storage Account When Needed"</h3>
<p><strong>The problem:</strong> Querying logs directly from Storage Account is painful. No KQL support, just raw JSON files.</p>
<p><strong>The fix:</strong> Log Analytics for query access (recent logs), Storage Account for compliance archive (old logs you rarely need).</p>
<h3>Mistake 5: "Tagging Solves Everything"</h3>
<p><strong>The problem:</strong> Tags are great for ARM resources, but app registrations can't be tagged. You need separate tracking.</p>
<p><strong>The fix:</strong> External tracking system (spreadsheet, CMDB, automated export) for app registrations. Update it monthly.</p>
<h3>Mistake 6: "Set It and Forget It"</h3>
<p><strong>The problem:</strong> Diagnostic settings get deleted. Log Analytics fills up. Storage accounts get misconfigured. No one notices until the audit.</p>
<p><strong>The fix:</strong> Quarterly audit drills. Test your queries. Verify your retention. Update your documentation.</p>
<h2>The 30-Minute Quick Start</h2>
<p>If you're reading this during an audit crisis, here's your emergency process:</p>
<h3>Hour 1: Verify What You Have</h3>
<div class="codehilite"><pre><span></span><code><span class="c">// Check Activity Log retention</span>
<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">OldestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">NewestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">DaysCovered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime_diff</span><span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">))</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">OldestLog</span><span class="p">,</span><span class="w"> </span><span class="n">NewestLog</span><span class="p">,</span><span class="w"> </span><span class="n">DaysCovered</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c">// Check Azure AD log retention  </span>
<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">OldestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">NewestLog</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">DaysCovered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime_diff</span><span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">))</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">OldestLog</span><span class="p">,</span><span class="w"> </span><span class="n">NewestLog</span><span class="p">,</span><span class="w"> </span><span class="n">DaysCovered</span>
</code></pre></div>

<p><strong>If DaysCovered &lt; 90:</strong> You're running on defaults. You need to configure exports NOW.</p>
<h3>Hour 2: Configure Exports (Emergency Mode)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Quick setup: Export logs to new Log Analytics Workspace</span>
az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span>emergency-audit-rg<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace-name<span class="w"> </span>emergency-audit-logs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--location<span class="w"> </span>eastus<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--retention-time<span class="w"> </span><span class="m">730</span>

<span class="c1"># Get workspace ID</span>
<span class="nv">workspaceId</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>monitor<span class="w"> </span>log-analytics<span class="w"> </span>workspace<span class="w"> </span>show<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span>emergency-audit-rg<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace-name<span class="w"> </span>emergency-audit-logs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>

<span class="c1"># Configure diagnostic settings for current subscription</span>
<span class="nv">subscriptionId</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>account<span class="w"> </span>show<span class="w"> </span>--query<span class="w"> </span>id<span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>
az<span class="w"> </span>monitor<span class="w"> </span>diagnostic-settings<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>emergency-export<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource<span class="w"> </span><span class="s2">&quot;/subscriptions/</span><span class="nv">$subscriptionId</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workspace<span class="w"> </span><span class="nv">$workspaceId</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--logs<span class="w"> </span><span class="s1">&#39;[{&quot;category&quot;:&quot;Administrative&quot;,&quot;enabled&quot;:true}]&#39;</span>
</code></pre></div>

<p><strong>Important:</strong> This only captures NEW logs going forward. You can't recover old logs that already expired.</p>
<h3>Hour 3: Document What You've Done</h3>
<p>Create a one-page summary:<br />
- What logs are being captured NOW<br />
- Where they're going (workspace name, resource group)<br />
- How long we'll keep them (retention setting)<br />
- What logs we DON'T have (date ranges we lost)</p>
<p><strong>Be honest in your audit:</strong> "We discovered a gap in our retention configuration. We've corrected it as of [date]. Historical logs prior to [date] are not available."</p>
<h2>The Takeaway</h2>
<p>Most Azure environments are silently non-compliant with audit requirements because nobody talks about the 90-day default.</p>
<p><strong>The three-part problem:</strong><br />
1. Do you HAVE the logs? (retention configuration)<br />
2. Do you KNOW WHERE they are? (documentation gap)<br />
3. Can you QUERY them? (skills gap)</p>
<p><strong>The solution:</strong><br />
1. Export Activity Logs + Azure AD logs to Log Analytics + Storage<br />
2. Build a query library for common audit scenarios<br />
3. Document your logging architecture<br />
4. Track app registrations externally (they can't be tagged)<br />
5. Test quarterly with audit drills</p>
<p><strong>The cost:</strong> $50-1,000/month depending on scale.</p>
<p><strong>The ROI:</strong> You'll know this was worth it the moment someone asks "who created this resource 6 months ago?" and you actually have an answer.</p>
<hr />
<p><strong>What's your audit logging setup look like?</strong> Are you running on the 90-day default, or have you built something more robust? Reply in the comments or shoot me an email - I'd love to hear how other organizations are handling this.</p>
<p>And if you found this useful, share it with your compliance team. They'll thank you during the next audit cycle.</p>
  </div>

  
  
  <aside class="related-posts" style="max-width: 800px; margin: 3rem auto; padding: 2rem; background: var(--bg-light); border-radius: 12px;">
    <h3 style="margin-top: 0;">Related Posts</h3>
    <ul style="list-style: none; padding: 0;">
      
      <li style="margin: 1rem 0;">
        <a href="../azure-ai-30-day-test/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">I Spent 30 Days Testing Azure AI in a Regulated Environment. Here&#39;s What Actually Works.</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-17</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="../kql-multiple-systems/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">The KQL Problem Nobody Warns You About: You&#39;re Learning One Language Across Five Different Systems</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-24</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="../azure-chargeback-tags-model/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Six Azure Tags That Make Chargeback and Showback Actually Work</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-16</span>
        </a>
      </li>
      
    </ul>
  </aside>
  

  
  <nav class="post-nav">
    
      <a href="../not-renewing-azure-certs-choosing-ai-102/index.html">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">‚Üê Previous</span>
        <strong>I&#39;m Not Renewing My Azure Certifications. Here&#39;s Why I&#39;m Getting AI-102 Instead.</strong>
      </a>
    
    
  </nav>

</article>

    </div>
  </main>

  <!-- EMAIL CAPTURE SECTION -->
  <section class="email-signup" id="subscribe">
    <div class="wrap">
      <h3>Get Azure tips in your inbox</h3>
      <p>Join Azure pros getting practical KQL queries, cost optimization tips, and real-world solutions.</p>
      <script async data-uid="3dfad5c743" src="https://azure-noob.kit.com/3dfad5c743/index.js"></script>
    </div>
  </section>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025 Azure Noob ‚Äî Don&#39;t be a Noob</p>
    </div>
  </footer>

  <!-- Copy code functionality -->
  <script src="../../static/copy-code.js"></script>
</body>
</html>