<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  

  <!-- Primary SEO -->
  <title>Azure Noob</title>
  <meta name="description" content="Don&#39;t be a Noob">
  <link rel="canonical" href="https://azure-noob.com" />

  <!-- Favicons -->
  <link rel="icon" href="../../static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Azure Noob">
  <meta property="og:description" content="Don&#39;t be a Noob">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://azure-noob.com">
  <meta property="og:image" content="../../static/images/hero/cloud-wars.png">

  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Azure Noob">
  <meta name="twitter:description" content="Don&#39;t be a Noob">
  <meta name="twitter:image" content="../../static/images/hero/cloud-wars.png">

  <!-- Styles -->
  <link rel="stylesheet" href="../../static/styles.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="../../index.html" class="brand-link">
          <img src="../../static/images/logo.png" alt="Azure Noob logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong>Azure Noob</strong>
        </span>
      </div>
      <nav class="nav">
        <a href="../../index.html">Home</a>
        <a href="../index.html">Blog</a>
        <a href="../../about/index.html">About</a>
        <a href="../../tags/index.html">Tags</a>
        <a href="../../search/index.html">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      
<article class="post">

  
  
    
    <div class="hero">
      <img src="../../static/images/hero/kql-query-library.svg" alt="Stop Losing Your KQL Queries: The Git-Based Query Library Nobody Told You About">
    </div>
  

  <header class="post-header">
    <h1>Stop Losing Your KQL Queries: The Git-Based Query Library Nobody Told You About</h1>
    <p class="muted">
      2025-10-28 · ~15 min read
    </p>
    
    
    <ul class="tags-list">
      
      <li><a href="../../tags/Azure/index.html" class="tag-badge">Azure</a></li>
      
      <li><a href="../../tags/KQL/index.html" class="tag-badge">KQL</a></li>
      
      <li><a href="../../tags/Operations/index.html" class="tag-badge">Operations</a></li>
      
      <li><a href="../../tags/Git/index.html" class="tag-badge">Git</a></li>
      
      <li><a href="../../tags/Productivity/index.html" class="tag-badge">Productivity</a></li>
      
    </ul>
    
    
    
      <p class="summary">You&#39;ve written the perfect KQL query. Three months later, you can&#39;t find it. Here&#39;s the simple Git workflow that saves me 10+ hours a month searching for queries I already wrote.</p>
    
  </header>

  
  <p class="post-actions" style="margin:.5rem 0 0; text-align: center;">
    <button class="btn"
            onclick="window.print(); return false;"
            title="Print this page"
            aria-label="Print this page"
            style="cursor: pointer; background: none; border: 2px solid var(--azure-blue);">
      🖨️ Print this page
    </button>
  </p>

  
  <div class="post-body">
    <p>Last week, our security team asked: "Show me all resource deletions from August."</p>
<p>I knew I had the perfect query. I wrote it six months ago. It worked great. I just couldn't remember where I saved it.</p>
<p>I checked:<br />
- OneNote (3 different notebooks)<br />
- Slack search (found 5 similar queries, none quite right)<br />
- Email search (found the query I sent to compliance, but it was an old version)<br />
- Browser history (found the Log Analytics workspace, but not the saved query)<br />
- Desktop folder named "temp queries" (12 untitled .txt files)</p>
<p><strong>20 minutes later</strong>, I rewrote the query from scratch. Again.</p>
<p>This is stupid. We use Git for everything else. Why not KQL queries?</p>
<h2>What You're Building</h2>
<p>A Git repository that holds all your KQL queries in organized <code>.kql</code> files. When someone asks "show me X," you:</p>
<ol>
<li>Search by filename: <code>resource-deletions.kql</code></li>
<li>Open in VS Code</li>
<li>Copy to Log Analytics</li>
<li>Run query</li>
<li>Done in 30 seconds</li>
</ol>
<p><strong>Time saved per year:</strong> 10-20 hours (at minimum wage, that's $150-300. At your actual salary, probably $500-1,000.)</p>
<p><strong>Return on investment:</strong> 30 minutes to set up.</p>
<p>No-brainer.</p>
<h2>Prerequisites</h2>
<ul>
<li>VS Code installed</li>
<li>Git repository (GitHub, Azure DevOps, GitLab, whatever)</li>
<li>30 minutes</li>
</ul>
<p><strong>You don't need:</strong><br />
- Special tools<br />
- Azure DevOps boards<br />
- Project management overhead<br />
- Approval workflows</p>
<p>Just files. In Git. That's it.</p>
<h2>Step 1: Install KQL Extension in VS Code (2 minutes)</h2>
<ol>
<li>Open VS Code</li>
<li>Press <code>Ctrl+Shift+X</code> (Extensions)</li>
<li>Search: <code>Kusto</code></li>
<li>Install: <strong>"Kusto (KQL)"</strong> by Microsoft</li>
<li>Reload VS Code</li>
</ol>
<p><strong>You now have:</strong><br />
- Syntax highlighting for <code>.kql</code> files<br />
- IntelliSense (autocomplete)<br />
- Query validation (catches errors before you run)</p>
<h2>Step 2: Create Repository Structure (5 minutes)</h2>
<p>Create a new Git repo or add this to an existing one:</p>
<div class="codehilite"><pre><span></span><code><span class="n">azure</span><span class="o">-</span><span class="n">kql</span><span class="o">-</span><span class="n">queries</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="n">md</span>
<span class="err">├──</span><span class="w"> </span><span class="n">activity</span><span class="o">-</span><span class="n">logs</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">resource</span><span class="o">-</span><span class="n">deletions</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">resource</span><span class="o">-</span><span class="n">creations</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">admin</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">changes</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">policy</span><span class="o">-</span><span class="n">violations</span><span class="p">.</span><span class="n">kql</span>
<span class="err">├──</span><span class="w"> </span><span class="n">azure</span><span class="o">-</span><span class="n">ad</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">app</span><span class="o">-</span><span class="n">registration</span><span class="o">-</span><span class="n">creation</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">consent</span><span class="o">-</span><span class="n">grants</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">failed</span><span class="o">-</span><span class="n">signins</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">user</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">assignments</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">conditional</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">changes</span><span class="p">.</span><span class="n">kql</span>
<span class="err">├──</span><span class="w"> </span><span class="n">cost</span><span class="o">-</span><span class="n">management</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">monthly</span><span class="o">-</span><span class="n">spend</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">subscription</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">top</span><span class="o">-</span><span class="mh">10</span><span class="o">-</span><span class="n">expensive</span><span class="o">-</span><span class="n">resources</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">cost</span><span class="o">-</span><span class="n">anomalies</span><span class="p">.</span><span class="n">kql</span>
<span class="err">├──</span><span class="w"> </span><span class="n">security</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">brute</span><span class="o">-</span><span class="k">force</span><span class="o">-</span><span class="n">detection</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">suspicious</span><span class="o">-</span><span class="n">ips</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">after</span><span class="o">-</span><span class="n">hours</span><span class="o">-</span><span class="n">activity</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">privilege</span><span class="o">-</span><span class="n">escalation</span><span class="p">.</span><span class="n">kql</span>
<span class="err">├──</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">vm</span><span class="o">-</span><span class="n">inventory</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">storage</span><span class="o">-</span><span class="n">account</span><span class="o">-</span><span class="n">inventory</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">untagged</span><span class="o">-</span><span class="n">resources</span><span class="p">.</span><span class="n">kql</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">resources</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">locks</span><span class="p">.</span><span class="n">kql</span>
<span class="err">└──</span><span class="w"> </span><span class="n">compliance</span><span class="o">/</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">soc2</span><span class="o">-</span><span class="n">audit</span><span class="o">-</span><span class="n">trail</span><span class="p">.</span><span class="n">kql</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">pci</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">review</span><span class="p">.</span><span class="n">kql</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">retention</span><span class="o">-</span><span class="n">check</span><span class="p">.</span><span class="n">kql</span>
</code></pre></div>

<p><strong>Folder naming rules:</strong><br />
- Use hyphens, not underscores (<code>activity-logs</code>, not <code>activity_logs</code>)<br />
- Lowercase everything<br />
- Group by Azure service or use case (not by date or person)</p>
<h2>Step 3: Query File Template (5 minutes)</h2>
<p>Every <code>.kql</code> file should start with this header:</p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: Resource Deletions (Last 90 Days)</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Find all successfully deleted resources for quarterly audit review</span>
<span class="c">// </span>
<span class="c">// Use Cases:</span>
<span class="c">//   - Quarterly access review (required by SOC 2)</span>
<span class="c">//   - Security incident investigation</span>
<span class="c">//   - &quot;Who deleted my storage account?&quot; questions</span>
<span class="c">//</span>
<span class="c">// Output Columns:</span>
<span class="c">//   - TimeGenerated: When the deletion occurred</span>
<span class="c">//   - Caller: User or service principal that deleted the resource</span>
<span class="c">//   - ResourceId: Full Azure Resource Manager ID</span>
<span class="c">//   - ResourceGroup: Resource group name</span>
<span class="c">//   - ResourceType: Type of resource deleted</span>
<span class="c">//</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">// Author: David Swann</span>
<span class="c">// Tested With: Log Analytics Workspace, 90 days retention</span>
<span class="c">//=============================================================================</span>

<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceId</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">6</span><span class="p">],</span><span class="w">  </span><span class="c">// Extract type from ARM ID</span>
<span class="w">    </span><span class="n">SubscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<p><strong>Why this template works:</strong><br />
- <strong>Purpose</strong> tells you why this query exists<br />
- <strong>Use Cases</strong> reminds you when to run it<br />
- <strong>Output Columns</strong> documents what each field means (saves time explaining to auditors)<br />
- <strong>Last Updated</strong> tracks query freshness<br />
- <strong>Comments in the query</strong> explain non-obvious logic</p>
<p><strong>Save this template as:</strong> <code>_TEMPLATE.kql</code> in the root directory. Copy it every time you create a new query.</p>
<h2>Step 4: The Five Queries You Need Right Now (10 minutes)</h2>
<p>These are the queries I run most often. Start with these, add your own over time.</p>
<h3>1. Resource Deletions (Audit Trail)</h3>
<p><strong>File:</strong> <code>activity-logs/resource-deletions.kql</code></p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: Resource Deletions (Last 90 Days)</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Audit trail of all deleted resources</span>
<span class="c">// Use Cases: Quarterly reviews, incident response, &quot;who deleted this?&quot;</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">//=============================================================================</span>

<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ActivityStatusValue</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">ResourceType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">6</span><span class="p">]</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">Caller</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceType</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResourceName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[-</span><span class="mi">1</span><span class="p">],</span>
<span class="w">    </span><span class="n">ResourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">SubscriptionId</span><span class="p">,</span>
<span class="w">    </span><span class="n">OperationName</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h3>2. Admin Role Assignments (Security Review)</h3>
<p><strong>File:</strong> <code>azure-ad/admin-role-assignments.kql</code></p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: New Admin Role Assignments</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Track who was granted admin privileges</span>
<span class="c">// Use Cases: Monthly security review, SOX compliance, privilege escalation investigation</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">//=============================================================================</span>

<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Add member to role&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">RoleName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">UserAdded</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">AddedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">RoleName</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;Administrator&quot;</span><span class="w">  </span><span class="c">// Focus on admin roles</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">AddedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">UserAdded</span><span class="p">,</span>
<span class="w">    </span><span class="n">RoleName</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h3>3. App Registration Creation (Shadow IT Detection)</h3>
<p><strong>File:</strong> <code>azure-ad/app-registration-creation.kql</code></p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: New App Registrations</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Track creation of new app registrations (potential shadow IT)</span>
<span class="c">// Use Cases: Monthly app review, Tenable scanner alerts, security audit</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">//=============================================================================</span>

<span class="n">AuditLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">30</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Add application&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;success&quot;</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">AppName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">displayName</span><span class="p">),</span>
<span class="w">    </span><span class="n">AppId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">TargetResources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">userPrincipalName</span><span class="p">),</span>
<span class="w">    </span><span class="n">CreatedByObjectId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">InitiatedBy</span><span class="err">.</span><span class="n">user</span><span class="err">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">TimeGenerated</span><span class="p">,</span>
<span class="w">    </span><span class="n">CreatedBy</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppName</span><span class="p">,</span>
<span class="w">    </span><span class="n">AppId</span><span class="p">,</span>
<span class="w">    </span><span class="n">CorrelationId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h3>4. Failed Sign-Ins (Brute Force Detection)</h3>
<p><strong>File:</strong> <code>security/failed-signins.kql</code></p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: Failed Sign-In Attempts (Brute Force Detection)</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Identify accounts under brute force attack</span>
<span class="c">// Use Cases: Security monitoring, incident response, user lockout troubleshooting</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">//=============================================================================</span>

<span class="n">SignInLogs</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ResultType</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c">// 0 = success, anything else = failure</span>
<span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span>
<span class="w">    </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">(),</span>
<span class="w">    </span><span class="n">FirstAttempt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">LastAttempt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">TimeGenerated</span><span class="p">),</span>
<span class="w">    </span><span class="n">UniqueIPs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcount</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">),</span>
<span class="w">    </span><span class="n">IPList</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_set</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">),</span>
<span class="w">    </span><span class="n">ErrorCodes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_set</span><span class="p">(</span><span class="n">ResultType</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">UserPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="n">AppDisplayName</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="c">// Threshold for investigation</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">FailedAttempts</span><span class="w"> </span><span class="n">desc</span>
</code></pre></div>

<h3>5. Untagged Resources (Governance Check)</h3>
<p><strong>File:</strong> <code>inventory/untagged-resources.kql</code></p>
<div class="codehilite"><pre><span></span><code><span class="c">//=============================================================================</span>
<span class="c">// Query: Resources Without Required Tags</span>
<span class="c">//=============================================================================</span>
<span class="c">// Purpose: Find resources missing cost center, environment, or owner tags</span>
<span class="c">// Use Cases: Monthly governance review, chargeback preparation, tag cleanup</span>
<span class="c">// Last Updated: 2025-10-28</span>
<span class="c">//=============================================================================</span>

<span class="n">Resources</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="err">!</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;microsoft.resources/subscriptions&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;microsoft.resources/subscriptions/resourcegroups&quot;</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span>
<span class="w">    </span><span class="n">CostCenter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;CostCenter&#39;</span><span class="p">]),</span>
<span class="w">    </span><span class="n">Environment</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;Environment&#39;</span><span class="p">]),</span>
<span class="w">    </span><span class="n">Owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s">&#39;Owner&#39;</span><span class="p">])</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">isempty</span><span class="p">(</span><span class="n">CostCenter</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">isempty</span><span class="p">(</span><span class="n">Environment</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">isempty</span><span class="p">(</span><span class="n">Owner</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">type</span><span class="p">,</span>
<span class="w">    </span><span class="n">resourceGroup</span><span class="p">,</span>
<span class="w">    </span><span class="n">location</span><span class="p">,</span>
<span class="w">    </span><span class="n">CostCenter</span><span class="p">,</span>
<span class="w">    </span><span class="n">Environment</span><span class="p">,</span>
<span class="w">    </span><span class="n">Owner</span><span class="p">,</span>
<span class="w">    </span><span class="n">subscriptionId</span>
<span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">resourceGroup</span><span class="w"> </span><span class="n">asc</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">asc</span>
</code></pre></div>

<p><strong>Save these five queries.</strong> They cover 80% of common requests.</p>
<h2>Step 5: Daily Workflow (How to Actually Use This)</h2>
<h3>When someone asks a question:</h3>
<p><strong>Before (the old way):</strong><br />
1. Try to remember where you saved the query<br />
2. Search Slack: "kql delete" (12 results, none right)<br />
3. Check OneNote (wrong notebook)<br />
4. Google it and adapt an example<br />
5. 15 minutes wasted</p>
<p><strong>After (with Git):</strong><br />
1. Open VS Code<br />
2. Press <code>Ctrl+P</code> (Quick Open)<br />
3. Type: <code>delete</code><br />
4. See: <code>resource-deletions.kql</code><br />
5. Press Enter<br />
6. Copy query, paste into Log Analytics<br />
7. Done in 30 seconds</p>
<h3>When you write a new query:</h3>
<ol>
<li>Save it immediately: <code>File &gt; Save As &gt; [folder]/[descriptive-name].kql</code></li>
<li>Add the header template (purpose, use cases, etc.)</li>
<li>Commit to Git: <code>git add . &amp;&amp; git commit -m "Add query for X"</code></li>
<li>Push: <code>git push</code></li>
</ol>
<p><strong>Don't wait.</strong> Save it the moment you write it. Future you will thank you.</p>
<h3>When you update a query:</h3>
<ol>
<li>Edit the <code>.kql</code> file</li>
<li>Update the "Last Updated" date in the header</li>
<li>Add a comment explaining what changed</li>
<li>Commit: <code>git commit -m "Fix date range in resource-deletions.kql"</code></li>
</ol>
<p>Git history shows you every version of every query. You can always roll back.</p>
<hr />
<h2>My Real-World Query Library Stats</h2>
<p>At Synovus, I maintain ~80 KQL queries across 12 folders:</p>
<table>
<thead>
<tr>
<th>Folder</th>
<th>Queries</th>
<th>Most Used</th>
</tr>
</thead>
<tbody>
<tr>
<td>activity-logs</td>
<td>15</td>
<td>resource-deletions.kql</td>
</tr>
<tr>
<td>azure-ad</td>
<td>12</td>
<td>app-registration-creation.kql</td>
</tr>
<tr>
<td>cost-management</td>
<td>8</td>
<td>monthly-spend-by-subscription.kql</td>
</tr>
<tr>
<td>security</td>
<td>18</td>
<td>failed-signins.kql</td>
</tr>
<tr>
<td>inventory</td>
<td>14</td>
<td>vm-inventory.kql</td>
</tr>
<tr>
<td>compliance</td>
<td>13</td>
<td>soc2-audit-trail.kql</td>
</tr>
</tbody>
</table>
<p><strong>Time saved per month:</strong> ~12 hours (not searching for queries)</p>
<p><strong>Queries run per week:</strong> 20-30 (audits, troubleshooting, reviews)</p>
<p><strong>Percentage of queries reused:</strong> 90% (write once, use many times)</p>
<hr />
<h2>Common Mistakes to Avoid</h2>
<h3>Mistake 1: One Giant File</h3>
<p><strong>Wrong:</strong></p>
<div class="codehilite"><pre><span></span><code>all-queries.kql (2,500 lines)
</code></pre></div>

<p><strong>Right:</strong></p>
<div class="codehilite"><pre><span></span><code>activity-logs/
  resource-deletions.kql (50 lines)
  resource-creations.kql (45 lines)
  admin-role-changes.kql (60 lines)
</code></pre></div>

<p><strong>Why:</strong> You can't search a 2,500-line file efficiently. Split by purpose.</p>
<h3>Mistake 2: No Comments</h3>
<p><strong>Wrong:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
</code></pre></div>

<p><strong>Right:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">// Purpose: Find all deleted resources for quarterly audit</span>
<span class="c">// Use case: SOC 2 CC6.1 compliance review</span>
<span class="c">// Last updated: 2025-10-28</span>

<span class="n">AzureActivity</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TimeGenerated</span><span class="w"> </span><span class="p">&gt;=</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">90</span><span class="n">d</span><span class="p">)</span>
<span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">OperationName</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="s">&quot;DELETE&quot;</span>
</code></pre></div>

<p><strong>Why:</strong> Three months from now, you won't remember why you wrote this or when to use it.</p>
<h3>Mistake 3: Vague Filenames</h3>
<p><strong>Wrong:</strong></p>
<div class="codehilite"><pre><span></span><code>query1.kql
test.kql
new-query-final-v3.kql
</code></pre></div>

<p><strong>Right:</strong></p>
<div class="codehilite"><pre><span></span><code>resource-deletions-last-90-days.kql
failed-signin-attempts-brute-force.kql
untagged-resources-by-subscription.kql
</code></pre></div>

<p><strong>Why:</strong> Filename should tell you exactly what the query does.</p>
<h3>Mistake 4: Not Committing Often</h3>
<p><strong>Wrong:</strong> Write 10 queries, commit once a month with message "updates"</p>
<p><strong>Right:</strong> Write 1 query, commit immediately with descriptive message</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add query to find VMs without backup enabled&quot;</span>
</code></pre></div>

<p><strong>Why:</strong> Git history becomes your documentation. Each commit explains what changed and why.</p>
<hr />
<h2>The 10-Query Starter Pack</h2>
<p>If you're building this from scratch, start with these 10 queries. They cover the most common requests I get:</p>
<ol>
<li><strong>activity-logs/resource-deletions.kql</strong> - Who deleted what</li>
<li><strong>activity-logs/resource-creations.kql</strong> - Who created what</li>
<li><strong>azure-ad/admin-role-assignments.kql</strong> - Who got admin access</li>
<li><strong>azure-ad/app-registration-creation.kql</strong> - New apps created</li>
<li><strong>security/failed-signins.kql</strong> - Brute force detection</li>
<li><strong>security/after-hours-activity.kql</strong> - Activity outside business hours</li>
<li><strong>inventory/vm-inventory.kql</strong> - Complete VM list with details</li>
<li><strong>inventory/untagged-resources.kql</strong> - Resources missing tags</li>
<li><strong>compliance/soc2-audit-trail.kql</strong> - Audit log for SOC 2</li>
<li><strong>cost-management/top-10-expensive-resources.kql</strong> - Biggest cost drivers</li>
</ol>
<p><strong>These 10 queries will handle 80% of your requests.</strong></p>
<p>Add more as you need them. Don't try to build everything at once.</p>
<hr />
<h2>Next Steps</h2>
<p><strong>This week:</strong><br />
1. Create the Git repository<br />
2. Install VS Code KQL extension<br />
3. Create folder structure<br />
4. Copy the 5 queries from this post<br />
5. Commit and push</p>
<p><strong>Next month:</strong><br />
1. Every time you write a query, save it immediately<br />
2. Add 1-2 new queries per week<br />
3. Run your most common queries from the repo (not from memory)</p>
<p><strong>In 6 months:</strong><br />
- You'll have 30-50 queries<br />
- You'll stop searching Slack for queries you wrote<br />
- You'll answer audit questions in seconds<br />
- You'll wonder how you ever lived without this</p>
<hr />
<h2>The Real Takeaway</h2>
<p>This isn't about being organized for the sake of organization.</p>
<p><strong>It's about this moment:</strong></p>
<p>Security team: "Show me all admin role grants from Q2."</p>
<p>You: <code>Ctrl+P</code> → <code>admin-role</code> → Copy → Paste → Run</p>
<p><strong>30 seconds. Done.</strong></p>
<p>That's the entire point.</p>
<hr />
<p><strong>Questions? Built your own query library? Have a better folder structure? Email me at contact@azure-noob.com or drop a comment below.</strong></p>
<p><strong>Related posts:</strong><br />
- <a href="/blog/soc2-activity-log-step-by-step/">The Missing SOC 2 Guide: Azure Activity Log Setup</a><br />
- <a href="/blog/soc2-azure-ad-audit-logs-step-by-step/">SOC 2 Audit Prep Part 2: Azure AD Audit Logs</a><br />
- <a href="/blog/kql-cheat-sheet-complete/">KQL Cheat Sheet: Complete Guide</a></p>
  </div>

  
  
  <aside class="related-posts" style="max-width: 800px; margin: 3rem auto; padding: 2rem; background: var(--bg-light); border-radius: 12px;">
    <h3 style="margin-top: 0;">Related Posts</h3>
    <ul style="list-style: none; padding: 0;">
      
      <li style="margin: 1rem 0;">
        <a href="../onenote-azure-admin-tool/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">OneNote: The Azure Admin Tool Nobody Tells You About</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-06</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="../tenable-says-remove-dotnet6/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">Security Found .NET 6 on 47 VMs. Now I&#39;m Supposed to Remove It. Here&#39;s Why That&#39;s Impossible.</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-27</span>
        </a>
      </li>
      
      <li style="margin: 1rem 0;">
        <a href="../azure-audit-gap-nobody-talks-about/index.html" style="display: block; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease;">
          <span class="related-title" style="font-weight: 700; display: block; color: var(--text-dark);">The Azure Audit Gap Nobody Talks About: Why Your 90-Day Logs Won&#39;t Survive a 7-Year Audit</span>
          <span class="related-meta" style="color: var(--text-muted); font-size: 0.9rem;">2025-10-26</span>
        </a>
      </li>
      
    </ul>
  </aside>
  

  
  <nav class="post-nav">
    
      <a href="../soc2-activity-log-step-by-step/index.html">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">← Previous</span>
        <strong>The Missing SOC 2 Guide: Azure Activity Log Setup (Grill Assembly Manual Edition)</strong>
      </a>
    
    
  </nav>

</article>

    </div>
  </main>

  <!-- EMAIL CAPTURE SECTION -->
  <section class="email-signup" id="subscribe">
    <div class="wrap">
      <h3>Get Azure tips in your inbox</h3>
      <p>Join Azure pros getting practical KQL queries, cost optimization tips, and real-world solutions.</p>
      <script async data-uid="3dfad5c743" src="https://azure-noob.kit.com/3dfad5c743/index.js"></script>
    </div>
  </section>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025 Azure Noob — Don&#39;t be a Noob</p>
    </div>
  </footer>

  <!-- Copy code functionality -->
  <script src="../../static/copy-code.js"></script>
</body>
</html>