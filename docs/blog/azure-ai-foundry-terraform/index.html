<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  

  <!-- Primary SEO -->
  <title>Azure Ai Foundry Terraform ¬∑ Azure Noob</title>
  <meta name="description" content="Ôªø--- title: &#34;Azure AI Foundry + Terraform: Production RAG Infrastructure as Code (Not Portal Clickops)&#34; date: 2025-11-24 modified: 2025-12-12 summary:...">
  <link rel="canonical" href="https://azure-noob.com/blog/azure-ai-foundry-terraform" />

  <!-- Favicons -->
  <link rel="icon" href="/static/images/logo.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Azure Ai Foundry Terraform">
  <meta property="og:description" content="Ôªø--- title: &#34;Azure AI Foundry + Terraform: Production RAG Infrastructure as Code (Not Portal Clickops)&#34; date: 2025-11-24 modified: 2025-12-12 summary:...">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://azure-noob.com/blog/azure-ai-foundry-terraform">
  <meta property="og:image" content="https://azure-noob.com/static/images/hero/cloud-wars.png">

  
    <meta property="article:published_time" content="2025-11-24T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-24T00:00:00+00:00">
    <meta property="article:author" content="David Swann">
    
  

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Azure Ai Foundry Terraform">
  <meta name="twitter:description" content="Ôªø--- title: &#34;Azure AI Foundry + Terraform: Production RAG Infrastructure as Code (Not Portal Clickops)&#34; date: 2025-11-24 modified: 2025-12-12 summary:...">
  <meta name="twitter:image" content="https://azure-noob.com/static/images/hero/cloud-wars.png">

  <!-- Styles -->
  <link rel="stylesheet" href="/static/styles.css">

  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="Azure Noob RSS Feed" href="https://azure-noob.com/rss.xml">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNHGEB0BNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZNHGEB0BNZ');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-wrap">
      <div class="brand-block">
        <a href="/" class="brand-link">
          <img src="/static/images/logo.png" alt="Azure Noob logo" class="logo">
        </a>
        <span class="brand-text">
          <small>Official Website of</small>
          <strong>Azure Noob</strong>
        </span>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/blog/">Blog</a>
        <a href="/hubs/" style="font-weight: 700;">Content Hubs</a>
        <a href="/start-here">Start Here</a>
        <a href="/blog/starter-kit/">Starter Kit</a>
        <a href="/about">About</a>
        <a href="/tags/">Tags</a>
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
        <a href="/search">Search</a>
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="wrap">
      


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Azure Ai Foundry Terraform",
  "description": "Ôªø--- title: &#34;Azure AI Foundry + Terraform: Production RAG Infrastructure as Code (Not Portal Clickops)&#34; date: 2025-11-24 modified: 2025-12-12 summary:...",
  "image": {
    "@type": "ImageObject",
    "url": "https://azure-noob.com/static/images/hero/cloud-wars.png",
    "width": 1200,
    "height": 630
  },
  "author": {
    "@type": "Person",
    "name": "David Swann",
    "url": "https://azure-noob.com/about/",
    "description": "Azure Architect specializing in enterprise cloud infrastructure",
    "jobTitle": "Azure Architect",
    "worksFor": {
      "@type": "Organization",
      "name": "Synovus"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Azure Noob",
    "url": "https://azure-noob.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://azure-noob.com/static/images/logo.png"
    }
  },
  "datePublished": "2025-11-24T00:00:00+00:00",
  "dateModified": "2025-11-24T00:00:00+00:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://azure-noob.com/blog/azure-ai-foundry-terraform"
  },
  "keywords": "",
  "articleSection": "Azure",
  "wordCount": "9109",
  "timeRequired": "PT46M",
  "inLanguage": "en-US",
  "isAccessibleForFree": "True",
  "about": {
    "@type": "Thing",
    "name": "Microsoft Azure"
  }
}
</script>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://azure-noob.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://azure-noob.com/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Azure Ai Foundry Terraform",
      "item": "https://azure-noob.com/blog/azure-ai-foundry-terraform"
    }
  ]
}
</script>




<article class="post">

  
  

  <header class="post-header">
    <h1>Azure Ai Foundry Terraform</h1>
    <p class="muted">
      2025-11-24 ¬∑ ~46 min read
      
    </p>
    
    
    
    
  </header>

  
  <p class="post-actions" style="margin:.5rem 0 0; text-align: center;">
    <button class="btn"
            onclick="window.print(); return false;"
            title="Print this page"
            aria-label="Print this page"
            style="cursor: pointer; background: none; border: 2px solid var(--azure-blue);">
      üñ®Ô∏è Print this page
    </button>
  </p>

  
  <div class="post-body">
    <p>Ôªø---<br />
title: "Azure AI Foundry + Terraform: Production RAG Infrastructure as Code (Not Portal Clickops)"<br />
date: 2025-11-24<br />
modified: 2025-12-12<br />
summary: "Complete Terraform code for Azure AI Foundry RAG: secure, repeatable, version-controlled deployment. Includes private endpoints, managed identity, monitoring, cost controls, and search integration. What YouTube tutorials skip for enterprise production."<br />
tags: ["azure", "Terraform", "Infrastructure as Code", "Azure AI Foundry", "RAG", "devops"]<br />
cover: "/static/images/hero/azure-ai-foundry-terraform.png"<br />
hub: ai</p>
<hr />
<p><strong>Every Azure AI Foundry tutorial uses the Portal. Zero use Terraform.</strong></p>
<p>This guide is part of our <a href="/hub/ai/">AI-Assisted Azure Operations hub</a> exploring how AI tools transform cloud administration and productivity workflows.</p>
<p>They show you:<br />
1. Click "Create Resource"<br />
2. Fill in some forms<br />
3. Click "Create"<br />
4. "It works!"</p>
<p><strong>What they don't show:</strong><br />
- How to deploy this consistently across dev/staging/prod<br />
- How to version control your infrastructure<br />
- How to implement security from day one<br />
- How to avoid the "works on my machine" problem</p>
<p>I manage 44 Azure subscriptions with 31,000 resources. Manual deployments don't scale. Terraform does.</p>
<p>Here's the production-ready Terraform configuration for Azure AI Foundry RAG that includes security, monitoring, cost management, and everything the tutorials skip.</p>
<h2>Why Terraform for Azure AI Foundry?</h2>
<p><strong>The Portal approach (tutorials):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Problem</span><span class="o">:</span><span class="w"> </span><span class="n">Need</span><span class="w"> </span><span class="n">RAG</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="n">environment</span>
<span class="n">Solution</span><span class="o">:</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">Portal</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="n">minutes</span>
<span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="n">Dev</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">works</span>

<span class="n">Problem</span><span class="o">:</span><span class="w"> </span><span class="n">Need</span><span class="w"> </span><span class="n">RAG</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">prod</span><span class="w"> </span><span class="n">environment</span><span class="w">  </span>
<span class="n">Solution</span><span class="o">:</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">Portal</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="o">(</span><span class="n">slightly</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">settings</span><span class="o">)</span>
<span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="n">Prod</span><span class="w"> </span><span class="s2">&quot;works&quot;</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="n">differently</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">dev</span>

<span class="n">Problem</span><span class="o">:</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">audit</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="s2">&quot;no API keys in prod&quot;</span>
<span class="n">Solution</span><span class="o">:</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">Portal</span><span class="w"> </span><span class="n">fixing</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="o">(</span><span class="n">miss</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">settings</span><span class="o">)</span>
<span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="n">Partial</span><span class="w"> </span><span class="n">fix</span><span class="o">,</span><span class="w"> </span><span class="n">documentation</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">date</span>

<span class="n">Problem</span><span class="o">:</span><span class="w"> </span><span class="n">Teammate</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">replicate</span><span class="w"> </span><span class="n">setup</span>
<span class="n">Solution</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Uh, I think I clicked these buttons...&quot;</span>
<span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="n">Doesn</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="n">original</span><span class="o">,</span><span class="w"> </span><span class="n">troubleshooting</span><span class="w"> </span><span class="n">begins</span>
</code></pre></div>

<p><strong>The Terraform approach:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Define infrastructure once</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;ai_foundry_rag&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/ai-foundry&quot;</span>

<span class="w">  </span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="c1">  # dev, staging, prod</span>
<span class="c1">  # ... configuration ...</span>
<span class="p">}</span>

<span class="c1"># Deploy to dev</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">dev</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">apply</span>

<span class="c1"># Deploy to prod (identical config, different params)</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">prod</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">apply</span>

<span class="c1"># Change security settings</span>
<span class="c1"># Edit terraform file, commit to git</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">apply</span><span class="c1">  # Updates all environments consistently</span>

<span class="c1"># Teammate replicates</span>
<span class="err">git</span><span class="w"> </span><span class="err">clone</span><span class="w"> </span><span class="err">repo</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">init</span>
<span class="err">terraform</span><span class="w"> </span><span class="err">apply</span><span class="c1">  # Exact replica</span>
</code></pre></div>

<p><strong>Benefits:</strong><br />
- ‚úÖ Version controlled (git)<br />
- ‚úÖ Repeatable (same every time)<br />
- ‚úÖ Auditable (see who changed what when)<br />
- ‚úÖ Testable (validate before applying)<br />
- ‚úÖ Documented (code IS documentation)</p>
<p><strong>This is how you deploy at enterprise scale.</strong></p>
<h2>Prerequisites</h2>
<p><strong>What you need before starting:</strong></p>
<ol>
<li><strong>Azure subscription</strong> with sufficient quota</li>
<li><strong>Terraform installed</strong> (v1.5.0+)</li>
<li><strong>Azure CLI</strong> authenticated (<code>az login</code>)</li>
<li><strong>Service Principal</strong> with appropriate permissions (or use Azure CLI auth)</li>
<li><strong>Understanding of <a href="/blog/azure-ai-foundry-rag-enterprise-reality/">Azure AI Foundry RAG basics</a></strong> (read my previous post)</li>
</ol>
<p><strong>Required permissions:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Your service principal needs these roles on the subscription</span>
-<span class="w"> </span>Contributor<span class="w"> </span><span class="o">(</span>or<span class="w"> </span>specific<span class="w"> </span>resource<span class="w"> </span>provider<span class="w"> </span>permissions<span class="o">)</span>
-<span class="w"> </span>User<span class="w"> </span>Access<span class="w"> </span>Administrator<span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>RBAC<span class="w"> </span>assignments<span class="o">)</span>
</code></pre></div>

<p><strong>Cost warning:</strong> This will create billable resources (~$300-$1,000/month depending on tier choices).</p>
<h2>Project Structure</h2>
<p><strong>Organize your Terraform like this:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">azure</span><span class="o">-</span><span class="n">ai</span><span class="o">-</span><span class="n">foundry</span><span class="o">-</span><span class="n">terraform</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span><span class="w">                 </span><span class="c1"># Main orchestration</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span><span class="w">            </span><span class="c1"># Input variables</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span><span class="w">              </span><span class="c1"># Outputs for reference</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">terraform</span><span class="o">.</span><span class="n">tfvars</span><span class="w">        </span><span class="c1"># Variable values (gitignored if sensitive)</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">providers</span><span class="o">.</span><span class="n">tf</span><span class="w">            </span><span class="c1"># Provider configuration</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">backend</span><span class="o">.</span><span class="n">tf</span><span class="w">              </span><span class="c1"># Remote state configuration</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">versions</span><span class="o">.</span><span class="n">tf</span><span class="w">             </span><span class="c1"># Version constraints</span>
<span class="err">‚îÇ</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">modules</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">resource</span><span class="o">-</span><span class="n">group</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">storage</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">ai</span><span class="o">-</span><span class="n">search</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">openai</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">monitoring</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">networking</span><span class="o">/</span><span class="w">          </span><span class="c1"># For private endpoints</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">outputs</span><span class="o">.</span><span class="n">tf</span>
<span class="err">‚îÇ</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">environments</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">dev</span><span class="o">.</span><span class="n">tfvars</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">staging</span><span class="o">.</span><span class="n">tfvars</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">prod</span><span class="o">.</span><span class="n">tfvars</span>
</code></pre></div>

<p><strong>This structure enables:</strong><br />
- Reusable modules<br />
- Environment-specific configs<br />
- Clear separation of concerns<br />
- Team collaboration</p>
<h2>Core Terraform Configuration</h2>
<h3>1. Provider and Backend Setup</h3>
<p><strong>providers.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">required_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;= 1.5.0&quot;</span>

<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">azurerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/azurerm&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 3.80&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">azuread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/azuread&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 2.45&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/random&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 3.5&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">features</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">key_vault</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">purge_soft_delete_on_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">      </span><span class="na">recover_soft_deleted_key_vaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">resource_group</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">prevent_deletion_if_contains_resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azuread&quot;</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p><strong>backend.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">resource_group_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-state-rg&quot;</span>
<span class="w">    </span><span class="na">storage_account_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tfstate${var.environment}&quot;</span>
<span class="w">    </span><span class="na">container_name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tfstate&quot;</span>
<span class="w">    </span><span class="na">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ai-foundry-rag.tfstate&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Why remote state?</strong><br />
- Team collaboration (shared state)<br />
- State locking (prevents concurrent modifications)<br />
- Encryption at rest<br />
- Backup and recovery</p>
<h3>2. Variables Definition</h3>
<p><strong>variables.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;environment&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Environment name (dev, staging, prod)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">condition</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nf">contains</span><span class="p">([</span><span class="s2">&quot;dev&quot;, &quot;staging&quot;, &quot;prod&quot;</span><span class="p">],</span><span class="w"> </span><span class="nv">var.environment</span><span class="p">)</span>
<span class="w">    </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Environment must be dev, staging, or prod.&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;location&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure region for resources&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eastus2&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;project_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Project name for resource naming&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;airag&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;tags&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Tags to apply to all resources&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">  </span><span class="nb">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">ManagedBy</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Terraform&quot;</span>
<span class="w">    </span><span class="na">Project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AI-Foundry-RAG&quot;</span>
<span class="w">    </span><span class="na">CostCenter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IT-Innovation&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Search service tier</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;search_sku&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure AI Search SKU&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span><span class="c1">  # standard, basic, standard2, standard3</span>
<span class="p">}</span>

<span class="c1"># OpenAI model deployments</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;openai_deployments&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OpenAI model deployments&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">object</span><span class="p">({</span>
<span class="w">    </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="p">}))</span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;gpt-4&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span>
<span class="w">      </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0613&quot;</span>
<span class="w">      </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">      </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="s2">&quot;text-embedding-ada-002&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;text-embedding-ada-002&quot;</span>
<span class="w">      </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2&quot;</span>
<span class="w">      </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">      </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Security settings</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;enable_private_endpoints&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enable private endpoints for services&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="c1">  # Set to true for production</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;allowed_ip_ranges&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IP ranges allowed to access services (for firewall)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="c1">  # Empty = allow from Azure services only</span>
<span class="p">}</span>

<span class="c1"># Monitoring</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;enable_diagnostic_logs&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enable diagnostic logging&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;log_retention_days&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Number of days to retain logs&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="p">}</span>
</code></pre></div>

<h3>3. Main Orchestration</h3>
<p><strong>main.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Generate unique suffix for globally unique names</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_string&quot;</span><span class="w"> </span><span class="nv">&quot;suffix&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="na">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="p">}</span>

<span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.project_name}-${var.environment}&quot;</span>
<span class="w">  </span><span class="na">name_suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_string.suffix.result</span>

<span class="w">  </span><span class="na">common_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span>
<span class="w">    </span><span class="nv">var.tags</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">      </span><span class="na">DeployedBy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Terraform&quot;</span>
<span class="w">      </span><span class="na">DeployDate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">timestamp</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Resource Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_resource_group&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-rg&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">tags</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>

<span class="c1"># Storage Account for documents</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;storage&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/storage&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.project_name}${var.environment}${local.name_suffix}&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>

<span class="w">  </span><span class="na">enable_private_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoints</span>
<span class="w">  </span><span class="na">allowed_ip_ranges</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="p">}</span>

<span class="c1"># Azure AI Search</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;ai_search&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/ai-search&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-search-${local.name_suffix}&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">sku</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">var.search_sku</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>

<span class="w">  </span><span class="na">enable_semantic_search</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">enable_private_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoints</span>
<span class="w">  </span><span class="na">allowed_ip_ranges</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="p">}</span>

<span class="c1"># Azure OpenAI</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/openai&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-openai-${local.name_suffix}&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>

<span class="w">  </span><span class="na">deployments</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.openai_deployments</span>
<span class="w">  </span><span class="na">enable_private_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoints</span>
<span class="w">  </span><span class="na">allowed_ip_ranges</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="p">}</span>

<span class="c1"># Key Vault for secrets</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;key_vault&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/key-vault&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-kv-${local.name_suffix}&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>

<span class="w">  </span><span class="na">enable_private_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoints</span>
<span class="p">}</span>

<span class="c1"># Store connection strings and keys in Key Vault</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;storage_connection_string&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;storage-connection-string&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">module.storage.primary_connection_string</span>
<span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.key_vault.id</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.key_vault</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;search_admin_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;search-admin-key&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">module.ai_search.primary_admin_key</span>
<span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.key_vault.id</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.key_vault</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;openai_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;openai-key&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">module.openai.primary_key</span>
<span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.key_vault.id</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.key_vault</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Monitoring</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;monitoring&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./modules/monitoring&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-monitoring&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>

<span class="w">  </span><span class="na">log_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_retention_days</span>

<span class="c1">  # Resources to monitor</span>
<span class="w">  </span><span class="na">storage_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.storage.id</span>
<span class="w">  </span><span class="na">search_service_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">module.ai_search.id</span>
<span class="w">  </span><span class="na">openai_account_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">module.openai.id</span>
<span class="p">}</span>
</code></pre></div>

<h2>Module Implementation: Azure AI Search</h2>
<p><strong>modules/ai-search/main.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_search_service&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">sku</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">var.sku</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>

<span class="c1">  # Semantic search (required for RAG)</span>
<span class="w">  </span><span class="na">semantic_search_sku</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_semantic_search</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">null</span>

<span class="c1">  # Security settings</span>
<span class="w">  </span><span class="na">public_network_access_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # Authentication</span>
<span class="w">  </span><span class="na">authentication_failure_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http401WithBearerChallenge&quot;</span>

<span class="c1">  # Managed identity for accessing storage</span>
<span class="w">  </span><span class="nb">identity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SystemAssigned&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # Replica count for HA (prod only)</span>
<span class="w">  </span><span class="na">replica_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.sku</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="nv">var.replica_count</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="na">partition_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.partition_count</span>
<span class="p">}</span>

<span class="c1"># Network rules if not using private endpoint</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_search_service_network_rule_set&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>

<span class="w">  </span><span class="na">search_service_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.id</span>

<span class="c1">  # IP rules</span>
<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">&quot;ip_rule&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ip_rule.value</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # Allow Azure services</span>
<span class="w">  </span><span class="na">bypass_data_plane_authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;AzureServices&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Private endpoint (production)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_private_endpoint&quot;</span><span class="w"> </span><span class="nv">&quot;search&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-pe&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">subnet_id</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.subnet_id</span>

<span class="w">  </span><span class="nb">private_service_connection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">                           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-psc&quot;</span>
<span class="w">    </span><span class="na">private_connection_resource_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.id</span>
<span class="w">    </span><span class="na">subresource_names</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;searchService&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">is_manual_connection</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>
<span class="p">}</span>

<span class="c1"># Diagnostic settings</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_monitor_diagnostic_setting&quot;</span><span class="w"> </span><span class="nv">&quot;search&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_diagnostic_logs</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-diagnostics&quot;</span>
<span class="w">  </span><span class="na">target_resource_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.id</span>
<span class="w">  </span><span class="na">log_analytics_workspace_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_analytics_workspace_id</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OperationLogs&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">metric</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AllMetrics&quot;</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>modules/ai-search/variables.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Name of the search service&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;resource_group_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Resource group name&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;location&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure region&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;sku&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Search service SKU&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span>

<span class="w">  </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">condition</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nf">contains</span><span class="p">([</span><span class="s2">&quot;free&quot;, &quot;basic&quot;, &quot;standard&quot;, &quot;standard2&quot;, &quot;standard3&quot;, &quot;storage_optimized_l1&quot;, &quot;storage_optimized_l2&quot;</span><span class="p">],</span><span class="w"> </span><span class="nv">var.sku</span><span class="p">)</span>
<span class="w">    </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Invalid SKU. Choose from: free, basic, standard, standard2, standard3, storage_optimized_l1, storage_optimized_l2&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;enable_semantic_search&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enable semantic search&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;replica_count&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Number of replicas (HA)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;partition_count&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Number of partitions&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;enable_private_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enable private endpoint&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;subnet_id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Subnet ID for private endpoint&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">null</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;allowed_ip_ranges&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allowed IP ranges for firewall&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;enable_diagnostic_logs&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enable diagnostic logging&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;log_analytics_workspace_id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Log Analytics workspace ID&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">null</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;tags&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Resource tags&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">  </span><span class="nb">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>modules/ai-search/outputs.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Search service ID&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.id</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Search service name&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.name</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Search service endpoint&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://${azurerm_search_service.main.name}.search.windows.net&quot;</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;primary_admin_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Primary admin key&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.primary_key</span>
<span class="w">  </span><span class="na">sensitive</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;query_keys&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Query keys&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.query_keys</span>
<span class="w">  </span><span class="na">sensitive</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;identity_principal_id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Managed identity principal ID&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.identity[0].principal_id</span>
<span class="p">}</span>
</code></pre></div>

<h2>Module Implementation: Azure OpenAI</h2>
<p><strong>modules/openai/main.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_cognitive_account&quot;</span><span class="w"> </span><span class="nv">&quot;openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">kind</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OpenAI&quot;</span>
<span class="w">  </span><span class="na">sku_name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S0&quot;</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>

<span class="c1">  # Managed identity</span>
<span class="w">  </span><span class="nb">identity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SystemAssigned&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # Security</span>
<span class="w">  </span><span class="na">public_network_access_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">custom_subdomain_name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name</span><span class="c1">  # Required for private endpoints</span>

<span class="c1">  # Network ACLs</span>
<span class="w">  </span><span class="nb">network_acls</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">default_action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="s2">&quot;Deny&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>

<span class="w">    </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">&quot;ip_rules&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="w">      </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">ip_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ip_rules.value</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Always allow Azure services</span>
<span class="w">    </span><span class="na">virtual_network_rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Deploy models</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_cognitive_deployment&quot;</span><span class="w"> </span><span class="nv">&quot;models&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.deployments</span>

<span class="w">  </span><span class="na">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<span class="w">  </span><span class="na">cognitive_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_cognitive_account.openai.id</span>

<span class="w">  </span><span class="nb">model</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">format</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OpenAI&quot;</span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.model_name</span>
<span class="w">    </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.model_version</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">scale</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.scale_type</span>
<span class="w">    </span><span class="na">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.capacity</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">rai_policy_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Microsoft.Default&quot;</span>
<span class="p">}</span>

<span class="c1"># Private endpoint (production)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_private_endpoint&quot;</span><span class="w"> </span><span class="nv">&quot;openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-pe&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">subnet_id</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.subnet_id</span>

<span class="w">  </span><span class="nb">private_service_connection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">                           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-psc&quot;</span>
<span class="w">    </span><span class="na">private_connection_resource_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_cognitive_account.openai.id</span>
<span class="w">    </span><span class="na">subresource_names</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;account&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">is_manual_connection</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>
<span class="p">}</span>

<span class="c1"># Diagnostic settings</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_monitor_diagnostic_setting&quot;</span><span class="w"> </span><span class="nv">&quot;openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_diagnostic_logs</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-diagnostics&quot;</span>
<span class="w">  </span><span class="na">target_resource_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_cognitive_account.openai.id</span>
<span class="w">  </span><span class="na">log_analytics_workspace_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_analytics_workspace_id</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Audit&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RequestResponse&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">metric</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AllMetrics&quot;</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RBAC for AI Search to access OpenAI</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_role_assignment&quot;</span><span class="w"> </span><span class="nv">&quot;search_to_openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.search_principal_id</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">scope</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_cognitive_account.openai.id</span>
<span class="w">  </span><span class="na">role_definition_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Cognitive Services OpenAI User&quot;</span>
<span class="w">  </span><span class="na">principal_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.search_principal_id</span>
<span class="p">}</span>
</code></pre></div>

<h2>Module Implementation: Storage Account</h2>
<p><strong>modules/storage/main.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_storage_account&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">account_tier</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">  </span><span class="na">account_replication_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.replication_type</span>
<span class="w">  </span><span class="na">account_kind</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;StorageV2&quot;</span>
<span class="w">  </span><span class="na">tags</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>

<span class="c1">  # Security settings</span>
<span class="w">  </span><span class="na">min_tls_version</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TLS1_2&quot;</span>
<span class="w">  </span><span class="na">enable_https_traffic_only</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">allow_nested_items_to_be_public</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="na">shared_access_key_enabled</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="c1">  # Needed for some tools, but use SAS tokens</span>

<span class="c1">  # Managed identity</span>
<span class="w">  </span><span class="nb">identity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SystemAssigned&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # Blob properties</span>
<span class="w">  </span><span class="nb">blob_properties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">versioning_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">    </span><span class="nb">delete_retention_policy</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.soft_delete_retention_days</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">container_delete_retention_policy</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.soft_delete_retention_days</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # Network rules</span>
<span class="w">  </span><span class="nb">network_rules</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">default_action</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="s2">&quot;Deny&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">    </span><span class="na">bypass</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;AzureServices&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">ip_rules</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_ip_ranges</span>
<span class="w">    </span><span class="na">virtual_network_subnet_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Containers for RAG documents</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_storage_container&quot;</span><span class="w"> </span><span class="nv">&quot;documents&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;documents&quot;</span>
<span class="w">  </span><span class="na">storage_account_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_storage_account.main.name</span>
<span class="w">  </span><span class="na">container_access_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;private&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_storage_container&quot;</span><span class="w"> </span><span class="nv">&quot;embeddings&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;embeddings&quot;</span>
<span class="w">  </span><span class="na">storage_account_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_storage_account.main.name</span>
<span class="w">  </span><span class="na">container_access_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;private&quot;</span>
<span class="p">}</span>

<span class="c1"># Private endpoint (production)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_private_endpoint&quot;</span><span class="w"> </span><span class="nv">&quot;blob&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_private_endpoint</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-blob-pe&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.resource_group_name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>
<span class="w">  </span><span class="na">subnet_id</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.subnet_id</span>

<span class="w">  </span><span class="nb">private_service_connection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">                           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-blob-psc&quot;</span>
<span class="w">    </span><span class="na">private_connection_resource_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_storage_account.main.id</span>
<span class="w">    </span><span class="na">subresource_names</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;blob&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">is_manual_connection</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tags</span>
<span class="p">}</span>

<span class="c1"># Diagnostic settings</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_monitor_diagnostic_setting&quot;</span><span class="w"> </span><span class="nv">&quot;storage&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.enable_diagnostic_logs</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name}-diagnostics&quot;</span>
<span class="w">  </span><span class="na">target_resource_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${azurerm_storage_account.main.id}/blobServices/default&quot;</span>
<span class="w">  </span><span class="na">log_analytics_workspace_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.log_analytics_workspace_id</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;StorageRead&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;StorageWrite&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">enabled_log</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;StorageDelete&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">metric</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Transaction&quot;</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RBAC for AI Search to read blobs</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_role_assignment&quot;</span><span class="w"> </span><span class="nv">&quot;search_to_storage&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.search_principal_id</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">scope</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_storage_account.main.id</span>
<span class="w">  </span><span class="na">role_definition_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Storage Blob Data Reader&quot;</span>
<span class="w">  </span><span class="na">principal_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.search_principal_id</span>
<span class="p">}</span>
</code></pre></div>

<h2>Environment-Specific Configurations</h2>
<p><strong>environments/dev.tfvars:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span>
<span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eastus2&quot;</span>

<span class="c1"># Cheaper tiers for dev</span>
<span class="na">search_sku</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;basic&quot;</span><span class="c1">  # $75/month vs $249/month</span>

<span class="nb">openai_deployments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;gpt-4&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span>
<span class="w">    </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0613&quot;</span>
<span class="w">    </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">    </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="c1">  # Lower capacity for dev</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="s2">&quot;text-embedding-ada-002&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;text-embedding-ada-002&quot;</span>
<span class="w">    </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2&quot;</span>
<span class="w">    </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">    </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># No private endpoints in dev (save costs)</span>
<span class="na">enable_private_endpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="c1"># Shorter retention for dev</span>
<span class="na">log_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>

<span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span>
<span class="w">  </span><span class="na">CostCenter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IT-Dev&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>environments/prod.tfvars:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span>
<span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eastus2&quot;</span>

<span class="c1"># Production tiers</span>
<span class="na">search_sku</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span><span class="c1">  # $249/month, includes semantic search</span>

<span class="nb">openai_deployments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;gpt-4&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span>
<span class="w">    </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0613&quot;</span>
<span class="w">    </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">    </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="c1">  # Higher capacity for prod</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="s2">&quot;text-embedding-ada-002&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">model_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;text-embedding-ada-002&quot;</span>
<span class="w">    </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2&quot;</span>
<span class="w">    </span><span class="na">scale_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">    </span><span class="na">capacity</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">20</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Enable private endpoints for security</span>
<span class="na">enable_private_endpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1"># Longer retention for compliance</span>
<span class="na">log_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span>

<span class="c1"># Restrict access to specific IPs</span>
<span class="na">allowed_ip_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="s2">&quot;203.0.113.0/24&quot;</span><span class="p">,</span><span class="c1">  # Corporate office</span>
<span class="w">  </span><span class="s2">&quot;198.51.100.0/24&quot;</span><span class="c1">  # VPN endpoint</span>
<span class="p">]</span>

<span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span>
<span class="w">  </span><span class="na">CostCenter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IT-Prod&quot;</span>
<span class="w">  </span><span class="na">Compliance</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SOC2&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h2>Deployment Workflow</h2>
<h3>Initial Setup</h3>
<p><strong>1. Initialize Terraform:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Clone your repo</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/yourorg/azure-ai-foundry-terraform.git
<span class="nb">cd</span><span class="w"> </span>azure-ai-foundry-terraform

<span class="c1"># Initialize Terraform</span>
terraform<span class="w"> </span>init

<span class="c1"># Validate configuration</span>
terraform<span class="w"> </span>validate

<span class="c1"># Format code</span>
terraform<span class="w"> </span>fmt<span class="w"> </span>-recursive
</code></pre></div>

<p><strong>2. Create workspace for dev:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create dev workspace</span>
terraform<span class="w"> </span>workspace<span class="w"> </span>new<span class="w"> </span>dev

<span class="c1"># Or switch to existing</span>
terraform<span class="w"> </span>workspace<span class="w"> </span><span class="k">select</span><span class="w"> </span>dev
</code></pre></div>

<p><strong>3. Plan deployment:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Plan with dev variables</span>
terraform<span class="w"> </span>plan<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/dev.tfvars&quot;</span><span class="w"> </span>-out<span class="o">=</span>dev.tfplan

<span class="c1"># Review the plan carefully</span>
</code></pre></div>

<p><strong>4. Apply deployment:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Apply the plan</span>
terraform<span class="w"> </span>apply<span class="w"> </span>dev.tfplan

<span class="c1"># Or apply directly (will prompt for approval)</span>
terraform<span class="w"> </span>apply<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/dev.tfvars&quot;</span>
</code></pre></div>

<h3>Deploying to Production</h3>
<p><strong>1. Create prod workspace:</strong></p>
<div class="codehilite"><pre><span></span><code>terraform<span class="w"> </span>workspace<span class="w"> </span>new<span class="w"> </span>prod
terraform<span class="w"> </span>workspace<span class="w"> </span><span class="k">select</span><span class="w"> </span>prod
</code></pre></div>

<p><strong>2. Plan and apply:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Plan</span>
terraform<span class="w"> </span>plan<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/prod.tfvars&quot;</span><span class="w"> </span>-out<span class="o">=</span>prod.tfplan

<span class="c1"># Review thoroughly - this is prod!</span>

<span class="c1"># Apply</span>
terraform<span class="w"> </span>apply<span class="w"> </span>prod.tfplan
</code></pre></div>

<h3>Making Changes</h3>
<p><strong>1. Update Terraform files:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Edit modules/ai-search/main.tf (example)</span>
vim<span class="w"> </span>modules/ai-search/main.tf

<span class="c1"># Format</span>
terraform<span class="w"> </span>fmt

<span class="c1"># Validate</span>
terraform<span class="w"> </span>validate
</code></pre></div>

<p><strong>2. Plan changes:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># See what will change</span>
terraform<span class="w"> </span>plan<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/dev.tfvars&quot;</span>
</code></pre></div>

<p><strong>3. Apply changes:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Apply to dev first</span>
terraform<span class="w"> </span>workspace<span class="w"> </span><span class="k">select</span><span class="w"> </span>dev
terraform<span class="w"> </span>apply<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/dev.tfvars&quot;</span>

<span class="c1"># Test thoroughly in dev</span>

<span class="c1"># Apply to prod</span>
terraform<span class="w"> </span>workspace<span class="w"> </span><span class="k">select</span><span class="w"> </span>prod
terraform<span class="w"> </span>apply<span class="w"> </span>-var-file<span class="o">=</span><span class="s2">&quot;environments/prod.tfvars&quot;</span>
</code></pre></div>

<h2>Cost Management with Terraform</h2>
<p><strong>Add cost tags for tracking:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">cost_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">CostCenter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.cost_center</span>
<span class="w">    </span><span class="na">Project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_name</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">    </span><span class="na">Owner</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.owner_email</span>
<span class="w">    </span><span class="na">BudgetAlert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.monthly_budget</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Apply to all resources</span>
<span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">var.tags</span><span class="p">,</span><span class="w"> </span><span class="nv">local.cost_tags</span><span class="p">)</span>
</code></pre></div>

<p><strong>Budget alerts (Azure Monitor):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_consumption_budget_resource_group&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-budget&quot;</span>
<span class="w">  </span><span class="na">resource_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.id</span>

<span class="w">  </span><span class="na">amount</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.monthly_budget</span>
<span class="w">  </span><span class="na">time_grain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Monthly&quot;</span>

<span class="w">  </span><span class="nb">time_period</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">start_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">formatdate</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-01&#39;T&#39;00:00:00Z&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">timestamp</span><span class="p">())</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">operator</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GreaterThan&quot;</span>

<span class="w">    </span><span class="na">contact_emails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">operator</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GreaterThan&quot;</span>

<span class="w">    </span><span class="na">contact_emails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Auto-shutdown for dev (save costs overnight):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Logic App to shut down dev resources at 6 PM</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_logic_app_workflow&quot;</span><span class="w"> </span><span class="nv">&quot;dev_shutdown&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-shutdown&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>

<span class="c1">  # Schedule: 6 PM EST Monday-Friday</span>
<span class="c1">  # Add workflow definition here</span>
<span class="p">}</span>
</code></pre></div>

<h2>Security Best Practices</h2>
<h3>1. No Secrets in Code</h3>
<p><strong>‚ùå Wrong:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_cognitive_account&quot;</span><span class="w"> </span><span class="nv">&quot;openai&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="c1">  # ...</span>
<span class="w">  </span><span class="na">api_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sk-1234567890abcdef&quot;</span><span class="c1">  # NEVER DO THIS</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>‚úÖ Right:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Store in Key Vault</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;openai_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;openai-key&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_cognitive_account.openai.primary_key</span>
<span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_key_vault.main.id</span>
<span class="p">}</span>

<span class="c1"># Applications retrieve from Key Vault at runtime</span>
<span class="c1"># Using managed identity authentication</span>
</code></pre></div>

<h3>2. Use Managed Identities</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Enable managed identity on all services</span>
<span class="nb">identity</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SystemAssigned&quot;</span>
<span class="p">}</span>

<span class="c1"># Grant RBAC permissions</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_role_assignment&quot;</span><span class="w"> </span><span class="nv">&quot;search_to_storage&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">scope</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_storage_account.main.id</span>
<span class="w">  </span><span class="na">role_definition_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Storage Blob Data Reader&quot;</span>
<span class="w">  </span><span class="na">principal_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_search_service.main.identity[0].principal_id</span>
<span class="p">}</span>
</code></pre></div>

<h3>3. Private Endpoints for Production</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Disable public access</span>
<span class="na">public_network_access_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="c1"># Enable private endpoint</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_private_endpoint&quot;</span><span class="w"> </span><span class="nv">&quot;search&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="c1">  # ... configuration ...</span>
<span class="p">}</span>
</code></pre></div>

<h3>4. Network Restrictions</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Firewall rules</span>
<span class="nb">network_rules</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">default_action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Deny&quot;</span>
<span class="w">  </span><span class="na">bypass</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;AzureServices&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">ip_rules</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.allowed_corporate_ips</span>
<span class="p">}</span>
</code></pre></div>

<h2>Monitoring and Alerts</h2>
<p><strong>Create alerts for failures:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_monitor_metric_alert&quot;</span><span class="w"> </span><span class="nv">&quot;search_failures&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-search-failures&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">scopes</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.ai_search.id</span><span class="p">]</span>
<span class="w">  </span><span class="na">description</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Alert when search query failure rate exceeds 10%&quot;</span>

<span class="w">  </span><span class="nb">criteria</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">metric_namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Microsoft.Search/searchServices&quot;</span>
<span class="w">    </span><span class="na">metric_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SearchQueriesPerSecond&quot;</span>
<span class="w">    </span><span class="na">aggregation</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Total&quot;</span>
<span class="w">    </span><span class="na">operator</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GreaterThan&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">action_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_monitor_action_group.ops_team.id</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_monitor_metric_alert&quot;</span><span class="w"> </span><span class="nv">&quot;openai_throttling&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${local.name_prefix}-openai-throttling&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">scopes</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.openai.id</span><span class="p">]</span>
<span class="w">  </span><span class="na">description</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Alert on OpenAI API throttling&quot;</span>

<span class="w">  </span><span class="nb">criteria</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">metric_namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Microsoft.CognitiveServices/accounts&quot;</span>
<span class="w">    </span><span class="na">metric_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Throttle&quot;</span>
<span class="w">    </span><span class="na">aggregation</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Total&quot;</span>
<span class="w">    </span><span class="na">operator</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GreaterThan&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">action_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_monitor_action_group.ops_team.id</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2>CI/CD Integration</h2>
<p><strong>Azure DevOps Pipeline:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># azure-pipelines.yml</span>
<span class="nt">trigger</span><span class="p">:</span>
<span class="w">  </span><span class="nt">branches</span><span class="p">:</span>
<span class="w">    </span><span class="nt">include</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="nt">include</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform/**</span>

<span class="nt">pool</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ubuntu-latest&#39;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Validate</span>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TerraformValidate</span>
<span class="w">        </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TerraformInstaller@0</span>
<span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">              </span><span class="nt">terraformVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1.5.7&#39;</span>

<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">              </span><span class="no">cd terraform</span>
<span class="w">              </span><span class="no">terraform init -backend=false</span>
<span class="w">              </span><span class="no">terraform validate</span>
<span class="w">              </span><span class="no">terraform fmt -check -recursive</span>
<span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Validate</span><span class="nv"> </span><span class="s">Terraform&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Plan_Dev</span>
<span class="w">    </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Validate</span>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PlanDev</span>
<span class="w">        </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TerraformTaskV4@4</span>
<span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">              </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;azurerm&#39;</span>
<span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;init&#39;</span>
<span class="w">              </span><span class="nt">backendServiceArm</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;AzureRM-ServiceConnection&#39;</span>
<span class="w">              </span><span class="nt">backendAzureRmResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;terraform-state-rg&#39;</span>
<span class="w">              </span><span class="nt">backendAzureRmStorageAccountName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;tfstatedev&#39;</span>
<span class="w">              </span><span class="nt">backendAzureRmContainerName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;tfstate&#39;</span>
<span class="w">              </span><span class="nt">backendAzureRmKey</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ai-foundry-rag.tfstate&#39;</span>

<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TerraformTaskV4@4</span>
<span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">              </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;azurerm&#39;</span>
<span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;plan&#39;</span>
<span class="w">              </span><span class="nt">commandOptions</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-var-file=&quot;environments/dev.tfvars&quot;</span><span class="nv"> </span><span class="s">-out=dev.tfplan&#39;</span>
<span class="w">              </span><span class="nt">environmentServiceNameAzureRM</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;AzureRM-ServiceConnection&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apply_Dev</span>
<span class="w">    </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Plan_Dev</span>
<span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">and(succeeded(), eq(variables[&#39;Build.SourceBranch&#39;], &#39;refs/heads/main&#39;))</span>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApplyDev</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dev&#39;</span>
<span class="w">        </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">          </span><span class="nt">runOnce</span><span class="p">:</span>
<span class="w">            </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">              </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TerraformTaskV4@4</span>
<span class="w">                  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;azurerm&#39;</span>
<span class="w">                    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;apply&#39;</span>
<span class="w">                    </span><span class="nt">commandOptions</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dev.tfplan&#39;</span>
<span class="w">                    </span><span class="nt">environmentServiceNameAzureRM</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;AzureRM-ServiceConnection&#39;</span>

<span class="w">  </span><span class="c1"># Repeat for staging and prod with approval gates</span>
</code></pre></div>

<h2>Troubleshooting Common Issues</h2>
<h3>Issue 1: "Resource Already Exists"</h3>
<p><strong>Problem:</strong> Importing existing resources</p>
<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Import existing resource</span>
terraform<span class="w"> </span>import<span class="w"> </span>azurerm_search_service.main<span class="w"> </span>/subscriptions/<span class="o">{</span>sub-id<span class="o">}</span>/resourceGroups/<span class="o">{</span>rg<span class="o">}</span>/providers/Microsoft.Search/searchServices/<span class="o">{</span>name<span class="o">}</span>

<span class="c1"># Or remove from state and recreate</span>
terraform<span class="w"> </span>state<span class="w"> </span>rm<span class="w"> </span>azurerm_search_service.main
terraform<span class="w"> </span>apply
</code></pre></div>

<h3>Issue 2: "Insufficient Quota"</h3>
<p><strong>Problem:</strong> Azure subscription quota limits</p>
<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check quota</span>
az<span class="w"> </span>vm<span class="w"> </span>list-usage<span class="w"> </span>--location<span class="w"> </span>eastus2<span class="w"> </span>--output<span class="w"> </span>table

<span class="c1"># Request quota increase via Azure Portal</span>
<span class="c1"># Or use smaller SKUs in terraform.tfvars</span>
</code></pre></div>

<h3>Issue 3: "Backend Initialization Failed"</h3>
<p><strong>Problem:</strong> State storage not accessible</p>
<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create state storage manually first</span>
az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>terraform-state-rg<span class="w"> </span>--location<span class="w"> </span>eastus2

az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>tfstatedev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span>terraform-state-rg<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--location<span class="w"> </span>eastus2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--sku<span class="w"> </span>Standard_LRS

az<span class="w"> </span>storage<span class="w"> </span>container<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>tfstate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--account-name<span class="w"> </span>tfstatedev

<span class="c1"># Then terraform init</span>
</code></pre></div>

<h2>Outputs for Application Use</h2>
<p><strong>outputs.tf:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;search_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure AI Search endpoint&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">module.ai_search.endpoint</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;openai_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure OpenAI endpoint&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">module.openai.endpoint</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;storage_account_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Storage account name&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">module.storage.name</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;key_vault_uri&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Key Vault URI for retrieving secrets&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">module.key_vault.uri</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;resource_group_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Resource group name&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="p">}</span>

<span class="c1"># Sensitive outputs</span>
<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;connection_info&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Connection information for applications&quot;</span>
<span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">search_endpoint</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">module.ai_search.endpoint</span>
<span class="w">    </span><span class="na">openai_endpoint</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">module.openai.endpoint</span>
<span class="w">    </span><span class="na">storage_account</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">module.storage.name</span>
<span class="w">    </span><span class="na">key_vault_uri</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">module.key_vault.uri</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use in your application:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Application retrieves endpoints from Terraform outputs</span>
<span class="c1"># Stored in CI/CD variables or Key Vault</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">azure.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultAzureCredential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">azure.keyvault.secrets</span><span class="w"> </span><span class="kn">import</span> <span class="n">SecretClient</span>

<span class="n">credential</span> <span class="o">=</span> <span class="n">DefaultAzureCredential</span><span class="p">()</span>

<span class="c1"># Get Key Vault URI from Terraform output</span>
<span class="n">kv_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;KEY_VAULT_URI&#39;</span><span class="p">]</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">SecretClient</span><span class="p">(</span><span class="n">vault_url</span><span class="o">=</span><span class="n">kv_uri</span><span class="p">,</span> <span class="n">credential</span><span class="o">=</span><span class="n">credential</span><span class="p">)</span>

<span class="c1"># Retrieve secrets</span>
<span class="n">search_key</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;search-admin-key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<span class="n">openai_key</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;openai-key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<h2>What We Accomplished</h2>
<p><strong>With this Terraform configuration, you have:</strong></p>
<p>‚úÖ <strong>Repeatable deployments</strong> - Deploy identical environments with one command<br />
‚úÖ <strong>Version control</strong> - Infrastructure changes tracked in git<br />
‚úÖ <strong>Security by default</strong> - Managed identities, Key Vault, optional private endpoints<br />
‚úÖ <strong>Environment parity</strong> - Dev/staging/prod from same code<br />
‚úÖ <strong>Cost controls</strong> - Budget alerts, environment-specific SKUs<br />
‚úÖ <strong>Monitoring built-in</strong> - Diagnostic logs, metric alerts<br />
‚úÖ <strong>Team collaboration</strong> - Remote state, workspace isolation<br />
‚úÖ <strong>Audit trail</strong> - Every change documented in git history</p>
<p><strong>Compare to Portal deployments:</strong><br />
- Portal: 30 minutes per environment, undocumented, inconsistent<br />
- Terraform: 5 minutes per environment, version controlled, identical</p>
<p><strong>This is how enterprises deploy Azure AI Foundry at scale.</strong></p>
<hr />
<h2>Next Steps</h2>
<p><strong>Now that you have the infrastructure:</strong></p>
<ol>
<li><strong>Deploy to dev</strong> and test thoroughly</li>
<li><strong>Configure your RAG pipeline</strong> using the endpoints from Terraform outputs</li>
<li><strong>Create your search index</strong> (I'll cover this in the next post)</li>
<li><strong>Set up CI/CD</strong> for automated deployments</li>
<li><strong>Deploy to prod</strong> with confidence</li>
</ol>
<p><strong>Coming next:</strong><br />
- Part 3: Python code for production RAG with error handling<br />
- Part 4: Monitoring and observability dashboards<br />
- Part 5: Cost optimization strategies</p>
<hr />
<p><em>Managing 44 Azure subscriptions and 31,000 resources taught me: Infrastructure as Code isn't optional at scale. It's the only way to maintain sanity.</em></p>
  </div>

  
  <section class="starter-kit-callout" style="
    max-width: 800px;
    margin: 3rem auto 2rem;
    padding: 2rem;
    border-radius: 12px;
    background: var(--bg-light);
    border: 1px solid var(--border);
    text-align: left;
  ">
    <h3 style="margin-top: 0;">Azure Admin Starter Kit (Free Download)</h3>
    <p style="margin-bottom: 1rem;">
      Get my KQL cheat sheet, 50 Windows + 50 Linux commands, and an Azure RACI template in one free bundle.
    </p>
    <a href="/blog/starter-kit/" class="btn">Get the Starter Kit ‚Üí</a>
  </section>

  
  <div class="inline-subscribe" style="
    max-width: 800px;
    margin: 3rem auto;
    padding: 2.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
  ">
    <h3 style="margin: 0 0 1rem; font-size: 1.75rem; color: white;">Get more Azure content like this</h3>
    <p style="margin: 0 0 1.5rem; font-size: 1.1rem; opacity: 0.95%;">
      Join Azure pros getting practical KQL queries, cost optimization tips, and real-world solutions delivered weekly.
    </p>
    <form action="https://magic.beehiiv.com/v1/3827b09b-c887-4929-a724-f6c97cef1c94" method="GET" class="subscribe-form" style="max-width: 500px; margin: 0 auto;">
      <input type="email" name="email" placeholder="your@email.com" required style="
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 1rem;
        background: rgba(255,255,255,0.9);
      ">
      <button type="submit" style="
        padding: 0.75rem 1.5rem;
        background: white;
        color: #667eea;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
      ">Subscribe</button>
    </form>
  </div>

  
  

  
  
  
    <!-- CTA: General Email Capture -->
<div class="cta-block" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 2rem; border-radius: 8px; margin: 3rem 0; text-align: center; color: white;">
  <h3 style="margin: 0 0 0.5rem; font-size: 1.5rem; color: white;">Azure Reality Checks</h3>
  <p style="margin: 0 0 1.5rem; font-size: 1rem; line-height: 1.5;">
    Get weekly insights on Azure's operational reality ‚Äî the problems Microsoft's docs won't tell you about.
  </p>
  <form action="https://azure-noob.beehiiv.com/subscribe" method="POST" target="_blank" style="display: flex; gap: 0.5rem; max-width: 400px; margin: 0 auto; flex-wrap: wrap; justify-content: center;">
    <input type="email" 
           name="email" 
           placeholder="your@email.com" 
           required 
           style="flex: 1; min-width: 200px; padding: 0.75rem; border: none; border-radius: 6px; font-size: 1rem;">
    <button type="submit" 
            style="padding: 0.75rem 1.5rem; background: white; color: #4facfe; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; white-space: nowrap;">
      Subscribe
    </button>
  </form>
  <p style="margin: 1rem 0 0; font-size: 0.85rem; opacity: 0.9;">
    Join 500+ Azure admins. Unsubscribe anytime.
  </p>
</div>
  

  
  <nav class="post-nav">
    
      <a href="/blog/azure-arc-vcenter-implementation-guide">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">‚Üê Previous</span>
        <strong>Azure Arc Vcenter Implementation Guide</strong>
      </a>
    
    
      <a href="/blog/azure-openai-pricing-real-costs" style="text-align: right;">
        <span style="opacity: 0.7; font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Next ‚Üí</span>
        <strong>Azure OpenAI Pricing 2025: Real Costs ($2 Demo ‚Üí $4K Production) + Calculator</strong>
      </a>
    
  </nav>

</article>

    </div>
  </main>

  <!-- EMAIL CAPTURE SECTION -->
  <section class="email-signup" id="subscribe">
    <div class="wrap">
      <h3>Get Azure tips in your inbox</h3>
      <p>Join Azure pros getting practical KQL queries, cost optimization tips, and real-world solutions.</p>
      <form action="https://magic.beehiiv.com/v1/3827b09b-c887-4929-a724-f6c97cef1c94" method="GET" class="subscribe-form">
        <input type="email" name="email" placeholder="your@email.com" required>
        <button type="submit">Subscribe</button>
      </form>
    </div>
  </section>

  <footer class="site-footer">
    <div class="wrap">
      <p>&copy; 2025 Azure Noob ‚Äî Don&#39;t be a Noob</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem;">
        <a href="/rss.xml" title="Subscribe via RSS">RSS Feed</a> ¬∑ 
        <a href="https://github.com/dswann101164" target="_blank" rel="noopener">GitHub</a>
      </p>
      <p style="margin-top: 1.5rem; font-size: 0.85rem; opacity: 0.7; font-style: italic;">
        "Trust in the Lord with all your heart, and lean not on your own understanding;<br>
        in all your ways acknowledge Him, and He will make your paths straight" ‚Äî Proverbs 3:5-6
      </p>
    </div>
  </footer>

  <!-- Copy code functionality -->
  <script src="/static/copy-code.js"></script>
</body>
</html>