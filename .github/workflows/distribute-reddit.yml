name: Distribute Blog Post (Reddit)

on:
  # Run automatically AFTER your site finishes deploying to GitHub Pages
  workflow_run:
    workflows: ["pages build and deployment"]
    types: [completed]

  # Or run manually to post any existing slug
  workflow_dispatch:
    inputs:
      slug:
        description: "Slug of the post, e.g. 2025-01-15-kql-cheat-sheet-complete (optional)"
        required: false
        type: string
      subreddit:
        description: "Subreddit name without r/ (default: AZURE)"
        required: false
        default: "AZURE"
        type: string
      flair_id:
        description: "Reddit flair ID (optional - leave blank to use default secret)"
        required: false
        type: string
      title_override:
        description: "Optional custom Reddit title (otherwise uses post title)"
        required: false
        type: string
      url_override:
        description: "Optional full URL (overrides slug & live-wait)"
        required: false
        type: string
      dry_run:
        description: "If true, only print what would be posted"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve post metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          INPUT_SLUG="${{ github.event.inputs.slug || '' }}"
          INPUT_URL="${{ github.event.inputs.url_override || '' }}"
          INPUT_SUB="${{ github.event.inputs.subreddit || '' }}"
          SUBREDDIT="${INPUT_SUB:-AZURE}"

          # Determine FILE/SLUG
          if [[ -n "$INPUT_SLUG" ]]; then
            FILE="posts/${INPUT_SLUG}.md"
            if [[ -f "$FILE" ]]; then
              SLUG="$INPUT_SLUG"
            else
              echo "Warning: $FILE not found. Continuing with slug only."
              SLUG="$INPUT_SLUG"
              FILE=""
            fi
          else
            # Use last changed post in last commit, else newest post
            FILE=$(git log -1 --pretty=format: --name-only -- posts/*.md | head -n 1 || true)
            [[ -z "$FILE" ]] && FILE=$(ls -t posts/*.md | head -n 1)
            SLUG=$(basename "$FILE" .md)
          fi

          # Parse front-matter if file exists
          TITLE=""
          SUMMARY=""
          HERO=""
          if [[ -n "${FILE:-}" && -f "$FILE" ]]; then
            TITLE=$(awk -F': ' '/^title:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
            SUMMARY=$(awk -F': ' '/^summary:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
            HERO=$(awk -F': ' '/^cover:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
          fi

          # Build URL (clean URLs)
          if [[ -n "$INPUT_URL" ]]; then
            URL="$INPUT_URL"
          else
            # Strip date prefix (YYYY-MM-DD-) from slug for clean URL
            CLEAN_SLUG=$(echo "$SLUG" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
            URL="https://azure-noob.com/blog/${CLEAN_SLUG}/"
          fi

          {
            echo "FILE=$FILE"
            echo "SLUG=$SLUG"
            echo "SUBREDDIT=$SUBREDDIT"
            echo "TITLE=$TITLE"
            echo "SUMMARY=$SUMMARY"
            echo "HERO=$HERO"
            echo "URL=$URL"
          } >> "$GITHUB_ENV"

          echo "Resolved:"
          echo "  FILE      = $FILE"
          echo "  SLUG      = $SLUG"
          echo "  SUBREDDIT = $SUBREDDIT"
          echo "  URL       = $URL"

      - name: Wait for page to be live (skipped if manual URL)
        if: ${{ !github.event.inputs.url_override }}
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..120}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${URL}")
            if [[ "$code" == "200" ]]; then
              echo "Page is live -> ${URL}"
              exit 0
            fi
            echo "Not live yet (HTTP $code). Sleeping 5s‚Ä¶ ($i/120)"
            sleep 5
          done
          echo "URL did not go live in time: ${URL}"
          exit 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i snoowrap

      - name: Post to Reddit
        env:
          REDDIT_CLIENT_ID:       ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_REFRESH_TOKEN:   ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_USER_AGENT:      ${{ secrets.REDDIT_USER_AGENT }}
          REDDIT_FLAIR_ID_SECRET: ${{ secrets.REDDIT_FLAIR_ID }}
          SUBREDDIT:              ${{ env.SUBREDDIT }}
          TITLE:                  ${{ env.TITLE }}
          SUMMARY:                ${{ env.SUMMARY }}
          URL:                    ${{ env.URL }}
          TITLE_OVERRIDE:         ${{ github.event.inputs.title_override }}
          FLAIR_ID_INPUT:         ${{ github.event.inputs.flair_id }}
          DRY_RUN:                ${{ github.event.inputs.dry_run }}
        run: |
          node <<'EOF'
          const Snoowrap = require('snoowrap');

          const clientId     = process.env.REDDIT_CLIENT_ID;
          const refreshToken = process.env.REDDIT_REFRESH_TOKEN;
          const userAgent    = process.env.REDDIT_USER_AGENT || 'azure-noob-blog-publisher';

          if (!clientId || !refreshToken) {
            console.log('‚ùå Reddit secrets missing (CLIENT_ID or REFRESH_TOKEN)');
            process.exit(1);
          }

          const title = (process.env.TITLE_OVERRIDE || process.env.TITLE || 'New post').slice(0, 299);
          const body = `${process.env.SUMMARY || ''}\n\nFull write-up: ${process.env.URL}`;
          const subreddit = (process.env.SUBREDDIT || 'AZURE').replace(/^r\//i,'');
          
          // Use input flair if provided, otherwise fall back to secret
          const flairId = process.env.FLAIR_ID_INPUT || process.env.REDDIT_FLAIR_ID_SECRET || '';

          if (process.env.DRY_RUN === 'true') {
            console.log('[DRY RUN] Would post to r/' + subreddit);
            console.log('Title:', title);
            console.log('Body:\n', body);
            console.log('Flair ID:', flairId || '(none)');
            process.exit(0);
          }

          // Installed-app OAuth: empty clientSecret + refreshToken
          const r = new Snoowrap({
            userAgent,
            clientId,
            clientSecret: '',
            refreshToken,
          });

          const postOptions = { title, text: body };
          if (flairId) {
            postOptions.flairId = flairId;
            console.log(`üìå Using flair ID: ${flairId}`);
          } else {
            console.log('‚ö†Ô∏è No flair ID provided - post may be rejected by r/AZURE');
          }

          r.getSubreddit(subreddit)
            .submitSelfpost(postOptions)
            .then(p => console.log('‚úÖ Reddit permalink: https://www.reddit.com' + p.permalink))
            .catch(err => { 
              console.error('‚ùå Reddit post failed:', err); 
              process.exit(1); 
            });
          EOF
