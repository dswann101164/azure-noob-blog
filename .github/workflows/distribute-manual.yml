name: "Distribute Blog Post (Manual: X + Reddit)"

on:
  workflow_dispatch:
    inputs:
      slug:
        description: "Post folder name under /posts (no .md). Example: 2025-01-15-kql-cheat-sheet-complete"
        required: true
        type: string
      post_to_x:
        description: "Also post to X (Twitter)?"
        required: true
        default: true
        type: boolean
      post_to_reddit:
        description: "Also post to Reddit?"
        required: true
        default: true
        type: boolean
      subreddit:
        description: "Subreddit (no r/)"
        required: true
        default: "AZURE"
        type: string
      dry_run:
        description: "Preview only (no posting)"
        required: true
        default: true
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect post metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          FILE="posts/${{ inputs.slug }}.md"
          if [ ! -f "$FILE" ]; then
            echo "âŒ Not found: $FILE"
            exit 1
          fi
          TITLE=$(awk -F': ' '/^title:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
          SUMMARY=$(awk -F': ' '/^summary:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
          URL="https://azure-noob.com/blog/${{ inputs.slug }}/"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Detected post: $FILE"
          echo "   Title: $TITLE"
          echo "   URL: $URL"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i twitter-api-v2 snoowrap

      - name: DRY RUN Preview
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "ğŸ” DRY RUN MODE - No actual posting will occur"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "URL:           ${{ steps.meta.outputs.url }}"
          echo "Title:         ${{ steps.meta.outputs.title }}"
          echo "Summary:       ${{ steps.meta.outputs.summary }}"
          echo "Subreddit:     r/${{ inputs.subreddit }}"
          echo "Post to X:     ${{ inputs.post_to_x }}"
          echo "Post to Reddit: ${{ inputs.post_to_reddit }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Post to X
        if: ${{ inputs.dry_run == false && inputs.post_to_x == true }}
        env:
          X_APP_KEY: ${{ secrets.X_APP_KEY }}
          X_APP_SECRET: ${{ secrets.X_APP_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          TITLE: ${{ steps.meta.outputs.title }}
          URL: ${{ steps.meta.outputs.url }}
        run: |
          node <<'EOF'
          const { TwitterApi } = require('twitter-api-v2');
          (async () => {
            const { X_APP_KEY, X_APP_SECRET, X_ACCESS_TOKEN, X_ACCESS_SECRET, TITLE, URL } = process.env;
            
            if (!X_APP_KEY || !X_APP_SECRET || !X_ACCESS_TOKEN || !X_ACCESS_SECRET) {
              console.log('âŒ X (Twitter) secrets missing - skipping tweet');
              return;
            }

            const client = new TwitterApi({
              appKey: X_APP_KEY,
              appSecret: X_APP_SECRET,
              accessToken: X_ACCESS_TOKEN,
              accessSecret: X_ACCESS_SECRET,
            });
            
            const text = `${TITLE}\n\n${URL}`.slice(0, 275);
            const res = await client.v2.tweet(text);
            console.log('âœ… Posted to X (Twitter). Tweet ID:', res?.data?.id);
          })().catch(e => { 
            console.error('âŒ X post failed:', e); 
            process.exit(1); 
          });
          EOF

      - name: Post to Reddit
        if: ${{ inputs.dry_run == false && inputs.post_to_reddit == true }}
        env:
          REDDIT_CLIENT_ID:     ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_USER_AGENT:    ${{ secrets.REDDIT_USER_AGENT }}
          TITLE:                ${{ steps.meta.outputs.title }}
          SUMMARY:              ${{ steps.meta.outputs.summary }}
          URL:                  ${{ steps.meta.outputs.url }}
          SUBREDDIT:            ${{ inputs.subreddit }}
        run: |
          node <<'EOF'
          const Snoowrap = require('snoowrap');
          (async () => {
            const clientId     = process.env.REDDIT_CLIENT_ID;
            const refreshToken = process.env.REDDIT_REFRESH_TOKEN;
            const userAgent    = process.env.REDDIT_USER_AGENT || 'azure-noob-blog-publisher';

            if (!clientId || !refreshToken) {
              console.log('âŒ Reddit secrets missing (CLIENT_ID or REFRESH_TOKEN) - skipping Reddit post');
              return;
            }

            // Installed-app OAuth: empty clientSecret + refreshToken
            const r = new Snoowrap({
              userAgent,
              clientId,
              clientSecret: '',
              refreshToken,
            });

            const title = (process.env.TITLE || '').slice(0, 299);
            const body = ((process.env.SUMMARY || '').trim() ? process.env.SUMMARY.trim() + '\n\n' : '') +
                         `Full write-up: ${process.env.URL || ''}`;
            const sub = (process.env.SUBREDDIT || 'AZURE').replace(/^r\//i,'');

            const post = await r.getSubreddit(sub).submitSelfpost({ title, text: body });
            console.log('âœ… Posted to Reddit: https://www.reddit.com' + (post?.permalink || ''));
          })().catch(e => { 
            console.error('âŒ Reddit post failed:', e); 
            process.exit(1); 
          });
          EOF
