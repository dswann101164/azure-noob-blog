name: Distribute Blog Post (Manual: X + Reddit)

on:
  workflow_dispatch:
    inputs:
      slug:
        description: "Post folder name under /posts (no .md). Example: 2025-01-15-kql-cheat-sheet-complete"
        required: true
        type: string
      post_to_x:
        description: "Also post to X (Twitter)?"
        required: true
        default: true
        type: boolean
      post_to_reddit:
        description: "Also post to Reddit?"
        required: true
        default: true
        type: boolean
      subreddit:
        description: "Subreddit (no r/)"
        required: true
        default: "AZURE"
        type: string
      dry_run:
        description: "Preview only (no posting)"
        required: true
        default: true
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect post metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          FILE="posts/${{ inputs.slug }}.md"
          TITLE=$(awk -F': ' '/^title:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
          SUMMARY=$(awk -F': ' '/^summary:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
          URL="https://azure-noob.com/blog/${{ inputs.slug }}/index.html"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i twitter-api-v2 snoowrap

      - name: DRY RUN Preview
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "URL: ${{ steps.meta.outputs.url }}"
          echo "Title: ${{ steps.meta.outputs.title }}"
          echo "Reddit: r/${{ inputs.subreddit }}"
          echo "Post to X: ${{ inputs.post_to_x }}"
          echo "Post to Reddit: ${{ inputs.post_to_reddit }}"

      - name: Post to X
        if: ${{ inputs.dry_run == false && inputs.post_to_x == true }}
        run: echo "Would post to X here"

      - name: Post to Reddit
        if: ${{ inputs.dry_run == false && inputs.post_to_reddit == true }}
        run: echo "Would post to Reddit here"
