      - name: Post to Reddit (r/AZURE or custom)
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          REDDIT_SUBREDDIT: ${{ secrets.REDDIT_SUBREDDIT }} # optional; defaults to AZURE
          TITLE: ${{ env.TITLE }}
          SUMMARY: ${{ env.SUMMARY }}
          URL: ${{ env.URL }}
        shell: bash
        run: |
          node <<'EOF'
          const Snoowrap = require('snoowrap');

          (async () => {
            const clientId = process.env.REDDIT_CLIENT_ID;
            const refreshToken = process.env.REDDIT_REFRESH_TOKEN;
            const userAgent = process.env.REDDIT_USER_AGENT || 'azure-noob-blog-publisher';

            if (!clientId || !refreshToken) {
              console.log('Reddit refresh-token secrets missing; skipping Reddit post.');
              return;
            }

            // Installed-app OAuth: empty clientSecret + refreshToken
            const r = new Snoowrap({
              userAgent,
              clientId,
              clientSecret: '',
              refreshToken
            });

            const title = (process.env.TITLE || 'New post').slice(0, 299);
            const text  = `${(process.env.SUMMARY || '').trim()}\n\nFull write-up: ${process.env.URL}`;
            const sub   = (process.env.REDDIT_SUBREDDIT || 'AZURE').replace(/^r\//i, '');

            const post = await r.getSubreddit(sub).submitSelfpost({ title, text });
            console.log('✅ Reddit permalink: https://www.reddit.com' + (post?.permalink || ''));
          })().catch(e => {
            console.error('❌ Reddit post failed:', e?.response?.json || e);
            process.exit(1);
          });
          EOF
