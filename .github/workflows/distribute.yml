name: Distribute Blog Post (X + Reddit)

on:
  workflow_dispatch:
    inputs:
      skip_wait:
        description: "Skip waiting for the page to be live"
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - "posts/*.md"

# Don't auto-cancel older runs when new commits arrive
concurrency:
  group: distribute-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect post (works for push or manual)
        shell: bash
        run: |
          set -euo pipefail

          # Prefer a post changed in the last commit; fall back to newest post
          FILE="$(git log -1 --pretty=format: --name-only -- posts/*.md | grep -E '^posts/.*\.md$' | head -n 1 || true)"
          if [[ -z "${FILE:-}" ]]; then
            FILE="$(ls -t posts/*.md | head -n 1 || true)"
          fi
          if [[ -z "${FILE:-}" ]]; then
            echo "No post found under posts/"; exit 1
          fi

          # Pull YAML front-matter fields
          TITLE="$(awk -F': ' '/^title:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')"
          SUMMARY="$(awk -F': ' '/^summary:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')"
          HERO="$(awk -F': ' '/^cover:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')"

          # Build URL from slug (post filename)
          SLUG="$(basename "$FILE" .md)"
          URL="https://azure-noob.com/blog/${SLUG}/index.html"

          {
            echo "FILE=$FILE"
            echo "TITLE=$TITLE"
            echo "SUMMARY=$SUMMARY"
            echo "HERO=$HERO"
            echo "SLUG=$SLUG"
            echo "URL=$URL"
          } >> "$GITHUB_ENV"

          echo "Detected:"
          echo "  FILE  = $FILE"
          echo "  TITLE = $TITLE"
          echo "  URL   = $URL"
          echo "  HERO  = $HERO"

      - name: Wait for page to be live (max ~10 min)
        if: ${{ github.event.inputs.skip_wait != 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          try_url () {
            local u="$1"
            local code
            code="$(curl -sS -o /dev/null -w '%{http_code}' -L -I "$u" || echo 000)"
            echo "Checked $u -> HTTP $code"
            [[ "$code" = "200" ]]
          }

          INDEX_URL="${URL%/}/index.html"
          SLASH_URL="${URL%/}/"

          echo "Waiting for page to be live:"
          echo "  $INDEX_URL"
          echo "  $SLASH_URL"

          for i in {1..120}; do   # 120 * 5s = ~10 minutes
            if try_url "$INDEX_URL" || try_url "$SLASH_URL"; then
              echo "Page is live."
              exit 0
            fi
            echo "Not live yet. Sleeping 5sâ€¦ ($i/120)"
            sleep 5
          done

          echo "Page never went live in time."; exit 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm i --no-fund --no-audit twitter-api-v2 snoowrap

      - name: Post to X (Twitter)
        env:
          X_APP_KEY: ${{ secrets.X_APP_KEY }}
          X_APP_SECRET: ${{ secrets.X_APP_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          TITLE: ${{ env.TITLE }}
          URL: ${{ env.URL }}
        shell: bash
        run: |
          node <<'EOF'
          const { TwitterApi } = require('twitter-api-v2');

          (async () => {
            const appKey     = process.env.X_APP_KEY;
            const appSecret  = process.env.X_APP_SECRET;
            const accessToken  = process.env.X_ACCESS_TOKEN;
            const accessSecret = process.env.X_ACCESS_SECRET;

            if (!appKey || !appSecret || !accessToken || !accessSecret) {
              console.log('X secrets missing; skipping tweet.');
              return;
            }

            const client = new TwitterApi({
              appKey, appSecret, accessToken, accessSecret,
            });

            const title = (process.env.TITLE || '').trim();
            const url   = (process.env.URL || '').trim();
            const text  = `${title}\n\n${url}`.slice(0, 275); // leave a little headroom

            const res = await client.v2.tweet(text);
            console.log('Tweeted:', res?.data?.id || '(no id)');
          })().catch(err => { console.error(err); process.exit(1); });
          EOF

      - name: Post to Reddit (r/AZURE or custom)
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          REDDIT_SUBREDDIT: ${{ secrets.REDDIT_SUBREDDIT }} # optional; falls back to 'azure'
          TITLE: ${{ env.TITLE }}
          SUMMARY: ${{ env.SUMMARY }}
          URL: ${{ env.URL }}
        shell: bash
        run: |
          node <<'EOF'
          const Snoowrap = require('snoowrap');

          (async () => {
            const hasCore =
              process.env.REDDIT_CLIENT_ID &&
              process.env.REDDIT_CLIENT_SECRET &&
              process.env.REDDIT_USERNAME &&
              process.env.REDDIT_PASSWORD;

            if (!hasCore) {
              console.log('Reddit secrets missing; skipping Reddit post.');
              return;
            }

            const subreddit = (process.env.REDDIT_SUBREDDIT || 'azure').trim();

            const r = new Snoowrap({
              userAgent: 'azure-noob-blog-publisher',
              clientId: process.env.REDDIT_CLIENT_ID,
              clientSecret: process.env.REDDIT_CLIENT_SECRET,
              username: process.env.REDDIT_USERNAME,
              password: process.env.REDDIT_PASSWORD,
            });

            const title = (process.env.TITLE || '').slice(0, 299) || 'New post';
            const summary = (process.env.SUMMARY || '').trim();
            const url = (process.env.URL || '').trim();

            const body = (summary ? summary + '\n\n' : '') + `Full write-up: ${url}`;

            const post = await r.getSubreddit(subreddit).submitSelfpost({
              title,
              text: body,
            });

            console.log('Reddit permalink: https://www.reddit.com' + (post?.permalink || ''));
          })().catch(err => { console.error(err); process.exit(1); });
          EOF
