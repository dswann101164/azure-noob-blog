name: Distribute Blog Post (X only)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "posts/*.md"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Detect new post (robust parsing)
      run: |
        set -e
        FILE=$(git diff --name-only HEAD~1 HEAD | grep '^posts/.*\.md$' | head -n 1)
        if [ -z "$FILE" ]; then
          echo "No post change under posts/. Exiting."
          exit 1
        fi
        echo "FILE=$FILE" >> $GITHUB_ENV

        TITLE=$(awk -F': ' '/^title:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
        SUMMARY=$(awk -F': ' '/^summary:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')
        HERO=$(awk -F': ' '/^cover:/{print $2; exit}' "$FILE" | tr -d '"' | tr -d '\r')

        SLUG=$(basename "$FILE" .md)
        URL="https://azure-noob.com/blog/${SLUG}/index.html"

        echo "TITLE=$TITLE" >> $GITHUB_ENV
        echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV
        echo "HERO=$HERO" >> $GITHUB_ENV
        echo "URL=$URL" >> $GITHUB_ENV

    - name: Wait for page to be live (max ~3 min)
      run: |
        for i in {1..18}; do
          code=$(curl -s -o /dev/null -w "%{http_code}" "${URL}")
          if [ "$code" = "200" ]; then
            echo "Page is live."; exit 0
          fi
          echo "Not live yet (HTTP $code). Sleeping 10s..."
          sleep 10
        done
        echo "Page never went live in time." && exit 1

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install deps
      run: npm i twitter-api-v2

    - name: Post to X (calm tone)
      env:
        X_APP_KEY: ${{ secrets.X_APP_KEY }}
        X_APP_SECRET: ${{ secrets.X_APP_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        TITLE: ${{ env.TITLE }}
        URL: ${{ env.URL }}
      run: |
        node - << 'EOF'
        import { TwitterApi } from 'twitter-api-v2';
        const client = new TwitterApi({
          appKey: process.env.X_APP_KEY,
          appSecret: process.env.X_APP_SECRET,
          accessToken: process.env.X_ACCESS_TOKEN,
          accessSecret: process.env.X_ACCESS_SECRET,
        });
        const text = `${process.env.TITLE}\n\n${process.env.URL}`;
        await client.v2.tweet(text);
        console.log("âœ… Posted to X.");
        EOF
