{% extends "base.html" %}
{% block content %}
<h1>Search</h1>
<p class="summary">Type to search titles, summaries, and tags.</p>

<input id="q" type="search" placeholder="Search posts..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px">
<div id="hits" style="margin-top:16px;"></div>

<script src="https://unpkg.com/lunr/lunr.js"></script>
<script>
(async function(){
  const input = document.getElementById('q');
  const hitsEl = document.getElementById('hits');

  const res = await fetch('{{ url_for("search_json") }}', {cache: 'no-store'});
  const docs = await res.json();

  const idx = lunr(function(){
    this.ref('slug');
    this.field('title', { boost: 10 });
    this.field('summary');
    this.field('tags');
    docs.forEach(d => this.add({
      slug: d.slug,
      title: d.title || '',
      summary: d.summary || '',
      tags: (d.tags || []).join(' ')
    }), this);
  });

  function render(results){
    if(!results.length){ hitsEl.innerHTML = '<p class="muted">No results.</p>'; return; }
    hitsEl.innerHTML = '<ul class="post-list">' + results.map(r => {
      const d = docs.find(x => x.slug === r.ref);
      const date = d.date || '';
      const tags = (d.tags || []).map(t => `#${t}`).join(' ');
      return `<li>
        <a href="/blog/${d.slug}/">${d.title}</a>
        <span class="muted">Â· ${date}</span>
        ${d.summary ? `<p class="summary">${d.summary}</p>` : ''}
        ${tags ? `<p class="muted">${tags}</p>` : ''}
      </li>`;
    }).join('') + '</ul>';
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if(!q){ hitsEl.innerHTML = ''; return; }
    try { render(idx.search(q)); } catch(e){ hitsEl.innerHTML = '<p class="muted">Invalid query.</p>'; }
  });
})();
</script>
{% endblock %}
